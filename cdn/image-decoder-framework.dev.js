!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.resourceScheduler=e()}}(function(){return function e(t,r,o){function i(s,u){if(!r[s]){if(!t[s]){var d="function"==typeof require&&require;if(!u&&d)return d(s,!0);if(n)return n(s,!0);var h=new Error("Cannot find module '"+s+"'");throw h.code="MODULE_NOT_FOUND",h}var l=r[s]={exports:{}};t[s][0].call(l.exports,function(e){var r=t[s][1][e];return i(r?r:e)},l,l.exports,e,t,r,o)}return r[s].exports}for(var n="function"==typeof require&&require,s=0;s<o.length;s++)i(o[s]);return i}({1:[function(e,t,r){"use strict";var o=function(){function e(e,t){this._resourceCreator=e,this._jobsLimit=t,this._freeResourcesCount=this._jobsLimit,this._freeResources=new Array(this._jobsLimit),this._pendingJobs=[]}function t(e,t){this._scheduler=e,this._resource=t}return e.prototype.enqueueJob=function(e,t){if(this._freeResourcesCount>0){--this._freeResourcesCount;var r=this._freeResources.pop();void 0===r&&(r=this._resourceCreator()),this._schedule(e,r,t)}else this._pendingJobs.push({jobFunc:e,jobContext:t})},e.prototype._schedule=function(e,r,o){var i=new t(this,r);e(r,o,i)},t.prototype.jobDone=function(){if(this._scheduler._pendingJobs.length>0){var e=this._scheduler._pendingJobs.pop();this._scheduler._schedule(e.jobFunc,this._resource,e.jobContext)}else this._scheduler._freeResources.push(this._resource),++this._scheduler._freeResourcesCount},t.prototype.shouldYieldOrAbort=function(){return!1},t.prototype.tryYield=function(){return!1},e}();t.exports=o},{}],2:[function(e,t,r){"use strict";var o=function(){function e(){this.clear()}return e.prototype.clear=function(){this._first={_prev:null,_parent:this},this._last={_next:null,_parent:this},this._count=0,this._last._prev=this._first,this._first._next=this._last},e.prototype.add=function(e,t){null!==t&&void 0!==t||(t=this._last),this._validateIteratorOfThis(t),++this._count;var r={_value:e,_next:t,_prev:t._prev,_parent:this};return r._prev._next=r,t._prev=r,r},e.prototype.remove=function(e){this._validateIteratorOfThis(e),--this._count,e._prev._next=e._next,e._next._prev=e._prev,e._parent=null},e.prototype.getFromIterator=function(e){return this._validateIteratorOfThis(e),e._value},e.prototype.getFirstIterator=function(){var e=this.getNextIterator(this._first);return e},e.prototype.getLastIterator=function(){var e=this.getPrevIterator(this._last);return e},e.prototype.getNextIterator=function(e){return this._validateIteratorOfThis(e),e._next===this._last?null:e._next},e.prototype.getPrevIterator=function(e){return this._validateIteratorOfThis(e),e._prev===this._first?null:e._prev},e.prototype.getCount=function(){return this._count},e.prototype._validateIteratorOfThis=function(e){if(e._parent!==this)throw"iterator must be of the current LinkedList"},e}();t.exports=o},{}],3:[function(e,t,r){"use strict";var o=e("linked-list"),i=function(){function e(e,t,r,i){i=i||{},this._resourceCreator=e,this._jobsLimit=t,this._prioritizer=r,this._showLog=i.showLog,this._schedulerName=i.schedulerName,this._numNewJobs=i.numNewJobs||20,this._numJobsBeforeRerankOldPriorities=i.numJobsBeforeRerankOldPriorities||20,this._freeResourcesCount=this._jobsLimit,this._freeResources=new Array(this._jobsLimit),this._resourcesGuaranteedForHighPriority=i.resourcesGuaranteedForHighPriority||0,this._highPriorityToGuaranteeResource=i.highPriorityToGuaranteeResource||0,this._logCallIndentPrefix=">",this._pendingJobsCount=0,this._oldPendingJobsByPriority=[],this._newPendingJobsLinkedList=new o,this._schedulesCounter=0}function t(e,t,r){if(e._showLog){var o=e._prioritizer.getPriority(r);y(e,"jobDone() start: job done of priority "+o,1)}_(e,t),g(e),y(e,"jobDone() end",-1)}function r(e,t){y(e,"shouldYieldOrAbort() start",1);var r=e._prioritizer.getPriority(t),o=r<0||n(e,r);return y(e,"shouldYieldOrAbort() end",-1),o}function i(e,t,r,o,i,n){y(e,"tryYield() start",1);var u=e._prioritizer.getPriority(r);if(u<0)return o(r),_(e,n),y(e,"tryYield() end: job aborted",-1),!0;var h=s(e,u);if(g(e),null===h)return y(e,"tryYield() end: job continues",-1),!1;i(r);var l={jobFunc:t,jobAbortedFunc:o,jobContext:r};return d(e,l,u),g(e),a(e,h,n),g(e),y(e,"tryYield() end: job yielded",-1),!0}function n(e,t){var r=e._newPendingJobsLinkedList.getFirstIterator();for(y(e,"hasNewJobWithHigherPriority() start",1);null!==r;){var o=e._newPendingJobsLinkedList.getNextIterator(r),i=e._newPendingJobsLinkedList.getFromIterator(r),n=e._prioritizer.getPriority(i.jobContext);if(n<0)f(e,r),--e._pendingJobsCount,i.jobAbortedFunc(i.jobContext),r=o;else{if(n>t)return y(e,"hasNewJobWithHigherPriority() end: returns true",-1),!0;r=o}}return y(e,"hasNewJobWithHigherPriority() end: returns false",-1),!1}function s(e,t){y(e,"tryDequeueNewJobWithHigherPriority() start",1);for(var r=null,o=t,i=[],n=e._newPendingJobsLinkedList.getFirstIterator();null!==n;){var s=e._newPendingJobsLinkedList.getNextIterator(n),u=e._newPendingJobsLinkedList.getFromIterator(n),d=e._prioritizer.getPriority(u.jobContext);d<0?(f(e,n),--e._pendingJobsCount,u.jobAbortedFunc(u.jobContext),n=s):((void 0===o||d>o)&&(o=d,r=n),e._showLog?(void 0===i[d]?i[d]=1:++i[d],n=s):n=s)}var h=null;if(null!==r&&(h=f(e,r),--e._pendingJobsCount),e._showLog){for(var l="tryDequeueNewJobWithHigherPriority(): Jobs list:",_=0;_<i.length;++_)void 0!==i[_]&&(l+=i[_]+" jobs of priority "+_+";");y(e,l),null!==h&&y(e,"tryDequeueNewJobWithHigherPriority(): dequeued new job of priority "+o)}return g(e),y(e,"tryDequeueNewJobWithHigherPriority() end",-1),h}function u(e){if(y(e,"tryGetFreeResource() start",1),0===e._freeResourcesCount)return null;--e._freeResourcesCount;var t=e._freeResources.pop();return void 0===t&&(t=e._resourceCreator()),g(e),y(e,"tryGetFreeResource() end",-1),t}function d(e,t,r){y(e,"enqueueNewJob() start",1),++e._pendingJobsCount;var o=e._newPendingJobsLinkedList.getFirstIterator();if(c(e,t,o),e._showLog&&y(e,"enqueueNewJob(): enqueued job of priority "+r),e._newPendingJobsLinkedList.getCount()<=e._numNewJobs)return g(e),void y(e,"enqueueNewJob() end: _newPendingJobsLinkedList is small enough",-1);var i=e._newPendingJobsLinkedList.getLastIterator(),n=f(e,i);h(e,n),g(e),y(e,"enqueueNewJob() end: One job moved from new job list to old job list",-1)}function h(e,t){y(e,"enqueueOldJob() start",1);var r=e._prioritizer.getPriority(t.jobContext);return r<0?(--e._pendingJobsCount,t.jobAbortedFunc(t.jobContext),void y(e,"enqueueOldJob() end: job aborted",-1)):(void 0===e._oldPendingJobsByPriority[r]&&(e._oldPendingJobsByPriority[r]=[]),e._oldPendingJobsByPriority[r].push(t),void y(e,"enqueueOldJob() end: job enqueued to old job list",-1))}function l(e){y(e,"rerankPriorities() start",1);var t=e._oldPendingJobsByPriority,r=e._newPendingJobsLinkedList;if(0===t.length)return void y(e,"rerankPriorities() end: no need to rerank",-1);e._oldPendingJobsByPriority=[],e._newPendingJobsLinkedList=new o;for(var i=0;i<t.length;++i)if(void 0!==t[i])for(var n=0;n<t[i].length;++n)h(e,t[i][n]);for(var s=r.getFirstIterator();null!==s;){var u=r.getFromIterator(s);h(e,u),s=r.getNextIterator(s)}for(var d="rerankPriorities(): ",l=e._oldPendingJobsByPriority.length-1;l>=0;--l){var _=e._oldPendingJobsByPriority[l];if(void 0!==_){for(e._showLog&&(d+=_.length+" jobs in priority "+l+";");_.length>0&&e._newPendingJobsLinkedList.getCount()<e._numNewJobs;){var a=_.pop();c(e,a)}if(e._newPendingJobsLinkedList.getCount()>=e._numNewJobs&&!e._showLog)break}}e._showLog&&y(e,d),g(e),y(e,"rerankPriorities() end: rerank done",-1)}function _(e,t){y(e,"resourceFreed() start",1),++e._freeResourcesCount;var r=p(e);--e._freeResourcesCount;var o=s(e,r);if(null!==o)return g(e),a(e,o,t),g(e),void y(e,"resourceFreed() end: new job scheduled",-1);var i=e._pendingJobsCount>e._newPendingJobsLinkedList.getCount();if(!i)return e._freeResources.push(t),++e._freeResourcesCount,g(e),void y(e,"resourceFreed() end: no job to schedule",-1);for(var n,u=e._oldPendingJobsByPriority.length,d=u-1;d>=0;--d){var h=e._oldPendingJobsByPriority[d];if(void 0!==h&&0!==h.length){for(var l=h.length-1;l>=0;--l){if(o=h[l],n=e._prioritizer.getPriority(o.jobContext),n>=d){h.length=l;break}n<0?(--e._pendingJobsCount,o.jobAbortedFunc(o.jobContext)):(void 0===e._oldPendingJobsByPriority[n]&&(e._oldPendingJobsByPriority[n]=[]),e._oldPendingJobsByPriority[n].push(o)),o=null}if(null!==o)break;h.length=0}}return null===o?(e._freeResources.push(t),++e._freeResourcesCount,g(e),void y(e,"resourceFreed() end: no non-aborted job to schedule",-1)):(e._showLog&&y(e,"resourceFreed(): dequeued old job of priority "+n),--e._pendingJobsCount,g(e),a(e,o,t),g(e),void y(e,"resourceFreed() end: job scheduled",-1))}function a(e,t,r){if(y(e,"schedule() start",1),++e._schedulesCounter,e._schedulesCounter>=e._numJobsBeforeRerankOldPriorities&&(e._schedulesCounter=0,l(e)),e._showLog){var o=e._prioritizer.getPriority(t.jobContext);y(e,"schedule(): scheduled job of priority "+o)}var i=new v(e,r,t.jobContext);t.jobFunc(r,t.jobContext,i),y(e,"schedule() end",-1)}function c(e,t,r){y(e,"addJobToLinkedList() start",1),e._newPendingJobsLinkedList.add(t,r),b(e),y(e,"addJobToLinkedList() end",-1)}function f(e,t){y(e,"extractJobFromLinkedList() start",1);var r=e._newPendingJobsLinkedList.getFromIterator(t);return e._newPendingJobsLinkedList.remove(t),b(e),y(e,"extractJobFromLinkedList() end",-1),r}function b(e){if(e._showLog){y(e,"ensureNumberOfNodes() start",1);for(var t=e._newPendingJobsLinkedList.getFirstIterator(),r=0;null!==t;)++r,t=e._newPendingJobsLinkedList.getNextIterator(t);if(r!==e._newPendingJobsLinkedList.getCount())throw"Unexpected count of new jobs";y(e,"ensureNumberOfNodes() end",-1)}}function g(e){if(e._showLog){y(e,"ensurePendingJobsCount() start",1);for(var t=0,r=0;r<e._oldPendingJobsByPriority.length;++r){var o=e._oldPendingJobsByPriority[r];void 0!==o&&(t+=o.length)}var i=t+e._newPendingJobsLinkedList.getCount();if(i!==e._pendingJobsCount)throw"Unexpected count of jobs";y(e,"ensurePendingJobsCount() end",-1)}}function p(e){return y(e,"getMinimalPriorityToSchedule() start",1),e._freeResourcesCount<=e._resourcesGuaranteedForHighPriority?(y(e,"getMinimalPriorityToSchedule() end: guarantee resource for high priority is needed",-1),e._highPriorityToGuaranteeResources):(y(e,"getMinimalPriorityToSchedule() end: enough resources, no need to guarantee resource for high priority",-1),0)}function y(e,t,r){e._showLog&&(r===-1&&(e._logCallIndentPrefix=e._logCallIndentPrefix.substr(1)),void 0!==e._schedulerName?console.log(e._logCallIndentPrefix+"PriorityScheduler "+e._schedulerName+": "+t):console.log(e._logCallIndentPrefix+"PriorityScheduler: "+t),1===r&&(e._logCallIndentPrefix+=">"))}function v(e,t,r){this._isValid=!0,this._scheduler=e,this._resource=t,this._context=r}return e.prototype.enqueueJob=function(e,t,r){y(this,"enqueueJob() start",1);var o=this._prioritizer.getPriority(t);if(o<0)return r(t),void y(this,"enqueueJob() end: job aborted",-1);var i={jobFunc:e,jobAbortedFunc:r,jobContext:t},n=p(this),s=null;return o>=n&&(s=u(this)),null!==s?(a(this,i,s),void y(this,"enqueueJob() end: job scheduled",-1)):(d(this,i,o),g(this),void y(this,"enqueueJob() end: job pending",-1))},v.prototype._checkValidity=function(){if(!this._isValid)throw"ResourceScheduler error: Already terminated job"},v.prototype._clearValidity=function(){this._isValid=!1,this._resource=null,this._context=null,this._scheduler=null},v.prototype.jobDone=function(){this._checkValidity(),t(this._scheduler,this._resource,this._context),this._clearValidity()},v.prototype.shouldYieldOrAbort=function(){return this._checkValidity(),r(this._scheduler,this._context)},v.prototype.tryYield=function(e,t,r){this._checkValidity();var o=i(this._scheduler,e,this._context,t,r,this._resource);return o&&this._clearValidity(),o},e}();t.exports=i},{"linked-list":2}],4:[function(e,t,r){"use strict";t.exports.PriorityScheduler=e("priority-scheduler"),t.exports.LifoScheduler=e("lifo-scheduler")},{"lifo-scheduler":1,"priority-scheduler":3}]},{},[4])(4)});
!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.imageDecoderFramework=e()}}(function(){return function e(t,i,r){function a(n,o){if(!i[n]){if(!t[n]){var h="function"==typeof require&&require;if(!o&&h)return h(n,!0);if(s)return s(n,!0);var l=new Error("Cannot find module '"+n+"'");throw l.code="MODULE_NOT_FOUND",l}var c=i[n]={exports:{}};t[n][0].call(c.exports,function(e){var i=t[n][1][e];return a(i?i:e)},c,c.exports,e,t,i,r)}return i[n].exports}for(var s="function"==typeof require&&require,n=0;n<r.length;n++)a(r[n]);return a}({1:[function(e,t,i){"use strict";function r(e){var t={x:e.scene.canvas.width,y:e.scene.canvas.height},i=[];a(0,0,t.x,t.y,i,e,0);var r=Cesium.Rectangle.fromCartographicArray(i);(r.east<r.west||r.north<r.south)&&(r={east:Math.max(r.east,r.west),west:Math.min(r.east,r.west),north:Math.max(r.north,r.south),south:Math.min(r.north,r.south)});var s=n.calculateFrustum2DFromBounds(r,t);return s}function a(e,t,i,r,n,h,l){var c=0;c+=s(e,t,h,n),c+=s(i,t,h,n),c+=s(e,r,h,n),c+=s(i,r,h,n);var d=o;if(!(4===c||l>=d)){++l;var u=(e+i)/2,m=(t+r)/2;a(e,t,u,m,n,h,l),a(e,m,u,r,n,h,l),a(u,t,i,m,n,h,l),a(u,m,i,r,n,h,l)}}function s(e,t,i,r){var a=new Cesium.Cartesian2(e,t),s=i.scene.mapProjection.ellipsoid,n=i.scene.camera.pickEllipsoid(a,s);if(void 0===n)return 0;var o=s.cartesianToCartographic(n);return void 0===o?0:(r.push(o),1)}t.exports=r;var n=e("imagehelperfunctions.js"),o=4},{"imagehelperfunctions.js":12}],2:[function(e,t,i){"use strict";function r(e,t){this._options=t||{},void 0!==this._options.rectangle&&(this._options=JSON.parse(JSON.stringify(t)),this._options.cartographicBounds={west:t.rectangle.west,east:t.rectangle.east,south:t.rectangle.south,north:t.rectangle.north}),this._options.minFunctionCallIntervalMilliseconds=t.minFunctionCallIntervalMilliseconds||100,this._url=t.url,this._targetCanvas=document.createElement("canvas"),this._imageryProviders=[new a(this._targetCanvas),new a(this._targetCanvas)],this._imageryLayerShown=new Cesium.ImageryLayer(this._imageryProviders[0]),this._imageryLayerPending=new Cesium.ImageryLayer(this._imageryProviders[1]),this._canvasUpdatedCallbackBound=this._canvasUpdatedCallback.bind(this),this._isPendingUpdateCallback=!1,this._isWhileReplaceLayerShown=!1,this._pendingPositionRectangle=null,this._viewerImageDecoder=new s(e,this._canvasUpdatedCallbackBound,this._options),this._viewerImageDecoder.setTargetCanvas(this._targetCanvas),this._updateFrustumBound=this._updateFrustum.bind(this),this._postRenderBound=this._postRender.bind(this)}t.exports=r;var a=e("canvasimageryprovider.js"),s=e("viewerimagedecoder.js"),n=e("_cesiumfrustumcalculator.js");r.prototype.setExceptionCallback=function(e){this._viewerImageDecoder.setExceptionCallback(e)},r.prototype.open=function(e){this._widget=e,this._layers=e.scene.imageryLayers,e.scene.postRender.addEventListener(this._postRenderBound),this._viewerImageDecoder.open(this._url),this._layers.add(this._imageryLayerShown),this._intervalHandle=setInterval(this._updateFrustumBound,500)},r.prototype.close=function(){this._viewerImageDecoder.close(),clearInterval(this._intervalHandle),this._layers.remove(this._imageryLayerShown),this._widget.removeEventListener(this._postRenderBound),this._isWhileReplaceLayerShown&&(this._isWhileReplaceLayerShown=!1,this._isPendingUpdateCallback=!1,this._layers.remove(this._imageryLayerPending))},r.prototype.getImageryLayers=function(){return[this._imageryLayerShown,this._imageryLayerPending]},r.prototype._updateFrustum=function(){var e=n(this._widget);null!==e&&this._viewerImageDecoder.updateViewArea(e)},r.prototype._canvasUpdatedCallback=function(e){if(this._isWhileReplaceLayerShown&&(this._isPendingUpdateCallback=!0,this._pendingPositionRectangle=e),null!==e){var t=new Cesium.Rectangle(e.west,e.south,e.east,e.north);this._imageryProviders[0].setRectangle(t),this._imageryProviders[1].setRectangle(t)}this._removeAndReAddLayer()},r.prototype._removeAndReAddLayer=function(){var e=this._layers.indexOf(this._imageryLayerShown);if(0>e)throw"Layer was removed from viewer's layers  without closing layer manager. Use CesiumImageDecoderLayerManager.close() instead";this._isWhileReplaceLayerShown=!0,this._layers.add(this._imageryLayerPending,e)},r.prototype._postRender=function(){if(this._isWhileReplaceLayerShown){this._isWhileReplaceLayerShown=!1,this._layers.remove(this._imageryLayerShown,!1);var e=this._imageryLayerShown;this._imageryLayerShown=this._imageryLayerPending,this._imageryLayerPending=e,this._isPendingUpdateCallback&&(this._isPendingUpdateCallback=!1,this._canvasUpdatedCallback(this._pendingPositionRectangle))}}},{"_cesiumfrustumcalculator.js":1,"canvasimageryprovider.js":3,"viewerimagedecoder.js":19}],3:[function(e,t,i){"use strict";function r(e,t){if(void 0===t&&(t={}),void 0===e)throw new DeveloperError("canvas is required.");this._canvas=e,this._errorEvent=new Event("CanvasImageryProviderStatus"),this._ready=!1;var i=t.credit;"string"==typeof i&&(i=new Credit(i)),this._credit=i}t.exports=r,r.prototype={get tileWidth(){if(!this._ready)throw new DeveloperError("tileWidth must not be called before the imagery provider is ready.");return this._canvas.width},get tileHeight(){if(!this._ready)throw new DeveloperError("tileHeight must not be called before the imagery provider is ready.");return this._canvas.height},get maximumLevel(){if(!this._ready)throw new DeveloperError("maximumLevel must not be called before the imagery provider is ready.");return 0},get minimumLevel(){if(!this._ready)throw new DeveloperError("minimumLevel must not be called before the imagery provider is ready.");return 0},get tilingScheme(){if(!this._ready)throw new DeveloperError("tilingScheme must not be called before the imagery provider is ready.");return this._tilingScheme},get rectangle(){return this._tilingScheme.rectangle},get tileDiscardPolicy(){if(!this._ready)throw new DeveloperError("tileDiscardPolicy must not be called before the imagery provider is ready.")},get errorEvent(){return this._errorEvent},get ready(){return this._ready},get credit(){return this._credit},get hasAlphaChannel(){return!0}},r.prototype.setRectangle=function(e){this._tilingScheme=new Cesium.GeographicTilingScheme({rectangle:e,numberOfLevelZeroTilesX:1,numberOfLevelZeroTilesY:1}),this._ready||(this._ready=!0,Cesium.TileProviderError.handleSuccess(this._errorEvent))},r.prototype.getTileWidth=function(){return this.tileWidth},r.prototype.getTileHeight=function(){return this.tileHeight},r.prototype.getMaximumLevel=function(){return this.maximumLevel},r.prototype.getMinimumLevel=function(){return this.minimumLevel},r.prototype.isReady=function(){return this.ready},r.prototype.getCredit=function(){return this.credit},r.prototype.getRectangle=function(){return this.tilingScheme.rectangle},r.prototype.getTilingScheme=function(){return this.tilingScheme},r.prototype.getTileDiscardPolicy=function(){return this.tileDiscardPolicy},r.prototype.getErrorEvent=function(){return this.errorEvent},r.prototype.getHasAlphaChannel=function(){return this.hasAlphaChannel},r.prototype.getTileCredits=function(e,t,i){},r.prototype.requestImage=function(e,t,i){if(!this._ready)throw new DeveloperError("requestImage must not be called before the imagery provider is ready.");return this._canvas},r.prototype.pickFeatures=function(){}},{}],4:[function(e,t,i){"use strict";function r(e,t){var i=t.url;if(this._adaptProportions=t.adaptProportions,this._rectangle=t.rectangle,this._proxy=t.proxy,this._updateFrustumInterval=1e3,this._credit=t.credit,"string"==typeof this._credit&&(this._credit=new Credit(this._credit)),void 0===this._rectangle&&(this._rectangle=Cesium.Rectangle.fromDegrees(-180,-90,180,90)),void 0===this._adaptProportions&&(this._adaptProportions=!0),t=JSON.parse(JSON.stringify(t||{})),t.cartographicBounds={west:this._rectangle.west,east:this._rectangle.east,south:this._rectangle.south,north:this._rectangle.north},void 0===i)throw new DeveloperError("url is required.");this._url=i,this._tilingScheme=void 0,this._tileWidth=0,this._tileHeight=0,this._errorEvent=new Event("ImageDecoderImageryProviderStatus"),this._ready=!1,this._exceptionCallback=null,this._cesiumWidget=null,this._updateFrustumIntervalHandle=null;var r=i;void 0!==this._proxy&&(r=this._proxy.getURL(r)),this._decoder=e,this._image=e.getImage(),this._url=r}function a(e){var t=new Cesium.Rectangle(e.west,e.south,e.east,e.north),i=new Cesium.GeographicTilingScheme({rectangle:t,numberOfLevelZeroTilesX:e.levelZeroTilesX,numberOfLevelZeroTilesY:e.levelZeroTilesY});return i}t.exports=r;var s=(e("workerproxyimagedecoder.js"),e("_cesiumfrustumcalculator.js")),n=e("imagehelperfunctions.js");r.prototype={get url(){return this._url},get proxy(){return this._proxy},get tileWidth(){if(!this._ready)throw new DeveloperError("tileWidth must not be called before the imagery provider is ready.");return this._tileWidth},get tileHeight(){if(!this._ready)throw new DeveloperError("tileHeight must not be called before the imagery provider is ready.");return this._tileHeight},get maximumLevel(){if(!this._ready)throw new DeveloperError("maximumLevel must not be called before the imagery provider is ready.");return this._numResolutionLevels-1},get minimumLevel(){if(!this._ready)throw new DeveloperError("minimumLevel must not be called before the imagery provider is ready.");return 0},get tilingScheme(){if(!this._ready)throw new DeveloperError("tilingScheme must not be called before the imagery provider is ready.");return this._tilingScheme},get rectangle(){return this._tilingScheme.rectangle},get tileDiscardPolicy(){if(!this._ready)throw new DeveloperError("tileDiscardPolicy must not be called before the imagery provider is ready.")},get errorEvent(){return this._errorEvent},get ready(){return this._ready},get credit(){return this._credit},get hasAlphaChannel(){return!0}},r.prototype.setExceptionCallback=function(e){this._exceptionCallback=e},r.prototype.open=function(e){if(null!==this._updateFrustumIntervalHandle)throw new DeveloperError("Cannot set two parent viewers.");if(void 0===e)throw new DeveloperError("widgetOrViewer should be given. It is needed for frustum calculation for the priority mechanism");this._decoder.open(this._url).then(this._opened.bind(this))["catch"](this._onException.bind(this)),this._cesiumWidget=e,this._updateFrustumIntervalHandle=setInterval(this._setPriorityByFrustum.bind(this),this._updateFrustumInterval)},r.prototype.close=function(){clearInterval(this._updateFrustumIntervalHandle),this._decoder.close()},r.prototype.getTileWidth=function(){return this.tileWidth},r.prototype.getTileHeight=function(){return this.tileHeight},r.prototype.getMaximumLevel=function(){return this.maximumLevel},r.prototype.getMinimumLevel=function(){return this.minimumLevel},r.prototype.getUrl=function(){return this.url},r.prototype.getProxy=function(){return this.proxy},r.prototype.isReady=function(){return this.ready},r.prototype.getCredit=function(){return this.credit},r.prototype.getRectangle=function(){return this.tilingScheme.rectangle},r.prototype.getTilingScheme=function(){return this.tilingScheme},r.prototype.getTileDiscardPolicy=function(){return this.tileDiscardPolicy},r.prototype.getErrorEvent=function(){return this.errorEvent},r.prototype.getHasAlphaChannel=function(){return this.hasAlphaChannel},r.prototype.getTileCredits=function(e,t,i){},r.prototype.requestImage=function(e,t,i){function r(e){var t=e.imageData.width,i=e.imageData.height;t>0&&i>0&&f.putImageData(e.imageData,e.xInOriginalRequest,e.yInOriginalRequest)}function a(e){e?T("Fetch request or decode aborted"):(_.drawImage(v,0,0,g,p,u.croppedScreen.minX,u.croppedScreen.minY,u.croppedScreen.maxXExclusive,u.croppedScreen.maxYExclusive),y(m))}if(!this._ready)throw new DeveloperError("requestImage must not be called before the imagery provider is ready.");var s=this,o=Math.pow(2,this._numResolutionLevels-i-1),h=e*this._tileWidth*o,l=t*this._tileHeight*o,c=(e+1)*this._tileWidth*o,d=(t+1)*this._tileHeight*o,u=n.alignParamsToTilesAndLevel({minX:h,minY:l,maxXExclusive:c,maxYExclusive:d,screenWidth:this._tileWidth,screenHeight:this._tileHeight},this._decoder,this._image),m=document.createElement("canvas");m.width=this._tileWidth,m.height=this._tileHeight;var _=m.getContext("2d");_.clearRect(0,0,this._tileWidth,this._tileHeight);var g=u.imagePartParams.maxXExclusive-u.imagePartParams.minX,p=u.imagePartParams.maxYExclusive-u.imagePartParams.minY;if(0>=g||0>=p)return m;var v=document.createElement("canvas");v.width=g,v.height=p;var f=v.getContext("2d");f.clearRect(0,0,g,p),u.imagePartParams.quality=this._quality,u.imagePartParams.requestPriorityData={imageRectangle:this._rectangle};var y,T,P=new Promise(function(e,t){y=e,T=t,s._decoder.requestPixelsProgressive(u.imagePartParams,r,a)});return P},r.prototype._setPriorityByFrustum=function(){if(this._ready){var e=s(this._cesiumWidget,this);null!==e&&(e.imageRectangle=this.getRectangle(),e.exactlevel=null,this._decoder.setServerRequestPrioritizerData(e),this._decoder.setDecodePrioritizerData(e))}},r.prototype.pickFeatures=function(){},r.prototype._onException=function(e){null!==this._exceptionCallback&&this._exceptionCallback(e)},r.prototype._opened=function(){if(this._ready)throw"ImageDecoderImageryProvider error: opened() was called more than once!";this._ready=!0,this._numResolutionLevels=this._decoder.getNumResolutionLevelsForLimittedViewer(),this._quality=this._decoder.getHighestQuality();var e=this._numResolutionLevels-1;this._tileWidth=this._decoder.getTileWidth(),this._tileHeight=this._decoder.getTileHeight();var t=(this._decoder.getImageLevel(),this._decoder.getImageWidth()),i=this._decoder.getImageHeight(),r=Math.ceil(t/this._tileWidth)>>e,s=Math.ceil(i/this._tileHeight)>>e;n.fixBounds(this._rectangle,this._decoder,this._adaptProportions);var o=this._rectangle.east-this._rectangle.west,h=this._rectangle.north-this._rectangle.south,l=1<<e,c=this._tileWidth*r*l,d=this._tileHeight*s*l,u=o*c/t,m=h*d/i,_=this._rectangle.west+u,g=this._rectangle.north-m;this._tilingSchemeParams={west:this._rectangle.west,east:_,south:g,north:this._rectangle.north,levelZeroTilesX:r,levelZeroTilesY:s,maximumLevel:e},this._tilingScheme=a(this._tilingSchemeParams),Cesium.TileProviderError.handleSuccess(this._errorEvent)}},{"_cesiumfrustumcalculator.js":1,"imagehelperfunctions.js":12,"workerproxyimagedecoder.js":18}],5:[function(e,t,i){"use strict";function r(e,t){if(n.call(this),this._options=t||{},this._tileWidth=this._options.tileWidth||256,this._tileHeight=this._options.tileHeight||256,this._showLog=!!this._options.showLog,this._fetchManager=null,this._decodeDependencyWorkers=null,this._requestsDecodeJobsPool=null,this._channelsDecodeJobsPool=null,this._fetchRequestId=0,this._channelStates=[],this._decoders=[],this._image=e,!this._image.getFetchManager)throw"Image.getFetchManager() is not implemented by image ctor argument!";if(!this._image.getDecoderWorkers)throw"Image.getDecoderWorkers() is not implemented by image ctor argument"}t.exports=r;var a=e("imageHelperFunctions.js"),s=e("decodejobspool.js"),n=e("imageparamsretrieverproxy.js");e("setdecoderslavesidecreator.js");r.alignParamsToTilesAndLevel=a.alignParamsToTilesAndLevel,r.prototype=Object.create(n.prototype),r.prototype.getTileWidth=function(){return this._tileWidth},r.prototype.getTileHeight=function(){return this._tileHeight},r.prototype.setServerRequestPrioritizerData=function(e){this._validateFetcher()},r.prototype.setDecodePrioritizerData=function(e){if(this._validateDecoder(),r.undefinedVar){if(null===this._decodePrioritizer)throw"No decode prioritizer has been set";this._showLog&&console.log("setDecodePrioritizerData("+e+")");var t=Object.create(e);t.image=this,this._decodePrioritizer.setPrioritizerData(t)}},r.prototype.open=function(e){this._validateFetcher();var t=this,i=this._fetchManager.open(e);return i.then(function(e){return t._internalSizesParams=e,{sizesParams:e,applicativeTileWidth:t.getTileWidth(),applicativeTileHeight:t.getTileHeight()}})},r.prototype.close=function(){this._validateFetcher(),this._validateDecoder();for(var e=0;e<this._decoders.length;++e)this._decoders[e].terminate();return this._fetchManager.close()},r.prototype.createChannel=function(){this._validateFetcher(),this.getImageParams();var e=this;return this._fetchManager.createChannel().then(function(t){return e._channelStates[t]={decodeJobsListenerHandle:null},t})},r.prototype.requestPixels=function(e){function t(t,n){a=t,s=n,o._requestsDecodeJobsPool.forkDecodeJobs(e,i,r)}function i(e){o._copyPixelsToAccumulatedResult(e,n)}function r(e){e?s("Request was aborted due to failure or priority"):a(n)}this._validateDecoder(),this.getImageParams();var a,s,n={},o=this,h=new Promise(t);return h},r.prototype.requestPixelsProgressive=function(e,t,i,r,a){this._validateDecoder(),this.getImageParams();var s,n=null;if(void 0===a)s=this._requestsDecodeJobsPool;else if(s=this._channelsDecodeJobsPool,n=this._channelStates[a],void 0===n)throw"Channel handle does not exist";var o=s.forkDecodeJobs(e,t,i,r);void 0!==a?(null!==n.decodeJobsListenerHandle&&s.unregisterForkedJobs(n.decodeJobsListenerHandle),n.decodeJobsListenerHandle=o,this._fetchManager.moveChannel(a,e)):this._fetchManager.createRequest(++this._fetchRequestId,e)},r.prototype.getImage=function(){return this._image},r.prototype._validateFetcher=function(){null===this._fetchManager&&(this._fetchManager=this._image.getFetchManager())},r.prototype._validateDecoder=function(){null===this._decodeDependencyWorkers&&(this._decodeDependencyWorkers=this._image.getDecoderWorkers(),this._requestsDecodeJobsPool=new s(this._decodeDependencyWorkers,this._tileWidth,this._tileHeight),this._channelsDecodeJobsPool=new s(this._decodeDependencyWorkers,this._tileWidth,this._tileHeight))},r.prototype._getImageParamsInternal=function(){return this._internalSizesParams},r.prototype._copyPixelsToAccumulatedResult=function(e,t){var i=4,r=e.width*i,a=e.originalRequestWidth*i;if(void 0===t.pixels){var s=a*e.originalRequestHeight;t.pixels=new Uint8Array(s),t.xInOriginalRequest=0,t.yInOriginalRequest=0;var n=e.originalRequestWidth;t.originalRequestWidth=n,t.width=n;var o=e.originalRequestHeight;t.originalRequestHeight=o,t.height=o}t.allRelevantBytesLoaded=e.allRelevantBytesLoaded;for(var h=0,l=e.xInOriginalRequest*i+e.yInOriginalRequest*a,c=0;c<e.height;++c){var d=e.pixels.subarray(h,h+r);t.pixels.set(d,l),h+=r,l+=a}}},{"decodejobspool.js":7,"imageHelperFunctions.js":11,"imageparamsretrieverproxy.js":15,"setdecoderslavesidecreator.js":17}],6:[function(e,t,i){"use strict";function r(e,t){this._isFirstStage=!0,this._listenerHandle=e,this._imagePartParams=t,this._allRelevantBytesLoaded=0;var i=e.imagePartParams;this._offsetX=t.minX-i.minX,this._offsetY=t.minY-i.minY,this._requestWidth=i.maxXExclusive-i.minX,this._requestHeight=i.maxYExclusive-i.minY}t.exports=r;e("linkedlist.js");r.prototype.onData=function(e){this._isFirstStage=!1;var t=e.allRelevantBytesLoaded-this._allRelevantBytesLoaded;this._allRelevantBytesLoaded=e.allRelevantBytesLoaded,this._listenerHandle.allRelevantBytesLoaded+=t;var i={originalRequestWidth:this._requestWidth,originalRequestHeight:this._requestHeight,xInOriginalRequest:this._offsetX,yInOriginalRequest:this._offsetY,imageData:e,allRelevantBytesLoaded:this._listenerHandle.allRelevantBytesLoaded};this._listenerHandle.callback(i)},r.prototype.onTerminated=function(){var e=--this._listenerHandle.remainingDecodeJobs;if(0>e)throw"Inconsistent number of done requests";var t=0===e;t&&(this._listenerHandle.isTerminatedCallbackCalled=!0,this._listenerHandle.terminatedCallback(this._listenerHandle.isAnyDecoderAborted))}},{"linkedlist.js":13}],7:[function(e,t,i){"use strict";function r(e,t,i){this._tileWidth=t,this._tileHeight=i,this._decodeDependencyWorkers=e}function a(e,t,i,r,a){if(void 0===a)return!1;for(var s=0;s<a.length;++s){var n=a[s],o=e>=n.minX&&i<=n.maxXExclusive,h=t>=n.minY&&r<=n.maxYExclusive;if(o&&h)return!0}return!1}t.exports=r;var s=e("decodejob.js");r.prototype.forkDecodeJobs=function(e,t,i,r){var n=e.minX,o=e.minY,h=e.maxXExclusive,l=e.maxYExclusive,c=e.level||0,d=e.quality,u=e.requestPriorityData,m=n%this._tileWidth===0&&o%this._tileHeight===0,_=h%this._tileWidth===0||h===e.levelWidth,g=l%this._tileHeight===0||l===e.levelHeight,p=h>n&&l>o;if(!(m&&_&&g&&p))throw"imagePartParams for decoders is not aligned to tile size or not in valid order";for(var v=Math.ceil((h-n)/this._tileWidth),f=Math.ceil((l-o)/this._tileHeight),y={imagePartParams:e,callback:t,terminatedCallback:i,remainingDecodeJobs:v*f,isAnyDecoderAborted:!1,isTerminatedCallbackCalled:!1,allRelevantBytesLoaded:0,unregisterHandles:[]},T=n;h>T;T+=this._tileWidth)for(var P=Math.min(T+this._tileWidth,e.levelWidth),w=o;l>w;w+=this._tileHeight){var x=Math.min(w+this._tileHeight,e.levelHeight),C=a(T,w,P,x,r);if(C)--y.remainingDecodeJobs;else{var E={minX:T,minY:w,maxXExclusive:P,maxYExclusive:x,levelWidth:e.levelWidth,levelHeight:e.levelHeight,level:c,quality:d,requestPriorityData:u},I=new s(y,E),b=this._decodeDependencyWorkers.startTask(E,I);y.unregisterHandles.push(b)}}return y.isTerminatedCallbackCalled||0!==y.remainingDecodeJobs||(y.isTerminatedCallbackCalled=!0,y.terminatedCallback(y.isAnyDecoderAborted)),y},r.prototype.unregisterForkedJobs=function(e){if(0!==e.remainingDecodeJobs)for(var t=0;t<e.unregisterHandles.length;++t)e.unregisterHandles[t].unregister()}},{"decodejob.js":6}],8:[function(e,t,i){"use strict";function r(e,t,i,a,s){this._fetcher=e,this._scheduler=t,this._scheduledJobsList=i,this._scheduledJobsListIterator=null,this._terminatedListeners=[],this._imagePartParams=null,this._state=r.FETCH_STATUS_WAIT_FOR_FETCH_CALL,this._isChannel=a===r.FETCH_TYPE_CHANNEL,this._contextVars=s,this._isOnlyWaitForData=a===r.FETCH_TYPE_ONLY_WAIT_FOR_DATA,this._useScheduler=a===r.FETCH_TYPE_REQUEST,this._resource=null,this._fetchHandle=null,this._fetchTerminatedBound=this._fetchTerminated.bind(this),a===r.FETCH_TYPE_CHANNEL?this._movableFetchState={}:this._movableFetchState=null}function a(e,t,i){if(null!==t._fetchHandle||null!==t._resource)throw"Unexpected restart of already started request";if(t._state===r.FETCH_STATUS_REQUEST_ABOUT_TO_ABORT)return void t._fetchTerminated(!0);if(t._state!==r.FETCH_STATUS_REQUEST_WAIT_FOR_SCHEDULE)throw"Unexpected state on schedule: "+t._state;t._resource=e,t._schedulerCallbacks=i,null!==e&&(t._scheduledJobsListIterator=t._scheduledJobsList.add(t)),t._startFetch()}function s(e,t){if(t.isChannel)throw"Unexpected call to continueYieldedRequest on channel";if(t._state===r.FETCH_STATUS_REQUEST_ABOUT_TO_ABORT||t._state===r.FETCH_STATUS_UNEXPECTED_FAILURE)return void t._schedulerCallbacks.jobDone();if(t._state!==r.FETCH_STATUS_REQUEST_YIELDED)throw"Unexpected request state on continue: "+t._state;t._state=r.FETCH_STATUS_ACTIVE,t._resource=e,t._scheduledJobsListIterator=t._scheduledJobsList.add(t),t._fetchHandle.resume()}function n(e){if(e._resource=null,e._scheduledJobsList.remove(e._scheduledJobsListIterator),e.state!==r.FETCH_STATUS_REQUEST_ABOUT_TO_YIELD)throw e._state=r.FETCH_STATUS_UNEXPECTED_FAILURE,"Unexpected request state on yield process: "+e._state;e._state=r.FETCH_STATUS_REQUEST_YIELDED}function o(e){e._resource=null,e._fetchTerminated(!0)}t.exports=r,r.FETCH_TYPE_REQUEST=1,r.FETCH_TYPE_CHANNEL=2,r.FETCH_TYPE_ONLY_WAIT_FOR_DATA=3,r.FETCH_STATUS_WAIT_FOR_FETCH_CALL=1,r.FETCH_STATUS_REQUEST_WAIT_FOR_SCHEDULE=2,r.FETCH_STATUS_ACTIVE=3,r.FETCH_STATUS_REQUEST_ABOUT_TO_YIELD=4,r.FETCH_STATUS_REQUEST_YIELDED=6,r.FETCH_STATUS_REQUEST_ABOUT_TO_ABORT=8,r.FETCH_STATUS_REQUEST_TERMINATED=9,r.FETCH_STATUS_UNEXPECTED_FAILURE=10,r.prototype.fetch=function(e){if(this._isChannel)return this._imagePartParams=e,void this._startFetch();if(null!==this._imagePartParams)throw'Cannot fetch twice on fetch type of "request"';if(this._state!==r.FETCH_STATUS_WAIT_FOR_FETCH_CALL)throw this._state=r.FETCH_STATUS_UNEXPECTED_FAILURE,"Unexpected state on fetch(): "+this._state;return this._imagePartParams=e,this._state=r.FETCH_STATUS_REQUEST_WAIT_FOR_SCHEDULE,this._useScheduler?void this._scheduler.enqueueJob(a,this,o):void a(null,this)},r.prototype.manualAbortRequest=function(){switch(this._state){case r.FETCH_STATUS_REQUEST_TERMINATED:case r.FETCH_STATUS_UNEXPECTED_FAILURE:return;case r.FETCH_STATUS_REQUEST_ABOUT_TO_ABORT:throw"Double call to manualAbortRequest()";case r.FETCH_STATUS_ACTIVE:var e=this;this._state=r.FETCH_STATUS_REQUEST_ABOUT_TO_ABORT,e._isOnlyWaitForData?e._fetchTerminated(!0):this._fetchHandle.stopAsync().then(function(){e._fetchTerminated(!0)});break;case r.FETCH_STATUS_WAIT_FOR_FETCH_CALL:return void(this._state=r.FETCH_STATUS_REQUEST_TERMINATED);case r.FETCH_STATUS_REQUEST_WAIT_FOR_SCHEDULE:case r.FETCH_STATUS_REQUEST_ABOUT_TO_YIELD:case r.FETCH_STATUS_REQUEST_YIELDED:this._state=r.FETCH_STATUS_REQUEST_ABOUT_TO_ABORT;break;default:throw"Unknown state in manualAbortRequest() implementation: "+this._state}},r.prototype.getContextVars=function(e){return this._contextVars},r.prototype.on=function(e,t){switch(e){case"terminated":this._terminatedListeners.push(t);break;default:throw"Unexpected event "+e}},r.prototype.setIsProgressive=function(e){this._isProgressive=e,null!==this._fetchHandle&&this._fetchHandle.setIsProgressive(e)},r.prototype.getIsProgressive=function(){return this._isProgressive},r.prototype._startFetch=function(){var e=this._state;this._state=r.FETCH_STATUS_ACTIVE,this._isOnlyWaitForData?this._fetchHandle=this._extractAlreadyFetchedData():this._isChannel?e!==r.FETCH_STATUS_WAIT_FOR_FETCH_CALL?this._fetchHandle=this._fetcher.moveFetch(this._imagePartParams,this._movableFetchState):this._fetchHandle=this._fetcher.startMovableFetch(this._imagePartParams,this._movableFetchState):this._fetchHandle=this._fetcher.fetch(this._imagePartParams),this._fetchHandle.on("terminated",this._fetchTerminatedBound),this._fetchHandle.setIsProgressive(this._isProgressive)},r.prototype._fetchTerminated=function(e){switch(this._state){case r.FETCH_STATUS_REQUEST_ABOUT_TO_ABORT:break;case r.FETCH_STATUS_ACTIVE:case r.FETCH_STATUS_REQUEST_ABOUT_TO_YIELD:if(e)throw this._state=r.FETCH_STATUS_UNEXPECTED_FAILURE,"Unexpected abort when fetch is active";break;default:throw"Unexpected state on fetch terminated: "+this._state}if(null!==this._resource){if(e)throw"Unexpected request termination without resource allocated";this._scheduledJobsList.remove(this._scheduledJobsListIterator),this._schedulerCallbacks.jobDone(),this._resource=null}else if(!e&&this._useScheduler)throw"Job expected to have resource on successful termination";if(!this._isChannel){this._state=r.FETCH_STATUS_REQUEST_TERMINATED;for(var t=0;t<this._terminatedListeners.length;++t)this._terminatedListeners[t](this._contextVars,e);null!==this._fetchHandle&&this._state!==r.FETCH_STATUS_UNEXPECTED_FAILURE&&(this._fetchHandle.dispose(),this._fetchHandle=null)}},r.prototype.checkIfShouldYield=function(){try{if(!this._useScheduler||this._state===r.FETCH_STATUS_REQUEST_TERMINATED)return;if(null===this._resource)throw"No resource allocated but fetch callback called";if(!this._schedulerCallbacks.shouldYieldOrAbort())return;this._state=r.FETCH_STATUS_REQUEST_ABOUT_TO_YIELD;var e=this;this._fetchHandle.stopAsync().then(function(){if(e._fetchState===r.FETCH_STATUS_REQUEST_ABOUT_TO_ABORT)return void e._fetchTerminated(!0);var t=e._schedulerCallbacks.tryYield(s,o,n);if(!t){if(e._state!==r.FETCH_STATUS_REQUEST_ABOUT_TO_YIELD)throw"Unexpected state on tryYield() false: "+e._state;e._state=r.FETCH_STATUS_ACTIVE,e._fetchHandle.resume()}})["catch"](function(){e._state=r.FETCH_STATUS_UNEXPECTED_FAILURE,o(e)})}catch(t){this._state=r.FETCH_STATUS_UNEXPECTED_FAILURE,o(this)}},Object.defineProperty(r.prototype,"imagePartParams",{get:function(){return this._imagePartParams}})},{}],9:[function(e,t,i){"use strict";function r(e,t){h.call(this),t=t||{};var i=t.serverRequestsLimit||5;if(this._fetcher=e,this._internalSizesParams=null,this._showLog=t.showLog,this._showLog)throw"showLog is not supported on this browser";if(!e.on)throw"ImageDecoderFramework error: Fetcher has no method on()";if(!e.open)throw"ImageDecoderFramework error: Fetcher has no method open()";if(!e.close)throw"ImageDecoderFramework error: Fetcher has no method close()";if(!e.fetch)throw"ImageDecoderFramework error: Fetcher has no method fetch()";if(!e.moveFetch)throw"ImageDecoderFramework error: Fetcher has no method moveFetch()";if(!e.startMovableFetch)throw"ImageDecoderFramework error: Fetcher has no method startMovableFetch()";var r=n.createScheduler(t.showLog,t.serverRequestPrioritizer,"serverRequest",s,i);this._serverRequestPrioritizer=r.prioritizer,this._scheduler=r.scheduler,this._channelHandleCounter=0,this._channelHandles=[],this._requestById=[],this._scheduledJobsList=new l}function a(e,t){delete e.self._requestById[e.requestId]}function s(){return{}}t.exports=r;var n=e("imagehelperfunctions.js"),o=e("fetchjob.js"),h=e("imageparamsretrieverproxy.js"),l=e("linkedlist.js");r.prototype=Object.create(h.prototype),r.prototype.open=function(e){var t=this._fetcher.open(e),i=this;return t.then(function(e){return i._internalSizesParams=e,e})},r.prototype.on=function(e,t){this._fetcher.on(e,t)},r.prototype.close=function(){return this._fetcher.close()},r.prototype.setIsProgressiveRequest=function(e,t){var i=this._requestById[e];return void 0===i?null:void i.setIsProgressive(t)},r.prototype.createChannel=function(){var e=this;return new Promise(function(t,i){var r=++e._channelHandleCounter;e._channelHandles[r]=new o(e._fetcher,e._scheduler,e._scheduledJobsList,o.FETCH_TYPE_CHANNEL,null),t(r)})},r.prototype.moveChannel=function(e,t){var i=this._channelHandles[e];i.fetch(t)},r.prototype.createRequest=function(e,t){var i={progressiveStagesDone:0,isLastCallbackCalledWithoutLowQualityLimit:!1,requestId:e,fetchJob:null,self:this},r=o.FETCH_TYPE_REQUEST,s=new o(this._fetcher,this._scheduler,this._scheduledJobsList,r,i);if(i.fetchJob=s,void 0!==this._requestById[e])throw"Duplication of requestId "+e;void 0!==e&&(this._requestById[e]=s),s.on("terminated",a),s.fetch(t),this._yieldFetchJobs()},r.prototype.manualAbortRequest=function(e){var t=this._requestById[e];void 0!==t&&(t.manualAbortRequest(),delete this._requestById[e])},r.prototype.setServerRequestPrioritizerData=function(e){if(null===this._serverRequestPrioritizer)throw"No serverRequest prioritizer has been set";this._showLog&&console.log("setServerRequestPrioritizerData("+e+")"),e.image=this,this._serverRequestPrioritizer.setPrioritizerData(e),this._yieldFetchJobs()},r.prototype._getImageParamsInternal=function(){return this._internalSizesParams},r.prototype._yieldFetchJobs=function(){for(var e=this._scheduledJobsList.getFirstIterator();null!==e;){var t=this._scheduledJobsList.getValue(e);e=this._scheduledJobsList.getNextIterator(e),t.checkIfShouldYield()}}},{"fetchjob.js":8,"imagehelperfunctions.js":12,"imageparamsretrieverproxy.js":15,"linkedlist.js":13}],10:[function(e,t,i){"use strict";function r(e,t){this._frustumData=null,this._isAbortRequestsNotInFrustum=e,this._isPrioritizeLowProgressiveStage=t}t.exports=r;var a=-1,s=0,n=1,o=2,h=3,l=4,c=5,d=6,u=7,m=5,_=13;Math.log(2);Object.defineProperty(r.prototype,"minimalLowQualityPriority",{get:function(){return l+m}}),r.prototype.setPrioritizerData=function(e){this._frustumData=e},r.prototype.getPriority=function(e){var t=e.imagePartParams;if(t.requestPriorityData.overrideHighestPriority)return _;var i=this._getPriorityInternal(t),r=i>=l;if(this._isAbortRequestsNotInFrustum&&!r)return a;var s=0;return this._isPrioritizeLowProgressiveStage&&r&&(s=0===e.progressiveStagesDone?m:1===e.progressiveStagesDone?1:0),i+s},r.prototype._getPriorityInternal=function(e){if(null===this._frustumData)return s;if(void 0===this._frustumData.imageRectangle)throw"No imageRectangle information passed in setPrioritizerData";
var t=this._frustumData.exactlevel;if(void 0===this._frustumData.exactlevel)throw"No exactlevel information passed in setPrioritizerData. Use null if unknown";var i,r=this._pixelToCartographicX(e.minX,e),a=this._pixelToCartographicX(e.maxXExclusive,e),m=this._pixelToCartographicY(e.minY,e),_=this._pixelToCartographicY(e.maxYExclusive,e),g=e.maxXExclusive-e.minX,p=e.maxYExclusive-e.minY,v=e.level||0;if(null===t){var f=g/(a-r),y=p/(m-_),T=Math.max(f,y),P=this._frustumData.resolution;if(i=T/P,i>2)return n}else if(t>v)return n;var w=this._frustumData.rectangle,x=Math.max(w.west,r),C=Math.min(w.east,a),E=Math.max(w.south,_),I=Math.min(w.north,m),b=C-x,F=I-E;if(0>b||0>F)return o;if(null!==t){if(v>t)return h}else if(v>0&&.25>i)return h;var S=b*F,D=(a-r)*(m-_),H=S/D;return H>.99?u:H>.7?d:H>.3?c:l},r.prototype._pixelToCartographicX=function(e,t){var i=e/t.levelWidth,r=this._frustumData.imageRectangle,a=r.east-r.west,s=r.west+i*a;return s},r.prototype._pixelToCartographicY=function(e,t,i){var r=e/t.levelHeight,a=this._frustumData.imageRectangle,s=a.north-a.south,n=a.north-r*s;return n}},{}],11:[function(e,t,i){"use strict";function r(e,t){var i=t.x*t.x+t.y*t.y,r=e.east-e.west,a=e.north-e.south,s=r*r+a*a,n=Math.sqrt(i/s),o={resolution:n,rectangle:e,screenSize:t};return o}function a(e,t,i,r,a){var s,n;if(void 0===t)s=null,n=new resourceScheduler.LifoScheduler(r,a);else{var h=!1;"frustum"===t?(h=!0,s=new o):"frustumOnly"===t?(h=!0,s=new o(!0,!0)):s=t;var l={schedulerName:i,showLog:e};h&&(l.resourceGuaranteedForHighPriority=a-2,l.highPriorityToGuaranteeResource=s.minimalLowQualityPriority),n=new resourceScheduler.PriorityScheduler(r,a,s,l)}return{prioritizer:s,scheduler:n}}function s(e,t,i){if(i){var r=e.east-e.west,a=e.north-e.south,s=t.getImageWidth()/t.getImageHeight(),n=r/a;if(n>s){var o=r;r=a*s;var h=o-r;e.east-=h/2,e.west+=h/2}else{var l=a;a=r/s;var c=l-a;e.north-=c/2,e.south+=c/2}}}function n(e,t){var i=t.getTileWidth(),r=t.getTileHeight(),a=e.minX,s=e.minY,n=e.maxXExclusive,o=e.maxYExclusive,h=e.screenWidth,l=e.screenHeight,c=n>a&&o>s;if(!c)throw"Parameters order is invalid";var d=t.getImageWidth(),u=t.getImageHeight();if(0>n||a>=d||0>o||s>=u)return null;var m=t.getImage(),_=m.getLevel(e),g=m.getLevelWidth(_),p=m.getLevelHeight(_),v=d/g,f=u/p,y=Math.floor(a/(v*i)),T=Math.floor(s/(f*r)),P=Math.ceil(n/(v*i)),w=Math.ceil(o/(f*r)),x=y*i,C=T*r,E=P*i,I=w*r,b=Math.max(0,Math.min(g,x)),F=Math.max(0,Math.min(p,C)),S=Math.max(0,Math.min(g,E)),D=Math.max(0,Math.min(p,I)),H=h/(E-x),L=l/(I-C),R={minX:b,minY:F,maxXExclusive:S,maxYExclusive:D,levelWidth:g,levelHeight:p,level:_},k={minX:b*v,minY:F*f,maxXExclusive:S*v,maxYExclusive:D*f},A={minX:Math.floor((b-x)*H),minY:Math.floor((F-C)*L),maxXExclusive:Math.ceil((S-x)*H),maxYExclusive:Math.ceil((D-C)*L)};return{imagePartParams:R,positionInImage:k,croppedScreen:A}}var o=e("frustumrequestsprioritizer.js");t.exports={calculateFrustum2DFromBounds:r,createScheduler:a,fixBounds:s,alignParamsToTilesAndLevel:n}},{"frustumrequestsprioritizer.js":10}],12:[function(e,t,i){arguments[4][11][0].apply(i,arguments)},{dup:11,"frustumrequestsprioritizer.js":10}],13:[function(e,t,i){"use strict";function r(){this._first={_prev:null,_parent:this},this._last={_next:null,_parent:this},this._count=0,this._last._prev=this._first,this._first._next=this._last}t.exports=r,r.prototype.add=function(e,t){null!==t&&void 0!==t||(t=this._last),this._validateIteratorOfThis(t),++this._count;var i={_value:e,_next:t,_prev:t._prev,_parent:this};return i._prev._next=i,t._prev=i,i},r.prototype.remove=function(e){this._validateIteratorOfThis(e),--this._count,e._prev._next=e._next,e._next._prev=e._prev,e._parent=null},r.prototype.getValue=function(e){return this._validateIteratorOfThis(e),e._value},r.prototype.getFirstIterator=function(){var e=this.getNextIterator(this._first);return e},r.prototype.getLastIterator=function(){var e=this.getPrevIterator(this._last);return e},r.prototype.getNextIterator=function(e){return this._validateIteratorOfThis(e),e._next===this._last?null:e._next},r.prototype.getPrevIterator=function(e){return this._validateIteratorOfThis(e),e._prev===this._first?null:e._prev},r.prototype.getCount=function(){return this._count},r.prototype._validateIteratorOfThis=function(e){if(e._parent!==this)throw"iterator must be of the current LinkedList"}},{}],14:[function(e,t,i){"use strict";function r(){AsyncProxy.AsyncProxySlave.setSlaveSideCreator(function(){var e=new Array(arguments.length+1);e[0]=null;for(var t=0;t<arguments.length;++t)e[t+1]=arguments[t];var i=new(Function.prototype.bind.apply(imageDecoderFramework.ImageDecoder,e));return i})}e("imagedecoder.js");t.exports.getScriptUrl=function(){return s};var a=new Blob(["(",r.toString(),")()"],{type:"application/javascript"}),s=URL.createObjectURL(a)},{"imagedecoder.js":5}],15:[function(e,t,i){"use strict";function r(){this._sizesParams=null}t.exports=r,r.prototype.getImageLevel=function(){var e=this.getImageParams();return e.imageLevel},r.prototype.getImageWidth=function(){var e=this.getImageParams();return e.imageWidth},r.prototype.getImageHeight=function(){var e=this.getImageParams();return e.imageHeight},r.prototype.getNumResolutionLevelsForLimittedViewer=function(){var e=this.getImageParams();return e.numResolutionLevelsForLimittedViewer},r.prototype.getLowestQuality=function(){var e=this.getImageParams();return e.lowestQuality},r.prototype.getHighestQuality=function(){var e=this.getImageParams();return e.highestQuality},r.prototype.getImageParams=function(){if(!this._sizesParams){if(this._sizesParams=this._getImageParamsInternal(),!this._sizesParams)throw"getImageParamsInternal() returned falsy value; Maybe image not ready yet?";if(void 0===this._sizesParams.imageLevel)throw"getImageParamsInternal() result has no imageLevel property";if(void 0===this._sizesParams.imageWidth)throw"getImageParamsInternal() result has no imageWidth property";if(void 0===this._sizesParams.imageHeight)throw"getImageParamsInternal() result has no imageHeight property";if(void 0===this._sizesParams.numResolutionLevelsForLimittedViewer)throw"getImageParamsInternal() result has no numResolutionLevelsForLimittedViewer property";if(void 0===this._sizesParams.lowestQuality)throw"getImageParamsInternal() result has no lowestQuality property";if(void 0===this._sizesParams.highestQuality)throw"getImageParamsInternal() result has no highestQuality property"}return this._sizesParams},r.prototype._getImageParamsInternal=function(){throw"ImageParamsRetrieverProxy inheritor did not implement _getImageParamsInternal()"}},{}],16:[function(e,t,i){"use strict";function r(){function e(e,i,r){if("callback"===e&&"statusCallback"===i){if(t||!r[0].isReady)return null;var a={sizesParams:this.getImageParams()};this.getTileWidth&&(a.applicativeTileWidth=this.getTileWidth()),this.getTileHeight&&(a.applicativeTileHeight=this.getTileHeight()),AsyncProxy.AsyncProxySlave.sendUserDataToMaster(a),t=!0}}var t=!1;AsyncProxy.AsyncProxySlave.setBeforeOperationListener(e)}t.exports.getScriptUrl=function(){return s};var a=new Blob(["(",r.toString(),")()"],{type:"application/javascript"}),s=URL.createObjectURL(a)},{}],17:[function(e,t,i){"use strict";function r(){AsyncProxy.AsyncProxySlave.setSlaveSideCreator(function(e){var t=imageDecoderFramework.Internals.imageHelperFunctions.getImageImplementation(e.imageImplementationClassName);return t.createPixelsDecoder()})}t.exports.getScriptUrl=function(){return s};var a=(e("imagehelperfunctions.js"),new Blob(["(",r.toString(),")()"],{type:"application/javascript"})),s=URL.createObjectURL(a)},{"imagehelperfunctions.js":12}],18:[function(e,t,i){"use strict";function r(e,t){o.call(this),this._imageWidth=null,this._imageHeight=null,this._tileWidth=0,this._tileHeight=0;var i=a.createInternalOptions(e,t),r=[e,i],h=a.getScriptsForWorkerImport(this._imageImplementation,t);h=h.concat([s.getScriptUrl(),n.getScriptUrl()]),this._workerHelper=new AsyncProxy.AsyncProxyMaster(h,"imageDecoderFramework.ImageDecoder",r);var l=this._imageOpened.bind(this);this._workerHelper.setUserDataHandler(l)}t.exports=r;var a=e("imagehelperfunctions.js"),s=e("sendimageparameterstomaster.js"),n=e("createimagedecoderonslaveside.js"),o=e("imageparamsretrieverproxy.js");r.prototype=Object.create(o.prototype),r.prototype.getTileWidth=function(){return this.getImageParams(),this._tileWidth},r.prototype.getTileHeight=function(){return this.getImageParams(),this._tileHeight},r.prototype.open=function(e){var t=this;return this._workerHelper.callFunction("open",[e],{isReturnPromise:!0}).then(function(e){return t._imageOpened(e),e})},r.prototype.close=function(){return this._workerHelper.callFunction("close",[],{isReturnPromise:!0})},r.prototype.createChannel=function(){this._workerHelper.callFunction("createChannel",[],{isReturnPromise:!0})},r.prototype.requestPixels=function(e){var t=["data","buffer"],i=[t],r=[e];this._workerHelper.callFunction("requestPixels",r,{isReturnPromise:!0,pathsToTransferablesInPromiseResult:i})},r.prototype.requestPixelsProgressive=function(e,t,i,r,a){function s(e){c._workerHelper.freeCallback(o),i(e)}var n,o=this._workerHelper.wrapCallback(t,"requestPixelsProgressiveCallback",{isMultipleTimeCallback:!0,pathsToTransferables:n}),h=this._workerHelper.wrapCallback(s,"requestPixelsProgressiveTerminatedCallback",{isMultipleTimeCallback:!1}),l=[e,o,h,r,a];this._workerHelper.callFunction("requestPixelsProgressive",l);var c=this},r.prototype.setServerRequestPrioritizerData=function(e){this._workerHelper.callFunction("setServerRequestPrioritizerData",[e],{isSendImmediately:!0})},r.prototype.setDecodePrioritizerData=function(e){this._workerHelper.callFunction("setDecodePrioritizerData",[e],{isSendImmediately:!0})},r.prototype.reconnect=function(){this._workerHelper.callFunction("reconnect")},r.prototype.alignParamsToTilesAndLevel=function(e){return a.alignParamsToTilesAndLevel(e,this)},r.prototype._imageOpened=function(e){this._internalSizesParams=e.sizesParams,this._tileWidth=e.applicativeTileWidth,this._tileHeight=e.applicativeTileHeight,this.getImageParams()},r.prototype._getImageParamsInternal=function(){return this._internalSizesParams}},{"createimagedecoderonslaveside.js":14,"imagehelperfunctions.js":12,"imageparamsretrieverproxy.js":15,"sendimageparameterstomaster.js":16}],19:[function(e,t,i){"use strict";function r(e,t,i){this._canvasUpdatedCallback=t,this._adaptProportions=i.adaptProportions,this._cartographicBounds=i.cartographicBounds,this._isMainImageOnUi=i.isMainImageOnUi,this._showLog=i.showLog,this._allowMultipleChannelsInSession=i.allowMultipleChannelsInSession,this._minFunctionCallIntervalMilliseconds=i.minFunctionCallIntervalMilliseconds,this._overviewResolutionX=i.overviewResolutionX||100,this._overviewResolutionY=i.overviewResolutionY||100,this._lastRequestIndex=0,this._pendingUpdateViewArea=null,this._regions=[],this._targetCanvas=null,this._callPendingCallbacksBound=this._callPendingCallbacks.bind(this),this._createdChannelBound=this._createdChannel.bind(this),this._pendingCallbacksIntervalHandle=0,this._pendingCallbackCalls=[],this._canShowDynamicRegion=!1,void 0===this._cartographicBounds&&(this._cartographicBounds={west:-175,east:175,south:-85,north:85}),void 0===this._adaptProportions&&(this._adaptProportions=!0),this._decoder=e,this._image=e.getImage()}t.exports=r;var a=(e("imagedecoder.js"),e("workerproxyimagedecoder.js"),e("imagehelperfunctions.js")),s=1,n=2,o=0,h=1;r.prototype.setExceptionCallback=function(e){this._exceptionCallback=e},r.prototype.open=function(e){return this._decoder.open(e).then(this._opened.bind(this))["catch"](this._exceptionCallback)},r.prototype.close=function(){var e=this._decoder.close();return e["catch"](this._exceptionCallback),this._isReady=!1,this._canShowDynamicRegion=!1,this._targetCanvas=null,e},r.prototype.setTargetCanvas=function(e){this._targetCanvas=e},r.prototype.updateViewArea=function(e){if(null===this._targetCanvas)throw"Cannot update dynamic region before setTargetCanvas()";if(!this._canShowDynamicRegion)return void(this._pendingUpdateViewArea=e);var t=e.rectangle,i=e.screenSize,r={minX:t.west*this._scaleX+this._translateX,minY:t.north*this._scaleY+this._translateY,maxXExclusive:t.east*this._scaleX+this._translateX,maxYExclusive:t.south*this._scaleY+this._translateY,screenWidth:i.x,screenHeight:i.y},s=a.alignParamsToTilesAndLevel(r,this._decoder,this._image),n=null===s;if(!n){s.imagePartParams.quality=this._quality;var o=void 0!==this._dynamicFetchParams&&this._isImagePartsEqual(s.imagePartParams,this._dynamicFetchParams.imagePartParams);if(!o){e.imageRectangle=this._cartographicBoundsFixed,e.exactlevel=s.imagePartParams.level,this._decoder.setDecodePrioritizerData(e),this._decoder.setServerRequestPrioritizerData(e),this._dynamicFetchParams=s;var l=!1,c=!this._allowMultipleChannelsInSession;this._fetch(h,s,l,c)}}},r.prototype.getBounds=function(){if(!this._isReady)throw"ViewerImageDecoder error: Image is not ready yet";return this._cartographicBoundsFixed},r.prototype._isImagePartsEqual=function(e,t){var i=void 0!==this._dynamicFetchParams&&e.minX===t.minX&&e.minY===t.minY&&e.maxXExclusive===t.maxXExclusive&&e.maxYExclusive===t.maxYExclusive&&e.level===t.level;return i},r.prototype._fetch=function(e,t,i,r){function a(i){C._tilesDecodedCallback(e,t,f,i)}function s(r){r&&h.requestPriorityData.overrideHighestPriority&&C._decoder.requestPixelsProgressive(t.imagePartParams,a,s,l),C._fetchTerminatedCallback(e,t.imagePartParams.requestPriorityData,r,i)}var n=++this._lastRequestIndex,h=t.imagePartParams;h.requestPriorityData=h.requestPriorityData||{},h.requestPriorityData.requestIndex=n;var l,c=t.positionInImage.minX,d=t.positionInImage.minY,u=t.positionInImage.maxXExclusive,m=t.positionInImage.maxYExclusive,_=(c-this._translateX)/this._scaleX,g=(u-this._translateX)/this._scaleX,p=(d-this._translateY)/this._scaleY,v=(m-this._translateY)/this._scaleY,f={west:_,east:g,north:p,south:v},y=!1,T=this._regions[e];if(void 0!==T){var P=h.level,w=T.imagePartParams.level;if(y=P===w,y&&T.donePartParams&&(l=[T.donePartParams]),e!==o){var x=this._checkIfRepositionNeeded(T,h,f);x&&this._notifyNewPendingCalls()}}var C=this,E=r?this._channelHandle:void 0;this._decoder.requestPixelsProgressive(t.imagePartParams,a,s,l,E)},r.prototype._fetchTerminatedCallback=function(e,t,i,r){var a=this._regions[e];void 0!==a&&(t.overrideHighestPriority||t.requestIndex===this._lastRequestIndex)&&(a.isDone=!i&&this._isReady,a.isDone&&(a.donePartParams=a.imagePartParams),r&&this._decoder.createChannel().then(this._createdChannelBound))},r.prototype._createdChannel=function(e){this._channelHandle=e,this._startShowingDynamicRegion()},r.prototype._startShowingDynamicRegion=function(){this._canShowDynamicRegion=!0,null!==this._pendingUpdateViewArea&&(this.updateViewArea(this._pendingUpdateViewArea),this._pendingUpdateViewArea=null)},r.prototype._tilesDecodedCallback=function(e,t,i,r){if(this._isReady){var a=this._regions[e];if(void 0===a)switch(a={},this._regions[e]=a,e){case h:a.canvas=this._targetCanvas;break;case o:a.canvas=document.createElement("canvas");break;default:throw"Unexpected regionId "+e}var n=t.imagePartParams;!n.requestPriorityData.overrideHighestPriority&&n.requestPriorityData.requestIndex<a.currentDisplayRequestIndex||(this._checkIfRepositionNeeded(a,n,i),this._pendingCallbackCalls.push({type:s,region:a,decoded:r}),this._notifyNewPendingCalls())}},r.prototype._checkIfRepositionNeeded=function(e,t,i){var r=e.imagePartParams,a=e.donePartParams,s=t.level,o=void 0===r||r.minX!==t.minX||r.minY!==t.minY||r.maxXExclusive!==t.maxXExclusive||r.maxYExclusive!==t.maxYExclusive||r.level!==s;if(!o)return!1;var h,l,c,d,u,m=!1;void 0!==r&&(d=t.levelWidth/r.levelWidth,u=t.levelHeight/r.levelHeight,l={minX:Math.max(r.minX*d,t.minX),minY:Math.max(r.minY*u,t.minY),maxX:Math.min(r.maxXExclusive*d,t.maxXExclusive),maxY:Math.min(r.maxYExclusive*u,t.maxYExclusive)},m=l.maxX>l.minX&&l.maxY>l.minY),m&&(h={fromX:l.minX/d-r.minX,fromY:l.minY/u-r.minY,fromWidth:(l.maxX-l.minX)/d,fromHeight:(l.maxY-l.minY)/u,toX:l.minX-t.minX,toY:l.minY-t.minY,toWidth:l.maxX-l.minX,toHeight:l.maxY-l.minY},a&&r.level===s&&(c={minX:Math.max(a.minX,t.minX),minY:Math.max(a.minY,t.minY),maxXExclusive:Math.min(a.maxXExclusive,t.maxXExclusive),maxYExclusive:Math.min(a.maxYExclusive,t.maxYExclusive)})),e.imagePartParams=t,e.isDone=!1,e.currentDisplayRequestIndex=t.requestPriorityData.requestIndex;var _={type:n,region:e,position:i,donePartParams:c,copyData:h,pixelsWidth:t.maxXExclusive-t.minX,pixelsHeight:t.maxYExclusive-t.minY};return this._pendingCallbackCalls.push(_),!0},r.prototype._notifyNewPendingCalls=function(){this._isNearCallbackCalled||this._callPendingCallbacks()},r.prototype._callPendingCallbacks=function(){if(0===this._pendingCallbackCalls.length||!this._isReady)return void(this._isNearCallbackCalled=!1);this._isNearCallbackCalled&&clearTimeout(this._pendingCallbacksIntervalHandle),void 0!==this._minFunctionCallIntervalMilliseconds&&(this._pendingCallbacksIntervalHandle=setTimeout(this._callPendingCallbacksBound,this._minFunctionCallIntervalMilliseconds),this._isNearCallbackCalled=!0);for(var e=null,t=0;t<this._pendingCallbackCalls.length;++t){var i=this._pendingCallbackCalls[t];if(i.type===n)this._repositionCanvas(i),e=i.position;else{if(i.type!==s)throw"Internal ViewerImageDecoder Error: Unexpected call type "+i.type;this._pixelsUpdated(i)}}this._pendingCallbackCalls.length=0,this._canvasUpdatedCallback(e)},r.prototype._pixelsUpdated=function(e){var t=e.region,i=e.decoded;if(0!==i.imageData.width&&0!==i.imageData.height){var r=i.xInOriginalRequest,a=i.yInOriginalRequest,s=t.canvas.getContext("2d");s.putImageData(i.imageData,r,a)}},r.prototype._repositionCanvas=function(e){var t,i=e.region,r=e.position,a=e.donePartParams,s=e.copyData,n=e.pixelsWidth,h=e.pixelsHeight,l=i.canvas.getContext("2d");void 0!==s&&(s.fromWidth===s.toWidth&&s.fromHeight===s.toHeight?t=l.getImageData(s.fromX,s.fromY,s.fromWidth,s.fromHeight):(this._tmpCanvas||(this._tmpCanvas=document.createElement("canvas"),this._tmpCanvasContext=this._tmpCanvas.getContext("2d")),this._tmpCanvas.width=s.toWidth,this._tmpCanvas.height=s.toHeight,this._tmpCanvasContext.drawImage(i.canvas,s.fromX,s.fromY,s.fromWidth,s.fromHeight,0,0,s.toWidth,s.toHeight),t=this._tmpCanvasContext.getImageData(0,0,s.toWidth,s.toHeight))),i.canvas.width=n,i.canvas.height=h,i!==this._regions[o]&&this._copyOverviewToCanvas(l,r,n,h),void 0!==s&&l.putImageData(t,s.toX,s.toY),i.position=r,i.donePartParams=a},r.prototype._copyOverviewToCanvas=function(e,t,i,r){var a=this._regions[o].position,s=this._regions[o].imagePartParams,n=s.maxXExclusive-s.minX,h=s.maxYExclusive-s.minY,l=a.east-a.west,c=a.north-a.south,d=n/l,u=h/c,m=t.east-t.west,_=t.north-t.south,g=m*d,p=_*u,v=t.west-a.west,f=a.north-t.north,y=v*d,T=f*u;e.drawImage(this._regions[o].canvas,y,T,g,p,0,0,i,r)},r.prototype._opened=function(){this._isReady=!0;var e={west:this._cartographicBounds.west,east:this._cartographicBounds.east,south:this._cartographicBounds.south,north:this._cartographicBounds.north};a.fixBounds(e,this._decoder,this._adaptProportions),this._cartographicBoundsFixed=e;var t=this._decoder.getImageWidth(),i=this._decoder.getImageHeight();this._quality=this._decoder.getHighestQuality();var r=e.east-e.west,s=e.north-e.south;this._scaleX=t/r,this._scaleY=-i/s,this._translateX=-e.west*this._scaleX,this._translateY=-e.north*this._scaleY;var n={minX:0,minY:0,maxXExclusive:t,maxYExclusive:i,screenWidth:this._overviewResolutionX,screenHeight:this._overviewResolutionY},h=a.alignParamsToTilesAndLevel(n,this._decoder,this._image);h.imagePartParams.requestPriorityData=h.imagePartParams.requestPriorityData||{},h.imagePartParams.requestPriorityData.overrideHighestPriority=!0,h.imagePartParams.quality=this._decoder.getLowestQuality();var l=!this._allowMultipleChannelsInSession;this._fetch(o,h,l),this._allowMultipleChannelsInSession&&this._startShowingDynamicRegion()}},{"imagedecoder.js":5,"imagehelperfunctions.js":12,"workerproxyimagedecoder.js":18}],20:[function(e,t,i){"use strict";t.exports.ViewerImageDecoder=e("viewerimagedecoder.js"),t.exports.ImageDecoder=e("imagedecoder.js"),t.exports.FetchManager=e("fetchmanager.js"),t.exports.SimpleFetchAdapterFetchHandle=e("simplefetchadapterfetchhandle.js"),t.exports.GridImageBase=e("gridimagebase.js"),t.exports.GridFetcherBase=e("gridfetcherbase.js"),t.exports.GridDecoderWorkerBase=e("griddecoderworkerbase.js"),t.exports.CesiumImageDecoderLayerManager=e("_cesiumimagedecoderlayermanager.js"),t.exports.ImageDecoderImageryProvider=e("imagedecoderimageryprovider.js"),t.exports.ImageDecoderRegionLayer=e("imagedecoderregionlayer.js")},{"_cesiumimagedecoderlayermanager.js":2,"fetchmanager.js":9,"griddecoderworkerbase.js":23,"gridfetcherbase.js":24,"gridimagebase.js":25,"imagedecoder.js":5,"imagedecoderimageryprovider.js":4,"imagedecoderregionlayer.js":21,"simplefetchadapterfetchhandle.js":26,"viewerimagedecoder.js":19}],21:[function(e,t,i){"use strict";function r(){return{initialize:function(e){if(this._options=e||{},void 0!==this._options.latLngBounds){this._options={};for(var t in e)this._options[t]=e[t];this._options.cartographicBounds={west:e.latLngBounds.getWest(),east:e.latLngBounds.getEast(),south:e.latLngBounds.getSouth(),north:e.latLngBounds.getNorth()}}this._targetCanvas=null,this._canvasPosition=null,this._canvasUpdatedCallbackBound=this._canvasUpdatedCallback.bind(this),this._viewerImageDecoder=null,this._exceptionCallback=null},setExceptionCallback:function(e){this._exceptionCallback=e,null!==this._viewerImageDecoder&&this._viewerImageDecoder.setExceptionCallback(e)},_createImage:function(){null===this._viewerImageDecoder&&(this._viewerImageDecoder=new a(this._options.imageDecoder,this._canvasUpdatedCallbackBound,this._options),null!==this._exceptionCallback&&this._viewerImageDecoder.setExceptionCallback(this._exceptionCallback),this._viewerImageDecoder.open(this._options.url)["catch"](this._exceptionCallback))},onAdd:function(e){if(void 0!==this._map)throw"Cannot add this layer to two maps";this._map=e,this._createImage(),this._targetCanvas=L.DomUtil.create("canvas","image-decoder-layer-canvas leaflet-zoom-animated"),this._viewerImageDecoder.setTargetCanvas(this._targetCanvas),this._canvasPosition=null,e.getPanes().mapPane.appendChild(this._targetCanvas),e.on("viewreset",this._moved,this),e.on("move",this._moved,this),L.Browser.any3d&&e.on("zoomanim",this._animateZoom,this),this._moved()},onRemove:function(e){if(e!==this._map)throw"Removed from wrong map";e.off("viewreset",this._moved,this),e.off("move",this._moved,this),e.off("zoomanim",this._animateZoom,this),e.getPanes().mapPane.removeChild(this._targetCanvas),this._targetCanvas=null,this._canvasPosition=null,this._map=void 0,this._viewerImageDecoder.close(),this._viewerImageDecoder=null},_moved:function(){this._moveCanvases();var e=s(this._map);this._viewerImageDecoder.updateViewArea(e)},_canvasUpdatedCallback:function(e){null!==e&&(this._canvasPosition=e,this._moveCanvases())},_moveCanvases:function(){if(null!==this._canvasPosition){var e=this._canvasPosition.west,t=this._canvasPosition.east,i=this._canvasPosition.south,r=this._canvasPosition.north,a=this._map.latLngToLayerPoint([r,e]),s=this._map.latLngToLayerPoint([i,t]),n=s.subtract(a);L.DomUtil.setPosition(this._targetCanvas,a),this._targetCanvas.style.width=n.x+"px",this._targetCanvas.style.height=n.y+"px"}},_animateZoom:function(e){if(null!==this._canvasPosition){var t=this._canvasPosition.west,i=this._canvasPosition.east,r=this._canvasPosition.south,a=this._canvasPosition.north,s=this._map._latLngToNewLayerPoint([a,t],e.zoom,e.center),n=this._map._latLngToNewLayerPoint([r,i],e.zoom,e.center),o=this._map.getZoomScale(e.zoom),h=n.subtract(s),l=h.multiplyBy(.5*(1-1/o)),c=s.add(l);this._targetCanvas.style[L.DomUtil.TRANSFORM]=L.DomUtil.getTranslateString(c)+" scale("+o+") "}}}}var a=e("viewerimagedecoder.js"),s=e("leafletfrustumcalculator.js");self.L?t.exports=L.Class.extend(r()):t.exports=function(){throw new Error("Cannot instantiate ImageDecoderRegionLayer: No Leaflet namespace in scope")}},{"leafletfrustumcalculator.js":22,"viewerimagedecoder.js":19}],22:[function(e,t,i){"use strict";var r=e("imagehelperfunctions.js");t.exports=function(e){var t=e.getSize(),i=e.getBounds(),a={west:i.getWest(),east:i.getEast(),south:i.getSouth(),north:i.getNorth()},s=r.calculateFrustum2DFromBounds(a,t);return s}},{"imagehelperfunctions.js":12}],23:[function(e,t,i){"use strict";function r(){r.prototype.start=function(e){for(var t=e.imagePartParams,i=t.maxXExclusive-t.minX,r=t.maxYExclusive-t.minY,a=new ImageData(i,r),s=[],n={minX:0,minY:0,maxXExclusive:0,maxYExclusive:0,width:e.tileWidth,height:e.tileHeight},o={minX:0,minY:0,maxXExclusive:0,maxYExclusive:0,width:0,height:0},h={x:0,y:0},l={tileX:0,tileY:0,level:0,position:n,content:null},c=0;c<e.tileIndices.length;++c)n.minX=e.tileIndices[c].tileX*e.tileWidth,n.minY=e.tileIndices[c].tileY*e.tileHeight,n.maxXExclusive=n.minX+e.tileWidth,n.maxYExclusive=n.minY+e.tileHeight,o.minX=Math.max(n.minX,t.minX),o.minY=Math.max(n.minY,t.minY),o.maxXExclusive=Math.min(n.maxXExclusive,t.maxXExclusive),o.maxYExclusive=Math.min(n.maxYExclusive,t.maxYExclusive),o.width=o.maxXExclusive-o.minX,o.height=o.maxYExclusive-o.minY,h.x=o.minX-t.minX,h.y=o.minY-t.minY,l.tileY=e.tileIndices[c].tileY,l.tileX=e.tileIndices[c].tileX,l.level=e.tileIndices[c].level,l.content=e.tileContents[c],s.push(this.decodeRegion(a,h,o,l));return Promise.all(s).then(function(){return a})},r.prototype.decodeRegion=function(e,t,i,r){throw"SimplePixelsDecoderBase error: decodeRegion is not implemented"}}t.exports=r},{}],24:[function(e,t,i){"use strict";function r(e){e=e||{};var t=this;t._maxActiveFetchesInChannel=e.maxActiveFetchesInChannel||2,t._gridFetcherBaseCache=[],t._dataListeners=[],t._terminatedListeners=[],t._pendingFetchHandles=new s,t._isReady=!0,t._activeFetches=0,t._resolveClose=null,t._rejectClose=null}t.exports=r;var a=e("gridimagebase"),s=e("linkedlist.js"),n=e("simplefetchadapterfetchhandle.js");r.prototype.fetchTile=function(e,t,i,r){throw"imageDecoderFramework error: GridFetcherBase.fetchTile is not implemented by inheritor"},r.prototype.getImageParams=function(){throw"imageDecoderFramework error: GridFetcherBase.getImageParams is not implemented by inheritor"},r.prototype.open=function(e){throw"imageDecoderFramework error: GridFetcherBase.open is not implemented by inheritor"},r.prototype.close=function(e){this._ensureReady(),this._isReady=!1;var t=this;return new Promise(function(e,i){t._resolveClose=e,t._rejectClose=i,t._checkIfClosed()})},r.prototype.on=function(e,t){switch(e){case"data":this._dataListeners.push(t);break;case"tileTerminated":this._terminatedListeners.push(t);break;default:throw"imageDecoderFramework error: Unexpected event "+e+'. Expected "data" or "tileTerminated"'}},r.prototype.fetch=function(e){return this.startMovableFetch(e,{})},r.prototype.startMovableFetch=function(e,t){return this._ensureReady(),t.activeFetchesInChannel=[],t.pendingFetch=null,t.isPendingFetchStopped=!1,this.moveFetch(e,t)},r.prototype.moveFetch=function(e,t){this._ensureReady();var i=new n(e,this,t),r={handle:i,singleListenerCount:0,state:t,imagePartParams:e,pendingIterator:this._pendingFetchHandles.add(i),tileListeners:[]};return t.pendingFetch&&(this._pendingFetchHandles.remove(t.pendingFetch.pendingIterator),t.pendingFetch.handle._onTerminated()),t.pendingFetch=r,this._startAndTerminateFetches(t),i},r.prototype._ensureReady=function(){if(!this._isReady)throw"imageDecoderFramework error: fetch client is not opened"},r.prototype._checkIfClosed=function(){if(!(this._activeFetches>0||this._isReady)){this._resolveClose();for(var e=this._pendingFetchHandles.getFirstIterator();null!==e;){var t=this._pendingFetchHandles.getValue(e);e=this._pendingFetchHandles.getNextIterator(e),t._onTerminated()}}},r.prototype._startAndTerminateFetches=function(e){var t=e.activeFetchesInChannel.length;null===e.pendingFetch&&--t;for(var i=t-1;i>=0;--i){var r=e.activeFetchesInChannel[i];if(0===r.singleListenerCount){this._pendingFetchHandles.remove(r.pendingIterator),r.handle._onTerminated(),--this._activeFetches,e.activeFetchesInChannel.splice(i,1);for(var s=0;s<r.tileListeners.length;++s){var n=r.tileListeners[s];if(n.listeners.remove(n.iterator),1===n.listeners.getCount()){var o=n.listeners.getFirstIterator(),h=n.listeners.getValue(o);++h.singleListenerCount}}}}if(this._checkIfClosed(),this._isReady){var l=e.pendingFetch;if(!(e.activeFetchesInChannel.length>=this._maxActiveFetchesInChannel||null===l||e.isPendingFetchStopped)){e.pendingFetch=null,e.activeFetchesInChannel.push(l),++this._activeFetches;for(var c=a.getTilesRange(this.getImageParams(),l.imagePartParams),d=c.minTileX;d<c.maxTileX;++d)for(var u=c.minTileY;u<c.maxTileY;++u)this._loadTile(d,u,l)}}},r.prototype._loadTile=function(e,t,i){var r=this._addToCache(e,t,i),a=!1,s=i.imagePartParams.level,n={fetchWaitTask:!0,tileX:e,tileY:t,level:s},o=this;this.fetchTile(s,e,t,{onData:function(e){if(a)throw"imageDecoderFramework error: already terminated in GridFetcherBase.fetchTile()";for(var t=0;t<o._dataListeners.length;++t)o._dataListeners[t]({tileKey:n,tileContent:e},i.imagePartParams)},onTerminated:function(){if(a)throw"imageDecoderFramework error: double termination in GridFetcherBase.fetchTile()";o._gridFetcherBaseCache[i.imagePartParams.level][e][t]=null;for(var s=0;s<o._terminatedListeners.length;++s)o._terminatedListeners[s](n);if(1===r.getCount()){var h=r.getFirstIterator(),l=r.getValue(h);--l.singleListenerCount,o._startAndTerminateFetches(l.state)}}})},r.prototype._addToCache=function(e,t,i){var r=this._gridFetcherBaseCache[i.imagePartParams.level];r||(r=[],this._gridFetcherBaseCache[i.imagePartParams.level]=r);var a=r[e];a||(a=[],r[e]=a);var n=a[t];if(n||(n=new s,a[t]=n,++i.singleListenerCount),1!==n.getCount())return i.tileListeners.push({listeners:n,iterator:n.add(i)}),n;var o=n.getFirstIterator(),h=n.getValue(o);return i.tileListeners.push({listeners:n,iterator:n.add(i)}),--h.singleListenerCount,this._startAndTerminateFetches(h.state),n}},{gridimagebase:25,"linkedlist.js":13,"simplefetchadapterfetchhandle.js":26}],25:[function(e,t,i){"use strict";function r(e){this._fetchManager=e,this._imageParams=null,this._waitingFetches={},this._fetchManager.on("data",this._onDataFetched.bind(this)),this._fetchManager.on("tileTerminated",this._onTileTerminated.bind(this))}t.exports=r;var a=0,s=1;r.prototype.getDecodeWorkerTypeOptions=function(){throw"imageDecoderFramework error: GridImageBase.getDecodeWorkerTypeOptions is not implemented by inheritor"},r.prototype.getDecoderWorkers=function(){throw"imageDecoderFramework error: GridImageBase.getDecoderWorkers is not implemented by inheritor"},r.prototype.decodeTaskStarted=function(e){var t=this;e.on("allDependTasksTerminated",function(){t.dataReadyForDecode(e),e.terminate()})},r.prototype.getFetchManager=function(){return this._fetchManager},r.prototype.getLevelWidth=function(e){var t=this._fetchManager.getImageParams();return t.imageWidth*Math.pow(2,e-t.imageLevel)},r.prototype.getLevelHeight=function(e){var t=this._fetchManager.getImageParams();return t.imageHeight*Math.pow(2,e-t.imageLevel)},r.prototype.getLevel=function(e){var t=this._fetchManager.getImageParams(),i=Math.log(2),r=Math.log(e.screenWidth/(e.maxXExclusive-e.minX))/i,a=Math.log(e.screenHeight/(e.maxYExclusive-e.minY))/i,s=Math.ceil(Math.min(r,a));return s+=t.imageLevel},r.prototype.getWorkerTypeOptions=function(e){if(e===a)return null;if(e===s)return this.getDecodeWorkerTypeOptions();throw"imageDecoderFramework internal error: GridImageBase.getTaskTypeOptions got unexpected task type "+e},r.prototype.getKeyAsString=function(e){return e.fetchWaitTask?"fetchWait:"+e.tileX+","+e.tileY+":"+e.level:JSON.stringify(e)},r.prototype.taskStarted=function(e){if(e.key.fetchWaitTask){var t=this.getKeyAsString(e.key);return void(this._waitingFetches[t]=e)}null===this._imageParams&&(this._imageParams=this._fetchManager.getImageParams());
for(var i=e.key,a=r.getTilesRange(this._imageParams,i),s=a.minTileX;s<a.maxTileX;++s)for(var n=a.minTileY;n<a.maxTileY;++n)e.registerTaskDependency({fetchWaitTask:!0,tileX:s,tileY:n,level:i.level});this.decodeTaskStarted(e)},r.prototype.dataReadyForDecode=function(e){e.dataReady({tileContents:e.dependTaskResults,tileIndices:e.dependTaskKeys,imagePartParams:e.key,tileWidth:this._imageParams.tileWidth,tileHeight:this._imageParams.tileHeight},s)},r.prototype._onDataFetched=function(e){var t=this.getKeyAsString(e.tileKey),i=this._waitingFetches[t];i&&i.dataReady(e.tileContent,a)},r.prototype._onTileTerminated=function(e){var t=this.getKeyAsString(e),i=this._waitingFetches[t];i&&(i.terminate(),this._waitingFetches[t]=null)},r.getTilesRange=function(e,t){var i=e.imageWidth*Math.pow(2,t.level-e.imageLevel),r=e.imageHeight*Math.pow(2,t.level-e.imageLevel),a=i/e.tileWidth,s=r/e.tileHeight;return{minTileX:Math.max(0,Math.floor(t.minX/e.tileWidth)),minTileY:Math.max(0,Math.floor(t.minY/e.tileHeight)),maxTileX:Math.min(a,Math.ceil(t.maxXExclusive/e.tileWidth)),maxTileY:Math.min(s,Math.ceil(t.maxYExclusive/e.tileHeight))}}},{}],26:[function(e,t,i){"use strict";function r(e,t,i){this._imagePartParams=e,this._parentFetcher=t,this._parentFetchState=i,this._stopPromise=null,this._terminatedListeners=[],this._isTerminated=!1,this._isDisposed=!1}t.exports=r,r.prototype._onTerminated=function(e){if(this._isTerminated)throw"imageDecoderFramework error: FetchHandle double terminate";this._isTerminated=!0;for(var t=0;t<this._terminatedListeners.length;++t)this._terminatedListeners[t](e)},r.prototype.stopAsync=function(){if(this._isTerminated)throw"imageDecoderFramework error: FetchHandle double terminate";if(null!==this._parentFetchState.pendingFetch||this._parentFetchState.pendingFetch.handle===this)return this._parentFetchState.isPendingFetchStopped=!0,Promise.resolve();if(null!==this._stopPromise){var e=this;this._stopPromise=new Promise(function(t,i){e.on("terminated",t)})}return this._stopPromise},r.prototype.setIsProgressive=function(e){},r.prototype.on=function(e,t){if("terminated"!==e)throw"imageDecoderFramework error: FetchHandle.on with unsupported event "+e+". Only terminated event is supported";this._terminatedListeners.push(t)},r.prototype.resume=function(){if(this._isTerminated)throw"imageDecoderFramework error: cannot resume stopped FetchHandle";if(null===this._parentFetchState.pendingFetch||this._parentFetchState.pendingFetch.handle!==this||!this._parentFetchState.isPendingFetchStopped)throw"imageDecoderFramework error: FetchHandle is not stopped or already terminated";this._parentFetchState.isPendingFetchStopped=!1,this._parentFetcher._startAndTerminateFetches(this._parentFetchState)},r.prototype.dispose=function(){if(!this._isTerminated)throw"imageDecoderFramework error: cannot dispose non-terminated FetchHandle";if(this._isDisposed)throw"imageDecoderFramework error: FetchHandle double dispose";this._isDisposed=!0}},{}]},{},[20])(20)});