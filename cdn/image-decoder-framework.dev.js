var t=r();self.asyncProxyScriptBlob=new t;
function r(){function a(){this.h=["'use strict';"];this.$=this.B=null;this.f(r,"BlobScriptGenerator");this.m("var asyncProxyScriptBlob = new BlobScriptGenerator();")}a.prototype.f=function(c,b){if(this.B)throw Error("Cannot add member to AsyncProxyScriptBlob after blob was used");b&&(this.h.push("var "),this.h.push(b),this.h.push(" = "));this.h.push("(");this.h.push(c.toString());this.h.push(")();")};a.prototype.m=function(c){if(this.B)throw Error("Cannot add statement to AsyncProxyScriptBlob after blob was used");this.h.push(c)};
a.prototype.getBlob=function(){this.B||(this.B=new Blob(this.h,{type:"application/javascript"}));return this.B};a.prototype.eb=function(){this.$||(this.$=URL.createObjectURL(this.getBlob()));return this.$};return a};function u(){function a(e){if(null===b)throw"AsyncProxy internal error: SubWorkerEmulationForChrome not initialized";this.T=++c;b[this.T]=this;self.postMessage({type:"subWorkerCtor",v:this.T,pb:e})}var c=0,b=null;a.hb=function(c){b=c};a.prototype.postMessage=function(b,c){self.postMessage({type:"subWorkerPostMessage",v:this.T,data:b},c)};a.prototype.terminate=function(b,c){self.postMessage({type:"subWorkerTerminate",v:this.T},c)};self.asyncProxyScriptBlob.f(u,"SubWorkerEmulationForChrome");return a}
var v=u();function w(){function a(M,e,f,d){var m=this;d=d||{};var h=c.toString(),h=h.replace("SCRIPT_PLACEHOLDER",g.eb()),h=URL.createObjectURL(new Blob(["(",h,")()"],{type:"application/javascript"}));m.c=[];m.F=[];m.fa=[];m.ga=[];m.W=new Worker(h);m.W.onmessage=function(c){b(m,c)};m.ia=null;m.O=0;m.qa=d.functionsBufferSize||5;m.da=[];m.W.postMessage({ka:"ctor",qb:M,bb:e,u:f,b:++n,Ha:!1,kb:a.Ba()})}function c(){importScripts("SCRIPT_PLACEHOLDER");AsyncProxy.AsyncProxySlave=self.AsyncProxy.AsyncProxySlaveSingleton;
AsyncProxy.AsyncProxySlave.Ta()}function b(b,c){var a=c.data.b;switch(c.data.type){case "functionCalled":--b.O;d(b);break;case "promiseResult":var f=b.F[a];delete b.F[a];f.resolve(c.data.result);break;case "promiseFailure":f=b.F[a];delete b.F[a];f.reject(c.data.reason);break;case "userData":null!==b.ia&&b.ia(c.data.Ab);break;case "callback":a=b.c[c.data.b];if(void 0===a)throw"Unexpected message from SlaveWorker of callback ID: "+c.data.b+". Maybe should indicate isMultipleTimesCallback = true on creation?";
a.la||b.Aa(b.c[c.data.b]);null!==a.ya&&a.ya.apply(null,c.data.u);break;case "subWorkerCtor":var a=new Worker(c.data.pb),g=c.data.v;b.fa[g]=a;b.ga.push(a);a.onmessage=function(c){e(b,c.ports,!1,{ka:"subWorkerOnMessage",v:g,data:c.data})};break;case "subWorkerPostMessage":a=b.fa[c.data.v];a.postMessage(c.data.data);break;case "subWorkerTerminate":a=b.fa[c.data.v];a.terminate();break;default:throw"Unknown message from AsyncProxySlave of type: "+c.data.type;}}function e(b,c,a,e){b.O>=b.qa?b.da.push({zb:c,
ib:a,message:e}):f(b,c,a,e)}function f(b,c,a,e){a&&++b.O;b.W.postMessage(e,c)}function d(b){for(;b.O<b.qa&&0<b.da.length;){var c=b.da.shift();f(b,c.zb,c.ib,c.message)}}var g=self.asyncProxyScriptBlob,n=0,h=!1,l=function(){var b=location.href,c=b.lastIndexOf("/");0<=c&&(b=b.substring(0,c));return b}();a.prototype.wb=function(b){this.ia=b};a.prototype.terminate=function(){this.W.terminate();for(var b=0;b<this.ga.length;++b)this.ga[b].terminate()};a.prototype.xa=function(b,c,a){a=a||{};var d=!!a.isReturnPromise,
g=a.transferables,h=a.pathsToTransferablesInPromiseResult,k=++n,l=null,q=this;d&&(l=new Promise(function(b,c){q.F[k]={resolve:b,reject:c}}));(a.isSendImmediately?f:e)(this,g,!0,{ka:b,u:c||[],b:k,Ha:d,ob:h});if(d)return l};a.prototype.Bb=function(b,c,a){a=a||{};var e=++n;c={jb:!0,la:!!a.isMultipleTimeCallback,b:e,ab:c,Ja:a.pathsToTransferables};this.c[e]={la:!!a.isMultipleTimeCallback,b:e,ya:b,Ja:a.pathsToTransferables};return c};a.prototype.Aa=function(b){delete this.c[b.b]};a.Ba=function(){h=!0;
return l};a.Wa=function(b){if(l!==b&&h)throw"Previous values returned from getMasterEntryUrl is wrong. Avoid calling it within the slave c`tor";l=b};g.f(w,"AsyncProxyMaster");return a}var x=w();function y(){function a(){var b;try{for(var c=h.split("."),a=self,f=0;f<c.length;++f)a=a[c[f]];var c=a,d=[null].concat(e(arguments));b=new (Function.prototype.bind.apply(c,d))}catch(g){throw Error("Failed locating class name "+h+": "+g);}return b}function c(b,c){if(void 0!==b){for(var a=Array(b.length),e=0;e<b.length;++e){for(var f=b[e],d=c,g=0;g<f.length;++g)d=d[f[g]];a[e]=d}return a}}function b(b){var c=b.data.ka,e=b.data.u,d=b.data.b,l=b.data.Ha,N=b.data.ob;switch(c){case "ctor":self.AsyncProxy.AsyncProxyMaster.Wa(b.data.kb);
d=b.data.qb;h=b.data.bb;for(var k=0;k<d.length;++k)importScripts(d[k]);g=a.apply(null,e);return;case "subWorkerOnMessage":n[b.data.v].onmessage({data:b.data.data});return}e=Array(b.data.u.length);for(k=0;k<b.data.u.length;++k){var p=b.data.u[k];void 0!==p&&null!==p&&p.jb&&(p=f.Oa(p));e[k]=p}for(var k=g,q;k&&!(q=g[c]);)k=k.__proto__;if(!q)throw"AsyncProxy error: could not find function "+q;e=q.apply(g,e);l&&f.Pa(d,e,N);self.postMessage({type:"functionCalled",b:b.data.b,result:null})}function e(b){for(var c=
Array(b.length),a=0;a<b.length;++a)c[a]=b[a];return c}var f={},d=null,g,n={},h;f.Ta=function(){self.onmessage=b};f.vb=function(b){a=b};f.sb=function(b){d=b};f.rb=function(b){self.postMessage({type:"userData",Ab:b})};f.Pa=function(b,a,e){a.then(function(a){var f=c(e,a);self.postMessage({type:"promiseResult",b:b,result:a},f)})["catch"](function(c){self.postMessage({type:"promiseFailure",b:b,reason:c})})};f.Oa=function(b){var a=!1;return function(){if(a)throw"Callback is called twice but isMultipleTimeCallback = false";
var f=e(arguments);if(null!==d)try{d.call(g,"callback",b.ab,f)}catch(h){console.log("AsyncProxySlave.beforeOperationListener has thrown an exception: "+h)}var l=c(b.Ja,f);self.postMessage({type:"callback",b:b.b,u:f},l);b.la||(a=!0)}};f.ba=function(){return z.ba(Error())};if(void 0===self.Worker){var l=self.SubWorkerEmulationForChrome;l.hb(n);self.Worker=l}self.asyncProxyScriptBlob.f(y,"AsyncProxySlaveSingleton");return f}var A=y();function B(){function a(){this.ea={};this.G=null}a.prototype.$a=function(c){c=a.ba(c);this.ea[c]||(this.ea[c]=!0,this.G=null)};a.prototype.gb=function(){if(null===this.G){this.G=[];for(var c in this.ea)this.G.push(c)}return this.G};a.ba=function(c){var b=c.stack.trim(),a=/at (|[^ ]+ \()([^ ]+):\d+:\d+/.exec(b);if(a&&""!==a[2])return a[2];if((a=(new RegExp(/.+\/(.*?):\d+(:\d+)*$/)).exec(b))&&""!==a[1])return a[1];if(void 0!=c.fileName)return c.fileName;throw"ImageDecoderFramework.js: Could not get current script URL";
};self.asyncProxyScriptBlob.f(B,"ScriptsToImportPool");return a}var z=B();var C=function(){function a(){this.clear()}a.prototype.clear=function(){this.aa={j:null,P:this};this.N={i:null,P:this};this.C=0;this.N.j=this.aa;this.aa.i=this.N};a.prototype.add=function(c,b){if(null===b||void 0===b)b=this.N;this.V(b);++this.C;var a={Za:c,i:b,j:b.j,P:this};a.j.i=a;return b.j=a};a.prototype.remove=function(c){this.V(c);--this.C;c.j.i=c.i;c.i.j=c.j;c.P=null};a.prototype.I=function(c){this.V(c);return c.Za};a.prototype.H=function(){return this.A(this.aa)};a.prototype.A=function(c){this.V(c);
return c.i===this.N?null:c.i};a.prototype.V=function(c){if(c.P!==this)throw"iterator must be of the current LinkedList";};return a}();var D=function(){function a(c){this.L=[];this.M=c}a.prototype.fb=function(c){var b=this.M.getHashCode(c),b=this.L[b];if(!b)return null;for(var a=b.H();null!==a;){var f=b.I(a);if(this.M.isEqual(f.key,c))return f.value;a=b.A(a)}return null};a.prototype.Na=function(c,b){var a=this.M.getHashCode(c),f=this.L[a];f||(f=new C,this.L[a]=f);a={Sa:a,sa:f,s:null};for(a.s=f.H();null!==a.s;){var d=f.I(a.s);if(this.M.isEqual(d.key,c))return{iterator:a,Ga:!1,value:d.value};a.s=f.A(a.s)}d=b();a.s=f.add({key:c,value:d});
return{iterator:a,Ga:!0,value:d}};a.prototype.remove=function(a){a.sa.remove(a.s);0===a.sa.C&&delete this.L[a.Sa]};return a}();function E(){function a(b,a,c,d){this.X=d;this.Ra=a;this.Qa=c;this.Va=b;this.ta=new D(d);this.ja=[];if(!d.createTaskContext)throw"AsyncProxy.DependencyWorkers: No workerInputRetreiver.createTaskContext() method";if(!d.getHashCode)throw"AsyncProxy.DependencyWorkers: No workerInputRetreiver.getHashCode() method";if(!d.isEqual)throw"AsyncProxy.DependencyWorkers: No workerInputRetreiver.isEqual() method";}var c=self.asyncProxyScriptBlob;a.prototype.Ma=function(b,a){var c=this.ta.Na(b,function(){return new F}),
d=c.value,g=new G(d,a);c.Ga&&(d.tb(this.ta,c.iterator),this.Xa(b,d));return g};a.prototype.Xa=function(b,a){taskContext=this.X.createTaskContext(b,{onDataReadyToProcess:function(c){if(a.Z)throw"AsyncProxy.DependencyWorkers: already terminated";a.J?(a.na=c,a.ma=!0):d.wa(a,c,b)},onTerminated:a.nb});a.oa=taskContext;var c=taskContext.dependsOnTasks;if(!taskContext.statusUpdated)throw"AsyncProxy.DependencyWorkers: missing taskContext.statusUpdated()";if(c&&!taskContext.onDependencyTaskResult)throw"AsyncProxy.DependencyWorkers: Cannot accept dependsOnTasks without onDependencyTaskResult in taskContext";
var d=this;a.Y=Array(c.length);for(var g=0;g<c.length;++g){a.Y[g]=!1;var n;(function(b){var g=!1;n=d.Ma(c[b],{onData:function(d){a.oa.onDependencyTaskResult(d,c[b]);a.Y[b]=!0},onTerminated:function(){if(g)throw"AsyncProxy.DependencyWorkers: Double termination";g=!0;a.cb()}})})(g);a.w.push(n)}setTimeout(function(){for(var b=0;b<a.w.length;++b){var d=a.w[b];if(!a.Y[b]&&d.Da())taskContext.onDependencyTaskResult(d.Ca(),c[b])}})};a.prototype.wa=function(b,a,c){var d=this,g;g=0<d.ja.length?d.ja.pop():new x(d.Va,
d.Ra,d.Qa);b.J=!0;b.K();g.xa("start",[a,c],{isReturnPromise:!0}).then(function(a){b.Ea=!0;b.Ia=a;for(var d=b.g,e=d.H();null!=e;){var g=d.I(e),e=d.A(e);g.c.onData(a,c)}return a})["catch"](function(b){console.log("Error in DependencyWorkers' worker: "+b);return b}).then(function(a){d.ja.push(g);if(b.ma){var c=b.na;b.ma=!1;b.na=null;d.wa(b,c);return a}b.J=!1;b.K()})};c.f(E,"DependencyWorkers");return a}var H=E();var G=function I(){function c(b,c){this.a=b;this.ca=0;this.c=c;this.U=b.g.add(this)}c.prototype.Da=function(){return this.a.Ea};c.prototype.Ca=function(){return this.a.Ia};c.prototype.ub=function(b){if(!this.U)throw"AsyncProxy.DependencyWorkers: Already unregistered";b=b>this.a.o?b:this.ca<this.a.o?this.a.o:this.a.Ka();this.a.La(b)};c.prototype.unregister=function(){if(!this.U)throw"AsyncProxy.DependencyWorkers: Already unregistered";this.a.g.remove(this.U);this.U=null;if(0==this.a.g.C)this.a.Z||
(this.a.ended(),this.a.K());else if(this.ca===this.a.o){var b=this.a.Ka();this.a.La(b)}};asyncProxyScriptBlob.f(I,"DependencyWorkersTaskHandle");return c}();var F=function(){function a(){this.Z=!1;this.o=0;this.Ia=null;this.ma=this.J=this.Ea=!1;this.oa=this.na=null;this.w=[];this.g=new C;this.Y=[];this.za=0;this.nb=this.mb.bind(this)}a.prototype.tb=function(a,b){this.Ua=a;this.ua=b};a.prototype.ended=function(){for(var a=this.w,b=0;b<a.length;++b)a[b].unregister();for(a=this.g.H();null!=a;)if(b=this.g.I(a),a=this.g.A(a),b.c.onTerminated)b.c.onTerminated();this.g.clear();this.w=[];this.Ua.remove(this.ua);this.ua=null};a.prototype.La=function(a){if(this.o!==
a){this.o=a;this.K();for(var b=this.w,e=0;e<b.length;++e)b[e].setPriority(a)}};a.prototype.K=function(){this.oa.statusUpdated({o:this.o,hasListeners:0<this.g.C,Fa:!this.J,yb:this.za})};a.prototype.Ka=function(){for(var a=this.g,b=a.H(),e=0;null!=b;)e=a.I(b).ca,b=a.A(b);return e};a.prototype.mb=function(){if(this.Z)throw"AsyncProxy.DependencyWorkers: already terminated";if(this.J)throw"AsyncProxy.DependencyWorkers: Cannot terminate while task is processing. Wait for statusUpdated() callback with isIdle == true";
this.Z=!0;this.ended()};a.prototype.cb=function(){++this.za;this.K()};return a}();function J(){function a(b,a,c,d){this.Ya=b;this.D=a;this.X=c;this.c=d;this.S=null;this.va=[];this.ra=[];this.l=1;this.pa()}var c=self.asyncProxyScriptBlob;Object.defineProperty(a.prototype,"dependsOnTasks",{get:function(){return this.D}});a.prototype.lb=function(b,a){if(1!==this.l)throw"AsyncProxy.PromiseTask: Internal Error: not waiting for tasks depends on";if(null===this.S){this.S=new D(this.X);for(var c=0;c<this.D.length;++c)this.S.Na(this.D[c],function(){return c})}var d=this.S.fb(a);if(null===
d)throw"AsyncProxy.PromiseTask: Task is not depends on key";this.va[d]=b;this.ra[d]||(this.ra[d]=!0)};a.prototype.xb=function(b){!b.hasListeners&&b.Fa?this.ha("No listeners"):1===this.l?this.pa(b):b.Fa&&3===this.l&&this.ha()};a.prototype.pa=function(b){var a=0;b&&(a=b.yb);if(a===this.D.length){var c=this;this.l=2;this.X.preWorkerProcess(this.va,this.D,this.Ya).then(function(a){4!==c.l&&(c.l=3,c.c.onDataReadyToProcess(a))})["catch"](function(a){c.ha(a)})}};a.prototype.ha=function(a){4!==this.l&&(this.l=
4,this.c.onTerminated(a))};c.f(J,"PromiseTask");return a}var K=J();function L(){function a(a,b,d,g){H.call(this,a,b,d,c(g));if(!g.getDependsOnTasks)throw"AsyncProxy.DependencyWorkers: No promiseInputRetreiver.getDependsOnTasks() method";if(!g.preWorkerProcess)throw"AsyncProxy.DependencyWorkers: No promiseInputRetreiver.preWorkerProcess() method";if(!g.getHashCode)throw"AsyncProxy.DependencyWorkers: No promiseInputRetreiver.getHashCode() method";if(!g.isEqual)throw"AsyncProxy.DependencyWorkers: No promiseInputRetreiver.isEqual() method";}function c(a){return{R:a,
createTaskContext:function(a,b){var c=this.R.getDependsOnTasks(a);return new K(a,c,this.R,b)},getHashCode:function(a){return this.R.getHashCode(a)},isEqual:function(a,b){return this.R.isEqual(a,b)}}}var b=self.asyncProxyScriptBlob;a.prototype=Object.create(H.prototype);b.f(L,"PromiseDependencyWorkers");return a}var O=L();function P(){asyncProxyScriptBlob.f(P,"ExportAsyncProxySymbols");asyncProxyScriptBlob.m("ExportAsyncProxySymbols(SubWorkerEmulationForChrome, AsyncProxySlaveSingleton, AsyncProxyMaster, ScriptsToImportPool, DependencyWorkers, DependencyWorkersTaskHandle, PromiseTask, PromiseDependencyWorkers);");asyncProxyScriptBlob.m("self['AsyncProxy']['AsyncProxySlaveSingleton'] = AsyncProxySlaveSingleton;");asyncProxyScriptBlob.m("self['AsyncProxy']['AsyncProxyMaster'] = AsyncProxyMaster;");asyncProxyScriptBlob.m("self['AsyncProxy']['ScriptsToImportPool'] = ScriptsToImportPool;");
asyncProxyScriptBlob.m("self['AsyncProxy']['DependencyWorkers'] = DependencyWorkers;");asyncProxyScriptBlob.m("self['AsyncProxy']['PromiseTask'] = PromiseTask;");asyncProxyScriptBlob.m("self['AsyncProxy']['PromiseDependencyWorkers'] = PromiseDependencyWorkers;");return function(a,c,b,e,f,d,g,n){self.AsyncProxy=self.AsyncProxy||{};a.prototype.postMessage=a.prototype.postMessage;a.prototype.terminate=a.prototype.terminate;c.setSlaveSideCreator=c.vb;c.setBeforeOperationListener=c.sb;c.sendUserDataToMaster=
c.rb;c.wrapPromiseFromSlaveSide=c.Pa;c.wrapCallbackFromSlaveSide=c.Oa;b.prototype.setUserDataHandler=b.prototype.wb;b.prototype.terminate=b.prototype.terminate;b.prototype.callFunction=b.prototype.xa;b.prototype.wrapCallback=b.prototype.Bb;b.prototype.freeCallback=b.prototype.Aa;b.getEntryUrl=b.Ba;e.prototype.addScriptFromErrorWithStackTrace=e.prototype.$a;e.prototype.getScriptsForWorkerImport=e.prototype.gb;f.prototype.startTask=f.prototype.Ma;d.prototype.hasData=d.prototype.Da;d.prototype.getLastData=
d.prototype.Ca;d.prototype.setPriority=d.prototype.ub;d.prototype.unregister=d.prototype.unregister;g.prototype.onDependencyTaskResult=g.prototype.lb;g.prototype.statusUpdated=g.prototype.xb;n.createInputRetreiverWrapper=n.prototype.Cb}}P()(v,A,x,z,H,G,K,O);self.AsyncProxy.AsyncProxySlaveSingleton=A;self.AsyncProxy.AsyncProxyMaster=x;self.AsyncProxy.ScriptsToImportPool=z;self.AsyncProxy.DependencyWorkers=H;self.AsyncProxy.PromiseTask=K;self.AsyncProxy.PromiseDependencyWorkers=O;

var n=function(){function b(d,l){this.K=d;this.g=this.u=l;this.o=Array(this.u);this.J=[]}b.prototype={M:function(d,l){if(0<this.g){--this.g;var b=this.o.pop();void 0===b&&(b=this.K());d(b,l)}else this.J.push({H:d,c:l})},N:function(d){if(0<this.J.length){var b=this.J.pop();b.H(d,b.c)}else this.o.push(d),++this.g},O:function(){return!1},P:function(){return!1}};return b}();var p=function(){function b(){this.D={h:null,F:this};this.v={m:null,F:this};this.l=0;this.v.h=this.D;this.D.m=this.v}b.prototype.add=function(d,b){if(null===b||void 0===b)b=this.v;this.w(b);++this.l;var h={U:d,m:b,h:b.h,F:this};h.h.m=h;return b.h=h};b.prototype.remove=function(d){this.w(d);--this.l;d.h.m=d.m;d.m.h=d.h;d.F=null};b.prototype.G=function(d){this.w(d);return d.U};b.prototype.A=function(){return this.B(this.D)};b.prototype.V=function(){return this.W(this.v)};b.prototype.B=function(d){this.w(d);
return d.m===this.v?null:d.m};b.prototype.W=function(d){this.w(d);return d.h===this.D?null:d.h};b.prototype.w=function(d){if(d.F!==this)throw"iterator must be of the current LinkedList";};return b}();var u=function(){function b(a,e,f,c){c=c||{};this.K=a;this.u=e;this.j=f;this.f=c.showLog;this.R=c.schedulerName;this.I=c.numNewJobs||20;this.S=c.numJobsBeforeRerankOldPriorities||20;this.g=this.u;this.o=Array(this.u);this.T=c.resourcesGuaranteedForHighPriority||0;this.s=">";this.i=0;this.b=[];this.a=new p;this.L=0}function d(a,e){c(a,"tryDequeueNewJobWithHigherPriority() start",1);for(var f=null,k=e,d=[],g=a.a.A();null!==g;){var b=a.a.B(g),l=a.a.G(g),h=a.j.getPriority(l.c);if(0>h)q(a,g),--a.i,l.C(l.c);
else{if(void 0===k||h>k)k=h,f=g;a.f&&(void 0===d[h]?d[h]=1:++d[h])}g=b}g=null;null!==f&&(g=q(a,f),--a.i);if(a.f){f="tryDequeueNewJobWithHigherPriority(): Jobs list:";for(b=0;b<d.length;++b)void 0!==d[b]&&(f+=d[b]+" jobs of priority "+b+";");c(a,f);null!==g&&c(a,"tryDequeueNewJobWithHigherPriority(): dequeued new job of priority "+k)}m(a);c(a,"tryDequeueNewJobWithHigherPriority() end",-1);return g}function l(a,e,f){c(a,"enqueueNewJob() start",1);++a.i;var k=a.a.A();r(a,e,k);a.f&&c(a,"enqueueNewJob(): enqueued job of priority "+
f);a.a.l<=a.I?(m(a),c(a,"enqueueNewJob() end: _newPendingJobsLinkedList is small enough",-1)):(e=a.a.V(),e=q(a,e),h(a,e),m(a),c(a,"enqueueNewJob() end: One job moved from new job list to old job list",-1))}function h(a,e){c(a,"enqueueOldJob() start",1);var f=a.j.getPriority(e.c);0>f?(--a.i,e.C(e.c),c(a,"enqueueOldJob() end: job aborted",-1)):(void 0===a.b[f]&&(a.b[f]=[]),a.b[f].push(e),c(a,"enqueueOldJob() end: job enqueued to old job list",-1))}function v(a,e){c(a,"resourceFreed() start",1);++a.g;
var f=w(a);--a.g;f=d(a,f);if(null!==f)m(a),t(a,f,e),m(a),c(a,"resourceFreed() end: new job scheduled",-1);else if(a.i>a.a.l){for(var k,b=a.b.length-1;0<=b;--b){var g=a.b[b];if(void 0!==g&&0!==g.length){for(var h=g.length-1;0<=h;--h){f=g[h];k=a.j.getPriority(f.c);if(k>=b){g.length=h;break}else 0>k?(--a.i,f.C(f.c)):(void 0===a.b[k]&&(a.b[k]=[]),a.b[k].push(f));f=null}if(null!==f)break;g.length=0}}null===f?(a.o.push(e),++a.g,m(a),c(a,"resourceFreed() end: no non-aborted job to schedule",-1)):(a.f&&c(a,
"resourceFreed(): dequeued old job of priority "+k),--a.i,m(a),t(a,f,e),m(a),c(a,"resourceFreed() end: job scheduled",-1))}else a.o.push(e),++a.g,m(a),c(a,"resourceFreed() end: no job to schedule",-1)}function t(a,e,f){c(a,"schedule() start",1);++a.L;if(a.L>=a.S){a.L=0;c(a,"rerankPriorities() start",1);var b=a.b,d=a.a;if(0===b.length)c(a,"rerankPriorities() end: no need to rerank",-1);else{a.b=[];a.a=new p;for(var g=0;g<b.length;++g)if(void 0!==b[g])for(var l=0;l<b[g].length;++l)h(a,b[g][l]);for(g=
d.A();null!==g;)b=d.G(g),h(a,b),g=d.B(g);d="rerankPriorities(): ";for(g=a.b.length-1;0<=g;--g)if(b=a.b[g],void 0!==b){for(a.f&&(d+=b.length+" jobs in priority "+g+";");0<b.length&&a.a.l<a.I;)l=b.pop(),r(a,l);if(a.a.l>=a.I&&!a.f)break}a.f&&c(a,d);m(a);c(a,"rerankPriorities() end: rerank done",-1)}}a.f&&(g=a.j.getPriority(e.c),c(a,"schedule(): scheduled job of priority "+g));e.H(f,e.c);c(a,"schedule() end",-1)}function r(a,e,f){c(a,"addJobToLinkedList() start",1);a.a.add(e,f);x(a);c(a,"addJobToLinkedList() end",
-1)}function q(a,e){c(a,"extractJobFromLinkedList() start",1);var f=a.a.G(e);a.a.remove(e);x(a);c(a,"extractJobFromLinkedList() end",-1);return f}function x(a){if(a.f){c(a,"ensureNumberOfNodes() start",1);for(var e=a.a.A(),f=0;null!==e;)++f,e=a.a.B(e);if(f!==a.a.l)throw"Unexpected count of new jobs";c(a,"ensureNumberOfNodes() end",-1)}}function m(a){if(a.f){c(a,"ensurePendingJobsCount() start",1);for(var e=0,f=0;f<a.b.length;++f){var b=a.b[f];void 0!==b&&(e+=b.length)}if(e+a.a.l!==a.i)throw"Unexpected count of jobs";
c(a,"ensurePendingJobsCount() end",-1)}}function w(a){c(a,"getMinimalPriorityToSchedule() start",1);if(a.g<=a.T)return c(a,"getMinimalPriorityToSchedule() end: guarantee resource for high priority is needed",-1),a.X;c(a,"getMinimalPriorityToSchedule() end: enough resources, no need to guarantee resource for high priority",-1);return 0}function c(a,e,c){a.f&&(-1===c&&(a.s=a.s.substr(1)),void 0!==a.R?console.log(a.s+"PriorityScheduler "+a.R+": "+e):console.log(a.s+"PriorityScheduler: "+e),1===c&&(a.s+=
">"))}b.prototype={M:function(a,e,b){c(this,"enqueueJob() start",1);var d=this.j.getPriority(e);0>d?(b(e),c(this,"enqueueJob() end: job aborted",-1)):(a={H:a,C:b,c:e},e=w(this),b=null,d>=e&&(c(this,"tryGetFreeResource() start",1),0===this.g?b=null:(--this.g,e=this.o.pop(),void 0===e&&(e=this.K()),m(this),c(this,"tryGetFreeResource() end",-1),b=e)),null!==b?(t(this,a,b),c(this,"enqueueJob() end: job scheduled",-1)):(l(this,a,d),m(this),c(this,"enqueueJob() end: job pending",-1)))},N:function(a,b){if(this.f){var d=
this.j.getPriority(b);c(this,"jobDone() start: job done of priority "+d,1)}v(this,a);m(this);c(this,"jobDone() end",-1)},O:function(a){c(this,"shouldYieldOrAbort() start",1);a=this.j.getPriority(a);var b;if(!(b=0>a))a:{b=this.a.A();for(c(this,"hasNewJobWithHigherPriority() start",1);null!==b;){var d=this.a.B(b),k=this.a.G(b),h=this.j.getPriority(k.c);if(0>h)q(this,b),--this.i,k.C(k.c);else if(h>a){c(this,"hasNewJobWithHigherPriority() end: returns true",-1);b=!0;break a}b=d}c(this,"hasNewJobWithHigherPriority() end: returns false",
-1);b=!1}a=b;c(this,"shouldYieldOrAbort() end",-1);return a},P:function(a,b,f,h,q){c(this,"tryYield() start",1);var g=this.j.getPriority(b);if(0>g)return f(b),v(this,q),c(this,"tryYield() end: job aborted",-1),!0;var r=d(this,g);m(this);if(null===r)return c(this,"tryYield() end: job continues",-1),!1;h(b);l(this,{H:a,C:f,c:b},g);m(this);t(this,r,q);m(this);c(this,"tryYield() end: job yielded",-1);return!0}};return b}();self.ResourceScheduler={};self.ResourceScheduler.PriorityScheduler=u;self.ResourceScheduler.LifoScheduler=n;u.prototype.shouldYieldOrAbort=u.prototype.O;u.prototype.enqueueJob=u.prototype.M;u.prototype.tryYield=u.prototype.P;u.prototype.jobDone=u.prototype.N;n.prototype.shouldYieldOrAbort=n.prototype.O;n.prototype.enqueueJob=n.prototype.M;n.prototype.tryYield=n.prototype.P;n.prototype.jobDone=n.prototype.N;

!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.imageDecoderFramework=e()}}(function(){return function e(t,i,r){function s(n,o){if(!i[n]){if(!t[n]){var h="function"==typeof require&&require;if(!o&&h)return h(n,!0);if(a)return a(n,!0);var l=new Error("Cannot find module '"+n+"'");throw l.code="MODULE_NOT_FOUND",l}var c=i[n]={exports:{}};t[n][0].call(c.exports,function(e){var i=t[n][1][e];return s(i?i:e)},c,c.exports,e,t,i,r)}return i[n].exports}for(var a="function"==typeof require&&require,n=0;n<r.length;n++)s(r[n]);return s}({1:[function(e,t,i){"use strict";function r(e){var t={x:e.scene.canvas.width,y:e.scene.canvas.height},i=[];s(0,0,t.x,t.y,i,e,0);var r=Cesium.Rectangle.fromCartographicArray(i);(r.east<r.west||r.north<r.south)&&(r={east:Math.max(r.east,r.west),west:Math.min(r.east,r.west),north:Math.max(r.north,r.south),south:Math.min(r.north,r.south)});var a=n.calculateFrustum2DFromBounds(r,t);return a}function s(e,t,i,r,n,h,l){var c=0;c+=a(e,t,h,n),c+=a(i,t,h,n),c+=a(e,r,h,n),c+=a(i,r,h,n);var u=o;if(!(4===c||l>=u)){++l;var _=(e+i)/2,d=(t+r)/2;s(e,t,_,d,n,h,l),s(e,d,_,r,n,h,l),s(_,t,i,d,n,h,l),s(_,d,i,r,n,h,l)}}function a(e,t,i,r){var s=new Cesium.Cartesian2(e,t),a=i.scene.mapProjection.ellipsoid,n=i.scene.camera.pickEllipsoid(s,a);if(void 0===n)return 0;var o=a.cartesianToCartographic(n);return void 0===o?0:(r.push(o),1)}t.exports=r;var n=e("imagehelperfunctions.js"),o=4},{"imagehelperfunctions.js":12}],2:[function(e,t,i){"use strict";function r(e,t){this._options=t||{},void 0!==this._options.rectangle&&(this._options=JSON.parse(JSON.stringify(t)),this._options.cartographicBounds={west:t.rectangle.west,east:t.rectangle.east,south:t.rectangle.south,north:t.rectangle.north}),this._options.minFunctionCallIntervalMilliseconds=t.minFunctionCallIntervalMilliseconds||100,this._url=t.url,this._targetCanvas=document.createElement("canvas"),this._imageryProviders=[new s(this._targetCanvas),new s(this._targetCanvas)],this._imageryLayerShown=new Cesium.ImageryLayer(this._imageryProviders[0]),this._imageryLayerPending=new Cesium.ImageryLayer(this._imageryProviders[1]),this._canvasUpdatedCallbackBound=this._canvasUpdatedCallback.bind(this),this._isPendingUpdateCallback=!1,this._isWhileReplaceLayerShown=!1,this._pendingPositionRectangle=null,this._image=new a(e,this._canvasUpdatedCallbackBound,this._options),this._image.setTargetCanvas(this._targetCanvas),this._updateFrustumBound=this._updateFrustum.bind(this),this._postRenderBound=this._postRender.bind(this)}t.exports=r;var s=e("canvasimageryprovider.js"),a=e("viewerimagedecoder.js"),n=e("_cesiumfrustumcalculator.js");r.prototype.setExceptionCallback=function(e){this._image.setExceptionCallback(e)},r.prototype.open=function(e){this._widget=e,this._layers=e.scene.imageryLayers,e.scene.postRender.addEventListener(this._postRenderBound),this._image.open(this._url),this._layers.add(this._imageryLayerShown),this._intervalHandle=setInterval(this._updateFrustumBound,500)},r.prototype.close=function(){this._image.close(),clearInterval(this._intervalHandle),this._layers.remove(this._imageryLayerShown),this._widget.removeEventListener(this._postRenderBound),this._isWhileReplaceLayerShown&&(this._isWhileReplaceLayerShown=!1,this._isPendingUpdateCallback=!1,this._layers.remove(this._imageryLayerPending))},r.prototype.getImageryLayers=function(){return[this._imageryLayerShown,this._imageryLayerPending]},r.prototype._updateFrustum=function(){var e=n(this._widget);null!==e&&this._image.updateViewArea(e)},r.prototype._canvasUpdatedCallback=function(e){if(this._isWhileReplaceLayerShown&&(this._isPendingUpdateCallback=!0,this._pendingPositionRectangle=e),null!==e){var t=new Cesium.Rectangle(e.west,e.south,e.east,e.north);this._imageryProviders[0].setRectangle(t),this._imageryProviders[1].setRectangle(t)}this._removeAndReAddLayer()},r.prototype._removeAndReAddLayer=function(){var e=this._layers.indexOf(this._imageryLayerShown);if(0>e)throw"Layer was removed from viewer's layers  without closing layer manager. Use CesiumImageDecoderLayerManager.close() instead";this._isWhileReplaceLayerShown=!0,this._layers.add(this._imageryLayerPending,e)},r.prototype._postRender=function(){if(this._isWhileReplaceLayerShown){this._isWhileReplaceLayerShown=!1,this._layers.remove(this._imageryLayerShown,!1);var e=this._imageryLayerShown;this._imageryLayerShown=this._imageryLayerPending,this._imageryLayerPending=e,this._isPendingUpdateCallback&&(this._isPendingUpdateCallback=!1,this._canvasUpdatedCallback(this._pendingPositionRectangle))}}},{"_cesiumfrustumcalculator.js":1,"canvasimageryprovider.js":3,"viewerimagedecoder.js":20}],3:[function(e,t,i){"use strict";function r(e,t){if(void 0===t&&(t={}),void 0===e)throw new DeveloperError("canvas is required.");this._canvas=e,this._errorEvent=new Event("CanvasImageryProviderStatus"),this._ready=!1;var i=t.credit;"string"==typeof i&&(i=new Credit(i)),this._credit=i}t.exports=r,r.prototype={get tileWidth(){if(!this._ready)throw new DeveloperError("tileWidth must not be called before the imagery provider is ready.");return this._canvas.width},get tileHeight(){if(!this._ready)throw new DeveloperError("tileHeight must not be called before the imagery provider is ready.");return this._canvas.height},get maximumLevel(){if(!this._ready)throw new DeveloperError("maximumLevel must not be called before the imagery provider is ready.");return 0},get minimumLevel(){if(!this._ready)throw new DeveloperError("minimumLevel must not be called before the imagery provider is ready.");return 0},get tilingScheme(){if(!this._ready)throw new DeveloperError("tilingScheme must not be called before the imagery provider is ready.");return this._tilingScheme},get rectangle(){return this._tilingScheme.rectangle},get tileDiscardPolicy(){if(!this._ready)throw new DeveloperError("tileDiscardPolicy must not be called before the imagery provider is ready.")},get errorEvent(){return this._errorEvent},get ready(){return this._ready},get credit(){return this._credit},get hasAlphaChannel(){return!0}},r.prototype.setRectangle=function(e){this._tilingScheme=new Cesium.GeographicTilingScheme({rectangle:e,numberOfLevelZeroTilesX:1,numberOfLevelZeroTilesY:1}),this._ready||(this._ready=!0,Cesium.TileProviderError.handleSuccess(this._errorEvent))},r.prototype.getTileWidth=function(){return this.tileWidth},r.prototype.getTileHeight=function(){return this.tileHeight},r.prototype.getMaximumLevel=function(){return this.maximumLevel},r.prototype.getMinimumLevel=function(){return this.minimumLevel},r.prototype.isReady=function(){return this.ready},r.prototype.getCredit=function(){return this.credit},r.prototype.getRectangle=function(){return this.tilingScheme.rectangle},r.prototype.getTilingScheme=function(){return this.tilingScheme},r.prototype.getTileDiscardPolicy=function(){return this.tileDiscardPolicy},r.prototype.getErrorEvent=function(){return this.errorEvent},r.prototype.getHasAlphaChannel=function(){return this.hasAlphaChannel},r.prototype.getTileCredits=function(e,t,i){},r.prototype.requestImage=function(e,t,i){if(!this._ready)throw new DeveloperError("requestImage must not be called before the imagery provider is ready.");return this._canvas},r.prototype.pickFeatures=function(){}},{}],4:[function(e,t,i){"use strict";function r(e,t){var i=t.url;if(this._adaptProportions=t.adaptProportions,this._rectangle=t.rectangle,this._proxy=t.proxy,this._updateFrustumInterval=1e3,this._credit=t.credit,"string"==typeof this._credit&&(this._credit=new Credit(this._credit)),void 0===this._rectangle&&(this._rectangle=Cesium.Rectangle.fromDegrees(-180,-90,180,90)),void 0===this._adaptProportions&&(this._adaptProportions=!0),t=JSON.parse(JSON.stringify(t||{})),t.cartographicBounds={west:this._rectangle.west,east:this._rectangle.east,south:this._rectangle.south,north:this._rectangle.north},void 0===i)throw new DeveloperError("url is required.");this._url=i,this._tilingScheme=void 0,this._tileWidth=0,this._tileHeight=0,this._errorEvent=new Event("ImageDecoderImageryProviderStatus"),this._ready=!1,this._exceptionCallback=null,this._cesiumWidget=null,this._updateFrustumIntervalHandle=null;var r=i;void 0!==this._proxy&&(r=this._proxy.getURL(r)),this._image=new a(e,{serverRequestPrioritizer:"frustum",decodePrioritizer:"frustum"}),this._url=r}function s(e){var t=new Cesium.Rectangle(e.west,e.south,e.east,e.north),i=new Cesium.GeographicTilingScheme({rectangle:t,numberOfLevelZeroTilesX:e.levelZeroTilesX,numberOfLevelZeroTilesY:e.levelZeroTilesY});return i}t.exports=r;var a=e("workerproxyimagedecoder.js"),n=e("_cesiumfrustumcalculator.js"),o=e("imagehelperfunctions.js");r.prototype={get url(){return this._url},get proxy(){return this._proxy},get tileWidth(){if(!this._ready)throw new DeveloperError("tileWidth must not be called before the imagery provider is ready.");return this._tileWidth},get tileHeight(){if(!this._ready)throw new DeveloperError("tileHeight must not be called before the imagery provider is ready.");return this._tileHeight},get maximumLevel(){if(!this._ready)throw new DeveloperError("maximumLevel must not be called before the imagery provider is ready.");return this._numResolutionLevels-1},get minimumLevel(){if(!this._ready)throw new DeveloperError("minimumLevel must not be called before the imagery provider is ready.");return 0},get tilingScheme(){if(!this._ready)throw new DeveloperError("tilingScheme must not be called before the imagery provider is ready.");return this._tilingScheme},get rectangle(){return this._tilingScheme.rectangle},get tileDiscardPolicy(){if(!this._ready)throw new DeveloperError("tileDiscardPolicy must not be called before the imagery provider is ready.")},get errorEvent(){return this._errorEvent},get ready(){return this._ready},get credit(){return this._credit},get hasAlphaChannel(){return!0}},r.prototype.setExceptionCallback=function(e){this._exceptionCallback=e},r.prototype.open=function(e){if(null!==this._updateFrustumIntervalHandle)throw new DeveloperError("Cannot set two parent viewers.");if(void 0===e)throw new DeveloperError("widgetOrViewer should be given. It is needed for frustum calculation for the priority mechanism");this._image.open(this._url).then(this._opened.bind(this))["catch"](this._onException.bind(this)),this._cesiumWidget=e,this._updateFrustumIntervalHandle=setInterval(this._setPriorityByFrustum.bind(this),this._updateFrustumInterval)},r.prototype.close=function(){clearInterval(this._updateFrustumIntervalHandle),this._image.close()},r.prototype.getTileWidth=function(){return this.tileWidth},r.prototype.getTileHeight=function(){return this.tileHeight},r.prototype.getMaximumLevel=function(){return this.maximumLevel},r.prototype.getMinimumLevel=function(){return this.minimumLevel},r.prototype.getUrl=function(){return this.url},r.prototype.getProxy=function(){return this.proxy},r.prototype.isReady=function(){return this.ready},r.prototype.getCredit=function(){return this.credit},r.prototype.getRectangle=function(){return this.tilingScheme.rectangle},r.prototype.getTilingScheme=function(){return this.tilingScheme},r.prototype.getTileDiscardPolicy=function(){return this.tileDiscardPolicy},r.prototype.getErrorEvent=function(){return this.errorEvent},r.prototype.getHasAlphaChannel=function(){return this.hasAlphaChannel},r.prototype.getTileCredits=function(e,t,i){},r.prototype.requestImage=function(e,t,i){function r(e){var t=e.imageData.width,i=e.imageData.height;t>0&&i>0&&y.putImageData(e.imageData,e.xInOriginalRequest,e.yInOriginalRequest)}function s(e){e?C("Fetch request or decode aborted"):(p.drawImage(f,0,0,g,v,_.croppedScreen.minX,_.croppedScreen.minY,_.croppedScreen.maxXExclusive,_.croppedScreen.maxYExclusive),T(m))}if(!this._ready)throw new DeveloperError("requestImage must not be called before the imagery provider is ready.");var a=this,n=Math.pow(2,this._numResolutionLevels-i-1),h=e*this._tileWidth*n,l=t*this._tileHeight*n,c=(e+1)*this._tileWidth*n,u=(t+1)*this._tileHeight*n,_=o.alignParamsToTilesAndLevel({minX:h,minY:l,maxXExclusive:c,maxYExclusive:u,screenWidth:this._tileWidth,screenHeight:this._tileHeight},this._image),d=_.imagePartParams.level,m=(this._image.getLevelWidth(d),this._image.getLevelHeight(d),document.createElement("canvas"));m.width=this._tileWidth,m.height=this._tileHeight;var p=m.getContext("2d");p.clearRect(0,0,this._tileWidth,this._tileHeight);var g=_.imagePartParams.maxXExclusive-_.imagePartParams.minX,v=_.imagePartParams.maxYExclusive-_.imagePartParams.minY;if(0>=g||0>=v)return m;var f=document.createElement("canvas");f.width=g,f.height=v;var y=f.getContext("2d");y.clearRect(0,0,g,v),_.imagePartParams.quality=this._quality,_.imagePartParams.requestPriorityData={imageRectangle:this._rectangle};var T,C,E=new Promise(function(e,t){T=e,C=t,a._image.requestPixelsProgressive(_.imagePartParams,r,s)});return E},r.prototype._setPriorityByFrustum=function(){if(this._ready){var e=n(this._cesiumWidget,this);null!==e&&(e.imageRectangle=this.getRectangle(),e.exactlevel=null,this._image.setServerRequestPrioritizerData(e),this._image.setDecodePrioritizerData(e))}},r.prototype.pickFeatures=function(){},r.prototype._onException=function(e){null!==this._exceptionCallback&&this._exceptionCallback(e)},r.prototype._opened=function(){if(this._ready)throw"ImageDecoderImageryProvider error: opened() was called more than once!";this._ready=!0,this._numResolutionLevels=this._image.getNumResolutionLevelsForLimittedViewer(),this._quality=this._image.getHighestQuality();var e=this._numResolutionLevels-1;this._tileWidth=this._image.getTileWidth(),this._tileHeight=this._image.getTileHeight();var t=this._image.getImageLevel(),i=this._image.getLevelWidth(t),r=this._image.getLevelHeight(t),a=Math.ceil(i/this._tileWidth)>>e,n=Math.ceil(r/this._tileHeight)>>e;o.fixBounds(this._rectangle,this._image,this._adaptProportions);var h=this._rectangle.east-this._rectangle.west,l=this._rectangle.north-this._rectangle.south,c=1<<e,u=this._tileWidth*a*c,_=this._tileHeight*n*c,d=h*u/i,m=l*_/r,p=this._rectangle.west+d,g=this._rectangle.north-m;this._tilingSchemeParams={west:this._rectangle.west,east:p,south:g,north:this._rectangle.north,levelZeroTilesX:a,levelZeroTilesY:n,maximumLevel:e},this._tilingScheme=s(this._tilingSchemeParams),Cesium.TileProviderError.handleSuccess(this._errorEvent)}},{"_cesiumfrustumcalculator.js":1,"imagehelperfunctions.js":12,"workerproxyimagedecoder.js":18}],5:[function(e,t,i){"use strict";function r(e,t){l.call(this,e),this._options=t||{},this._optionsWebWorkers=n.createInternalOptions(e,this._options);var i=this._options.workersLimit||5;this._tileWidth=this._options.tileWidth||256,this._tileHeight=this._options.tileHeight||256,this._showLog=!!this._options.showLog,this._channelStates=[],this._decoders=[],this._fetchManager=new a(this._optionsWebWorkers);var r=n.createScheduler(this._showLog,this._options.decodePrioritizer,"decode",this._createDecoder.bind(this),i);this._decodePrioritizer=r.prioritizer,this._requestsDecodeJobsPool=new o(this._fetchManager,r.scheduler,this._tileWidth,this._tileHeight,!1),this._channelsDecodeJobsPool=new o(this._fetchManager,r.scheduler,this._tileWidth,this._tileHeight,!0)}function s(e,t){var i=4,r=e.width*i,s=e.originalRequestWidth*i;if(void 0===t.pixels){var a=s*e.originalRequestHeight;t.pixels=new Uint8Array(a),t.xInOriginalRequest=0,t.yInOriginalRequest=0;var n=e.originalRequestWidth;t.originalRequestWidth=n,t.width=n;var o=e.originalRequestHeight;t.originalRequestHeight=o,t.height=o}t.allRelevantBytesLoaded=e.allRelevantBytesLoaded;for(var h=0,l=e.xInOriginalRequest*i+e.yInOriginalRequest*s,c=0;c<e.height;++c){var u=e.pixels.subarray(h,h+r);t.pixels.set(u,l),h+=r,l+=s}}t.exports=r;var a=e("workerproxyfetchmanager.js"),n=e("imageHelperFunctions.js"),o=e("decodejobspool.js"),h=e("workerproxypixelsdecoder.js"),l=e("imageparamsretrieverproxy.js");r.prototype=Object.create(l.prototype),r.prototype.getTileWidth=function(){return this._validateSizesCalculator(),this._tileWidth},r.prototype.getTileHeight=function(){return this._validateSizesCalculator(),this._tileHeight},r.prototype.setServerRequestPrioritizerData=function(e){this._fetchManager.setServerRequestPrioritizerData(e)},r.prototype.setDecodePrioritizerData=function(e){if(null===this._decodePrioritizer)throw"No decode prioritizer has been set";this._showLog&&console.log("setDecodePrioritizerData("+e+")");var t=Object.create(e);t.image=this,this._decodePrioritizer.setPrioritizerData(t)},r.prototype.open=function(e){var t=this;return this._fetchManager.open(e).then(function(e){return t._internalSizesParams=e,{sizesParams:e,applicativeTileWidth:t.getTileWidth(),applicativeTileHeight:t.getTileHeight()}})},r.prototype.close=function(){for(var e=0;e<this._decoders.length;++e)this._decoders[e].terminate();return this._fetchManager.close()},r.prototype.createChannel=function(e){function t(t){i._channelStates[t]={decodeJobsListenerHandle:null},e(t)}this._validateSizesCalculator();var i=this;this._fetchManager.createChannel(t)},r.prototype.requestPixels=function(e){function t(t,s){a=t,n=s,u._requestsDecodeJobsPool.forkDecodeJobs(e,i,r,h,l,!1)}function i(e){s(e,c)}function r(e){e?n("Request was aborted due to failure or priority"):a(c)}this._validateSizesCalculator();var a,n,o=e.level,h=this._sizesCalculator.getLevelWidth(o),l=this._sizesCalculator.getLevelHeight(o),c={},u=this,_=new Promise(t);return _},r.prototype.requestPixelsProgressive=function(e,t,i,r,s){this._validateSizesCalculator();var a,n=e.level,o=this._sizesCalculator.getLevelWidth(n),h=this._sizesCalculator.getLevelHeight(n),l=null;if(void 0===s)a=this._requestsDecodeJobsPool;else if(a=this._channelsDecodeJobsPool,l=this._channelStates[s],void 0===l)throw"Channel handle does not exist";var c=a.forkDecodeJobs(e,t,i,o,h,!0,r);void 0!==s&&(null!==l.decodeJobsListenerHandle&&a.unregisterForkedJobs(l.decodeJobsListenerHandle),l.decodeJobsListenerHandle=c,this._fetchManager.moveChannel(s,e))},r.prototype.reconnect=function(){this._fetchManager.reconnect()},r.prototype.alignParamsToTilesAndLevel=function(e){return n.alignParamsToTilesAndLevel(e,this)},r.prototype._getSizesParamsInternal=function(){return this._internalSizesParams},r.prototype._createDecoder=function(){var e=new h(this._optionsWebWorkers);return this._decoders.push(e),e}},{"decodejobspool.js":7,"imageHelperFunctions.js":12,"imageparamsretrieverproxy.js":15,"workerproxyfetchmanager.js":17,"workerproxypixelsdecoder.js":19}],6:[function(e,t,i){"use strict";function r(e,t,i,r){this._isAborted=!1,this._isTerminated=!1,this._isFetchRequestTerminated=!1,this._isFirstStage=!0,this._isManuallyAborted=!1,this._firstDecodeInput=null,this._pendingDecodeInput=null,this._activeSubJobs=1,this._imagePartParams=e,this._decodeScheduler=i,this._jobSequenceId=0,this._lastFinishedJobSequenceId=-1,this._progressiveStagesDone=0,this._listenersLinkedList=new s,this._progressiveListenersCount=0,this._requestId=++a,this._allRelevantBytesLoaded=0,this._fetchManager=t,this._startDecodeBound=this._startDecode.bind(this),this._decodeAbortedBound=this._decodeAborted.bind(this),t.createRequest(e,this,this._dataReadyForDecode,this._fetchTerminated,r,this._requestId)}t.exports=r;var s=e("linkedlist.js"),a=0;r.prototype.registerListener=function(e){var t=this._listenersLinkedList.add(e);e.isProgressive&&(++this._progressiveListenersCount,1===this._progressiveListenersCount&&this._fetchManager.setIsProgressiveRequest(this._requestId,!0));var i=t;return i},r.prototype.unregisterListener=function(e){var t=e,i=this._listenersLinkedList.getValue(t);this._listenersLinkedList.remove(e),i.isProgressive&&--this._progressiveListenersCount,0===this._listenersLinkedList.getCount()?(this._fetchManager.manualAbortRequest(this._requestId),this._isAborted=!0,this._isTerminated=!0,this._isFetchRequestTerminated=!0,this._isManuallyAborted=!0):0===this._progressiveListenersCount&&this._fetchManager.setIsProgressiveRequest(this._requestId,!1)},r.prototype.getIsTerminated=function(){return this._isTerminated},r.prototype._dataReadyForDecode=function(e){if(!this._isAbortedNoTermination()&&0!==this._listenersLinkedList.getCount()){if(this._isFirstStage)this._firstDecodeInput={dataForDecode:e};else{if(this._pendingDecodeInput={dataForDecode:e},this._isAlreadyScheduledNonFirstJob)return;this._isAlreadyScheduledNonFirstJob=!0}if(this._isTerminated)throw"Job has already been terminated";this._isFirstStage=!1,++this._activeSubJobs;var t={self:this,imagePartParams:this._imagePartParams,progressiveStagesDone:this._progressiveStagesDone};this._decodeScheduler.enqueueJob(this._startDecodeBound,t,this._decodeAbortedBound)}},r.prototype._startDecode=function(e,t){function i(i){n._pixelsDecodedCallback(e,i,s,t),n=null}var r;if(null!==this._firstDecodeInput?(r=this._firstDecodeInput,this._firstDecodeInput=null):(r=this._pendingDecodeInput,this._pendingDecodeInput=null,this._isAlreadyScheduledNonFirstJob=!1),t.allRelevantBytesLoaded=r.dataForDecode.allRelevantBytesLoaded,this._isAbortedNoTermination())return--this._activeSubJobs,this._decodeScheduler.jobDone(e,t),void this._checkIfAllTerminated();var s=++this._jobSequenceId,a=this._imagePartParams;a.maxXExclusive-a.minX,a.maxYExclusive-a.minY;e.decode(r.dataForDecode).then(i);var n=this},r.prototype._pixelsDecodedCallback=function(e,t,i,r){this._decodeScheduler.jobDone(e,r),--this._activeSubJobs;var s=r.allRelevantBytesLoaded-this._allRelevantBytesLoaded;if(this._allRelevantBytesLoaded=r.allRelevantBytesLoaded,this._isAbortedNoTermination())return void this._checkIfAllTerminated();var a=this._lastFinishedJobSequenceId;if(a>i)return void this._checkIfAllTerminated();this._lastFinishedJobSequenceId=i;for(var n=this._imagePartParams,o=this._listenersLinkedList.getFirstIterator();null!==o;){var h=this._listenersLinkedList.getValue(o),l=h.imagePartParams,c=n.minX-l.minX,u=n.minY-l.minY,_=l.maxXExclusive-l.minX,d=l.maxYExclusive-l.minY;h.allRelevantBytesLoaded+=s;var m={originalRequestWidth:_,originalRequestHeight:d,xInOriginalRequest:c,yInOriginalRequest:u,imageData:t,allRelevantBytesLoaded:h.allRelevantBytesLoaded};h.callback(m),o=this._listenersLinkedList.getNextIterator(o)}this._checkIfAllTerminated()},r.prototype._fetchTerminated=function(e){if(!this._isManuallyAborted){if(this._isFetchRequestTerminated)throw"Double termination of fetch request";this._isFetchRequestTerminated=!0,--this._activeSubJobs,this._isAborted|=e,this._checkIfAllTerminated()}},r.prototype._decodeAborted=function(e){this._isAborted=!0,null!==this._firstDecodeInput?this._firstDecodeInput=null:(this._pendingDecodeInput=null,this._isAlreadyScheduledNonFirstJob=!1),--this._activeSubJobs,this._checkIfAllTerminated()},r.prototype._isAbortedNoTermination=function(){if(!this._isManuallyAborted){if(this._isTerminated)throw"Unexpected job state of terminated: Still runnin sub-jobs";return this._isAborted}},r.prototype._checkIfAllTerminated=function(){if(this._activeSubJobs<0)throw"Inconsistent number of decode jobs";if(!(this._activeSubJobs>0)){if(this._isAlreadyScheduledNonFirstJob)throw"Inconsistent isAlreadyScheduledNonFirstJob flag";this._isTerminated=!0;var e=this._listenersLinkedList;this._listenersLinkedList=null;for(var t=e.getFirstIterator();null!==t;){var i=e.getValue(t);i.isAnyDecoderAborted|=this._isAborted;var r=--i.remainingDecodeJobs;if(0>r)throw"Inconsistent number of done requests";var s=0===r;s&&(i.isTerminatedCallbackCalled=!0,i.terminatedCallback(i.isAnyDecoderAborted)),t=e.getNextIterator(t)}}}},{"linkedlist.js":13}],7:[function(e,t,i){"use strict";function r(e,t,i,r,s){this._tileWidth=i,this._tileHeight=r,this._activeRequests=[],this._onlyWaitForDataAndDecode=s,this._fetchManager=e,this._decodeScheduler=t}function s(e,t,i,r,s){if(void 0===s)return!1;for(var a=0;a<s.length;++a){var n=s[a],o=e>=n.minX&&i<=n.maxXExclusive,h=t>=n.minY&&r<=n.maxYExclusive;if(o&&h)return!0}return!1}function a(e,t,i){var r=e[t];return void 0===r&&(r=i,e[t]=r),r}t.exports=r;var n=e("decodejob.js");r.prototype.forkDecodeJobs=function(e,t,i,r,o,h,l){var c=e.minX,u=e.minY,_=e.maxXExclusive,d=e.maxYExclusive,m=e.level||0,p=e.quality,g=e.requestPriorityData,v=c%this._tileWidth===0&&u%this._tileHeight===0,f=_%this._tileWidth===0||_===r,y=d%this._tileHeight===0||d===o,T=_>c&&d>u;if(!(v&&f&&y&&T))throw"imagePartParams for decoders is not aligned to tile size or not in valid order";for(var C=a(this._activeRequests,m,[]),E=a(C,e.quality,[]),b=Math.ceil((_-c)/this._tileWidth),P=Math.ceil((d-u)/this._tileHeight),S={imagePartParams:e,callback:t,terminatedCallback:i,remainingDecodeJobs:b*P,isProgressive:h,isAnyDecoderAborted:!1,isTerminatedCallbackCalled:!1,allRelevantBytesLoaded:0,unregisterHandles:[]},x=c;_>x;x+=this._tileWidth)for(var w=a(E,x,[]),I=Math.min(x+this._tileWidth,r),D=u;d>D;D+=this._tileHeight){var L=Math.min(D+this._tileHeight,o),R=s(x,D,I,L,l);if(R)--S.remainingDecodeJobs;else{var A=a(w,D,{});if(void 0===A.job||A.job.getIsTerminated()){var F={minX:x,minY:D,maxXExclusive:I,maxYExclusive:L,level:m,quality:p,requestPriorityData:g};A.job=new n(F,this._fetchManager,this._decodeScheduler,this._onlyWaitForDataAndDecode)}var H=A.job.registerListener(S);S.unregisterHandles.push({unregisterHandle:H,job:A.job})}}return S.isTerminatedCallbackCalled||0!==S.remainingDecodeJobs||(S.isTerminatedCallbackCalled=!0,S.terminatedCallback(S.isAnyDecoderAborted)),S},r.prototype.unregisterForkedJobs=function(e){if(0!==e.remainingDecodeJobs)for(var t=0;t<e.unregisterHandles.length;++t){var i=e.unregisterHandles[t];i.job.getIsTerminated()||i.job.unregisterListener(i.unregisterHandle)}}},{"decodejob.js":6}],8:[function(e,t,i){"use strict";function r(e,t,i,s){this._fetcher=e,this._scheduler=t,this._dataListeners=[],this._terminatedListeners=[],this._imagePartParams=null,this._progressiveStagesDone=0,this._state=r.FETCH_STATUS_WAIT_FOR_FETCH_CALL,this._isChannel=i===r.FETCH_TYPE_CHANNEL,this._contextVars=s,this._isOnlyWaitForData=i===r.FETCH_TYPE_ONLY_WAIT_FOR_DATA,this._useScheduler=i===r.FETCH_TYPE_REQUEST,this._imageDataContext=null,this._resource=null,this._fetchHandle=null,i===r.FETCH_TYPE_CHANNEL?this._movableFetchState={}:this._movableFetchState=null}function s(e,t){if(null!==t._imageDataContext||null!==t._resource)throw"Unexpected restart of already started request";if(t._state===r.FETCH_STATUS_REQUEST_ABOUT_TO_ABORT)return void t._fetchTerminated(!0);if(t._state!==r.FETCH_STATUS_REQUEST_WAIT_FOR_SCHEDULE)throw"Unexpected state on schedule: "+t._state;t._resource=e,t._startFetch()}function a(e,t){if(t.isChannel)throw"Unexpected call to continueYieldedRequest on channel";if(t._state===r.FETCH_STATUS_REQUEST_ABOUT_TO_ABORT||t._state===r.FETCH_STATUS_UNEXPECTED_FAILURE)return void t._scheduler.jobDone(e,t);if(t._state===r.FETCH_STATUS_REQUEST_YIELDED_PENDING_NEW_DATA)t._hasNewData();else if(t._state!==r.FETCH_STATUS_REQUEST_YIELDED)throw"Unexpected request state on continue: "+t._state;t._state=r.FETCH_STATUS_ACTIVE,t._resource=e,t._fetchHandle.resume()}function n(e){switch(e._resource=null,e._state){case r.FETCH_STATUS_REQUEST_ABOUT_TO_YIELD_PENDING_NEW_DATA:e._state=r.FETCH_STATUS_REQUEST_YIELDED_PENDING_NEW_DATA;break;case r.FETCH_STATUS_REQUEST_ABOUT_TO_YIELD:e._state=r.FETCH_STATUS_REQUEST_YIELDED;break;default:throw e._state=r.FETCH_STATUS_UNEXPECTED_FAILURE,"Unexpected request state on yield process: "+e._state}}function o(e){e._resource=null,e._fetchTerminated(!0)}t.exports=r,r.FETCH_TYPE_REQUEST=1,r.FETCH_TYPE_CHANNEL=2,r.FETCH_TYPE_ONLY_WAIT_FOR_DATA=3,r.FETCH_STATUS_WAIT_FOR_FETCH_CALL=1,r.FETCH_STATUS_REQUEST_WAIT_FOR_SCHEDULE=2,r.FETCH_STATUS_ACTIVE=3,r.FETCH_STATUS_REQUEST_ABOUT_TO_YIELD=4,r.FETCH_STATUS_REQUEST_ABOUT_TO_YIELD_PENDING_NEW_DATA=5,r.FETCH_STATUS_REQUEST_YIELDED=6,r.FETCH_STATUS_REQUEST_YIELDED_PENDING_NEW_DATA=7,r.FETCH_STATUS_REQUEST_ABOUT_TO_ABORT=8,r.FETCH_STATUS_REQUEST_TERMINATED=9,r.FETCH_STATUS_UNEXPECTED_FAILURE=10,r.prototype.fetch=function(e){if(this._isChannel)return null!==this._imageDataContext&&this._imageDataContext.dispose(),this._imagePartParams=e,void this._startFetch();if(null!==this._imagePartParams)throw'Cannot fetch twice on fetch type of "request"';if(this._state!==r.FETCH_STATUS_WAIT_FOR_FETCH_CALL)throw this._state=r.FETCH_STATUS_UNEXPECTED_FAILURE,"Unexpected state on fetch(): "+this._state;return this._imagePartParams=e,this._state=r.FETCH_STATUS_REQUEST_WAIT_FOR_SCHEDULE,this._useScheduler?void this._scheduler.enqueueJob(s,this,o):void s(null,this)},r.prototype.manualAbortRequest=function(){switch(this._state){case r.FETCH_STATUS_REQUEST_TERMINATED:case r.FETCH_STATUS_UNEXPECTED_FAILURE:return;case r.FETCH_STATUS_REQUEST_ABOUT_TO_ABORT:throw"Double call to manualAbortRequest()";case r.FETCH_STATUS_ACTIVE:var e=this;this._state=r.FETCH_STATUS_REQUEST_ABOUT_TO_ABORT,e._isOnlyWaitForData?e._fetchTerminated(!0):this._fetchHandle.stopAsync().then(function(){e._fetchTerminated(!0)});break;case r.FETCH_STATUS_WAIT_FOR_FETCH_CALL:return void(this._state=r.FETCH_STATUS_REQUEST_TERMINATED);case r.FETCH_STATUS_REQUEST_WAIT_FOR_SCHEDULE:case r.FETCH_STATUS_REQUEST_ABOUT_TO_YIELD:case r.FETCH_STATUS_REQUEST_ABOUT_TO_YIELD_PENDING_NEW_DATA:case r.FETCH_STATUS_REQUEST_YIELDED:case r.FETCH_STATUS_REQUEST_YIELDED_PENDING_NEW_DATA:this._state=r.FETCH_STATUS_REQUEST_ABOUT_TO_ABORT;break;default:throw"Unknown state in manualAbortRequest() implementation: "+this._state}},r.prototype.getContextVars=function(e){return this._contextVars},r.prototype.on=function(e,t){switch(e){case"data":this._dataListeners.push(t);break;case"terminated":this._terminatedListeners.push(t);break;default:throw"Unexpected event "+e}},r.prototype.setIsProgressive=function(e){this._isProgressive=e,null!==this._imageDataContext&&this._imageDataContext.setIsProgressive(e)},r.prototype.getIsProgressive=function(){return this._isProgressive},r.prototype._startFetch=function(){var e=this._fetcher.createImageDataContext(this._imagePartParams),t=this._state;if(this._imageDataContext=e,this._imageDataContext.setIsProgressive(this._isProgressive),this._state=r.FETCH_STATUS_ACTIVE,e.isDone()){for(var i=0;i<this._dataListeners.length;++i)this._dataListeners[i].call(this,this._contextVars,e);return void this._fetchTerminated(!1)}if(e.hasData())for(var s=0;s<this._dataListeners.length;++s)this._dataListeners[s].call(this,this._contextVars,e);var a=this;e.on("data",function(){a._dataCallback(e)}),this._isOnlyWaitForData||(this._isChannel?t!==r.FETCH_STATUS_WAIT_FOR_FETCH_CALL?this._fetcher.moveFetch(e,this._movableFetchState):this._fetcher.startMovableFetch(e,this._movableFetchState):this._fetchHandle=this._fetcher.fetch(e))},r.prototype._fetchTerminated=function(e){switch(this._state){case r.FETCH_STATUS_REQUEST_ABOUT_TO_ABORT:break;case r.FETCH_STATUS_ACTIVE:case r.FETCH_STATUS_REQUEST_ABOUT_TO_YIELD:case r.FETCH_STATUS_REQUEST_ABOUT_TO_YIELD_PENDING_NEW_DATA:if(e)throw this._state=r.FETCH_STATUS_UNEXPECTED_FAILURE,"Unexpected abort when fetch is active";break;default:throw"Unexpected state on fetch terminated: "+this._state}if(null!==this._resource){if(e)throw"Unexpected request termination without resource allocated";this._scheduler.jobDone(this._resource,this),this._resource=null}else if(!e&&this._useScheduler)throw"Job expected to have resource on successful termination";if(!this._isChannel){this._state=r.FETCH_STATUS_REQUEST_TERMINATED;for(var t=0;t<this._terminatedListeners.length;++t)this._terminatedListeners[t](this._contextVars,this._imageDataContext,e)}null!==this._imageDataContext&&this._state!==r.FETCH_STATUS_UNEXPECTED_FAILURE&&(this._imageDataContext.dispose(),this._imageDataContext=null)},r.prototype._dataCallback=function(e){try{if(e!==this._imageDataContext)throw"Unexpected imageDataContext";switch(++this._progressiveStagesDone,this._state){case r.FETCH_STATUS_ACTIVE:break;case r.FETCH_STATUS_REQUEST_ABOUT_TO_YIELD:
return void(this._state=r.FETCH_STATUS_REQUEST_ABOUT_TO_YIELD_PENDING_NEW_DATA);case r.FETCH_STATUS_REQUEST_YIELDED:return void(this._state=r.FETCH_STATUS_REQUEST_YIELDED_PENDING_NEW_DATA);case r.FETCH_STATUS_REQUEST_ABOUT_TO_YIELD_PENDING_NEW_DATA:case r.FETCH_STATUS_REQUEST_YIELDED_PENDING_NEW_DATA:case r.FETCH_STATUS_UNEXPECTED_FAILURE:case r.FETCH_STATUS_REQUEST_ABOUT_TO_ABORT:return;default:throw"Unexpected state in data callback: "+this._state}if(this._hasNewData(),!this._useScheduler||this._state===r.FETCH_STATUS_REQUEST_TERMINATED)return;if(null===this._resource)throw"No resource allocated but fetch callback called";if(!this._scheduler.shouldYieldOrAbort(this._resource))return;this._state=r.FETCH_STATUS_REQUEST_ABOUT_TO_YIELD;var t=this;this._fetchHandle.stopAsync().then(function(){if(t._fetchState===r.FETCH_STATUS_REQUEST_ABOUT_TO_ABORT)return void t._fetchTerminated(!0);var e=t._scheduler.tryYield(a,t,o,n,t._resource);if(!e){if(t._state===r.FETCH_STATUS_REQUEST_ABOUT_TO_YIELD_PENDING_NEW_DATA)t._hasNewData();else if(t._state!==r.FETCH_STATUS_REQUEST_ABOUT_TO_YIELD)throw"Unexpected state on tryYield() false: "+t._state;t._state=r.FETCH_STATUS_ACTIVE,t._fetchHandle.resume()}})["catch"](function(){t._state=r.FETCH_STATUS_UNEXPECTED_FAILURE,o(t)})}catch(i){this._state=r.FETCH_STATUS_UNEXPECTED_FAILURE,o(this)}},r.prototype._hasNewData=function(){for(var e=0;e<this._dataListeners.length;++e)this._dataListeners[e].call(this,this._contextVars,this._imageDataContext);this._imageDataContext.isDone()&&this._fetchTerminated(!1)},Object.defineProperty(r.prototype,"imagePartParams",{get:function(){return this._imagePartParams}}),Object.defineProperty(r.prototype,"progressiveStagesDone",{get:function(){return this._progressiveStagesDone}})},{}],9:[function(e,t,i){"use strict";function r(e){c.call(this,e.imageImplementationClassName);var t=e.serverRequestsLimit||5;if(this._fetcher=null,this._internalSizesParams=null,this._showLog=e.showLog,this._showLog)throw"showLog is not supported on this browser";var i=h.createScheduler(e.showLog,e.serverRequestPrioritizer,"serverRequest",o,t);this._serverRequestPrioritizer=i.prioritizer,this._scheduler=i.scheduler,this._channelHandleCounter=0,this._channelHandles=[],this._requestById=[]}function s(e,t){var i=e.fetchJob.getIsProgressive(),r=0===e.progressiveStagesDone;if(e.isLastCallbackCalledWithoutLowQualityLimit|=i&&!r,i){var s=r?e.self.getLowestQuality():void 0;++e.progressiveStagesDone,n(e,t,s)}}function a(e,t,i){e.isLastCallbackCalledWithoutLowQualityLimit||i||n(e,t),e.terminatedCallback.call(e.callbackThis,i),delete e.self._requestById[e.requestId]}function n(e,t,i){var r=t.getFetchedData(i);e.callback.call(e.callbackThis,r)}function o(){return{}}t.exports=r;var h=e("imagehelperfunctions.js"),l=e("fetchjob.js"),c=e("imageparamsretrieverproxy.js");r.prototype=Object.create(c.prototype),r.prototype.open=function(e){var t=this._imageImplementation.createFetcher(e,{isReturnPromise:!0}),i=this;return t.then(function(e){return i._fetcher=e.fetcher,i._internalSizesParams=e.sizesParams,e.sizesParams})},r.prototype.close=function(){return this._fetcher.close({isReturnPromise:!0})},r.prototype.setIsProgressiveRequest=function(e,t){var i=this._requestById[e];return void 0===i?null:void i.setIsProgressive(t)},r.prototype.createChannel=function(e){var t=++this._channelHandleCounter;this._channelHandles[t]=new l(this._fetcher,this._scheduler,l.FETCH_TYPE_CHANNEL,null),e(t)},r.prototype.moveChannel=function(e,t){var i=this._channelHandles[e];i.fetch(t)},r.prototype.createRequest=function(e,t,i,r,n,o){var h={progressiveStagesDone:0,isLastCallbackCalledWithoutLowQualityLimit:!1,callbackThis:t,callback:i,terminatedCallback:r,requestId:o,fetchJob:null,self:this},c=n?l.FETCH_TYPE_ONLY_WAIT_FOR_DATA:l.FETCH_TYPE_REQUEST,u=new l(this._fetcher,this._scheduler,c,h);if(h.fetchJob=u,void 0!==this._requestById[o])throw"Duplication of requestId "+o;void 0!==o&&(this._requestById[o]=u),u.on("data",s),u.on("terminated",a),u.fetch(e)},r.prototype.manualAbortRequest=function(e){var t=this._requestById[e];void 0!==t&&(t.manualAbortRequest(),delete this._requestById[e])},r.prototype.reconnect=function(){this._fetcher.reconnect()},r.prototype.setServerRequestPrioritizerData=function(e){if(null===this._serverRequestPrioritizer)throw"No serverRequest prioritizer has been set";this._showLog&&console.log("setServerRequestPrioritizerData("+e+")"),e.image=this,this._serverRequestPrioritizer.setPrioritizerData(e)},r.prototype._getSizesParamsInternal=function(){return this._internalSizesParams}},{"fetchjob.js":8,"imagehelperfunctions.js":12,"imageparamsretrieverproxy.js":15}],10:[function(e,t,i){"use strict";function r(e,t){this._frustumData=null,this._isAbortRequestsNotInFrustum=e,this._isPrioritizeLowProgressiveStage=t}t.exports=r;var s=-1,a=0,n=1,o=2,h=3,l=4,c=5,u=6,_=7,d=5,m=13;Math.log(2);Object.defineProperty(r.prototype,"minimalLowQualityPriority",{get:function(){return l+d}}),r.prototype.setPrioritizerData=function(e){this._frustumData=e},r.prototype.getPriority=function(e){var t=e.imagePartParams;if(t.requestPriorityData.overrideHighestPriority)return m;var i=this._getPriorityInternal(t),r=i>=l;if(this._isAbortRequestsNotInFrustum&&!r)return s;var a=0;if(this._isPrioritizeLowProgressiveStage&&r){if(void 0===e.progressiveStagesDone)throw"Missing progressive stage information";a=0===e.progressiveStagesDone?d:1===e.progressiveStagesDone?1:0}return i+a},r.prototype._getPriorityInternal=function(e){if(null===this._frustumData)return a;if(void 0===this._frustumData.imageRectangle)throw"No imageRectangle information passed in setPrioritizerData";var t=this._frustumData.exactlevel;if(void 0===this._frustumData.exactlevel)throw"No exactlevel information passed in setPrioritizerData. Use null if unknown";var i,r=this._pixelToCartographicX(e.minX,e),s=this._pixelToCartographicX(e.maxXExclusive,e),d=this._pixelToCartographicY(e.minY,e),m=this._pixelToCartographicY(e.maxYExclusive,e),p=e.maxXExclusive-e.minX,g=e.maxYExclusive-e.minY,v=e.level||0;if(null===t){var f=p/(s-r),y=g/(d-m),T=Math.max(f,y),C=this._frustumData.resolution;if(i=T/C,i>2)return n}else if(t>v)return n;var E=this._frustumData.rectangle,b=Math.max(E.west,r),P=Math.min(E.east,s),S=Math.max(E.south,m),x=Math.min(E.north,d),w=P-b,I=x-S;if(0>w||0>I)return o;if(null!==t){if(v>t)return h}else if(v>0&&.25>i)return h;var D=w*I,L=(s-r)*(d-m),R=D/L;return R>.99?_:R>.7?u:R>.3?c:l},r.prototype._pixelToCartographicX=function(e,t){var i=e/this._frustumData.image.getLevelWidth(t.level),r=this._frustumData.imageRectangle,s=r.east-r.west,a=r.west+i*s;return a},r.prototype._pixelToCartographicY=function(e,t,i){var r=e/this._frustumData.image.getLevelHeight(t.level),s=this._frustumData.imageRectangle,a=s.north-s.south,n=s.north-r*a;return n}},{}],11:[function(e,t,i){"use strict";function r(e){this._byKey=[],this._hasher=e}t.exports=r;var s=e("linkedlist.js");r.prototype.getFromKey=function(e){var t=this._hasher.getHashCode(e),i=this._byKey[t];if(!i)return null;for(var r=i.getFirstIterator();null!==r;){var s=i.getValue(r);if(this._hasher.isEqual(s.key,e))return s.value;r=i.getNextIterator(r)}return null},r.prototype.getFromIterator=function(e){return e._hashElements.getValue(e._internalIterator).value},r.prototype.tryAdd=function(e,t){var i=this._hasher.getHashCode(e),r=this._byKey[i];r||(r=new s,this._byKey[i]=r);var a={_hashCode:i,_hashElements:r,_internalIterator:null};for(a._internalIterator=r.getFirstIterator();null!==a._internalIterator;){var n=r.getValue(a._internalIterator);if(this._hasher.isEqual(n.key,e))return{iterator:a,isNew:!1,value:n.value};a._internalIterator=r.getNextIterator(a._internalIterator)}var o=t();return a._internalIterator=r.add({key:e,value:o}),{iterator:a,isNew:!0,value:o}},r.prototype.remove=function(e){e._hashElements.remove(e._internalIterator),0===e._hashElements.getCount()&&delete this._byKey[e._hashCode]}},{"linkedlist.js":13}],12:[function(e,t,i){"use strict";function r(e,t){var i=t.x*t.x+t.y*t.y,r=e.east-e.west,s=e.north-e.south,a=r*r+s*s,n=Math.sqrt(i/a),o={resolution:n,rectangle:e,screenSize:t};return o}function s(e,t,i,r,s){var a,n;if(void 0===t)a=null,n=new ResourceScheduler.LifoScheduler(r,s);else{var o=!1;"frustum"===t?(o=!0,a=new u):"frustumOnly"===t?(o=!0,a=new u(!0,!0)):a=t;var h={schedulerName:i,showLog:e};o&&(h.resourceGuaranteedForHighPriority=s-2,h.highPriorityToGuaranteeResource=a.minimalLowQualityPriority),n=new ResourceScheduler.PriorityScheduler(r,s,a,h)}return{prioritizer:a,scheduler:n}}function a(e,t,i){if(i){var r=e.east-e.west,s=e.north-e.south,a=t.getImageLevel(),n=t.getLevelWidth(a)/t.getLevelHeight(a),o=r/s;if(o>n){var h=r;r=s*n;var l=h-r;e.east-=l/2,e.west+=l/2}else{var c=s;s=r/n;var u=c-s;e.north-=u/2,e.south+=u/2}}}function n(e,t){var i=t._getSizesCalculator(),r=t.getTileWidth(),s=t.getTileHeight(),a=e.minX,n=e.minY,o=e.maxXExclusive,h=e.maxYExclusive,l=e.screenWidth,c=e.screenHeight,u=o>a&&h>n;if(!u)throw"Parameters order is invalid";var _=i.getImageLevel(),d=i.getLevelWidth(_),m=i.getLevelHeight(_);if(0>o||a>=d||0>h||n>=m)return null;var p=i.getLevel(e),g=i.getLevelWidth(p),v=i.getLevelHeight(p),f=d/g,y=m/v,T=Math.floor(a/(f*r)),C=Math.floor(n/(y*s)),E=Math.ceil(o/(f*r)),b=Math.ceil(h/(y*s)),P=T*r,S=C*s,x=E*r,w=b*s,I=Math.max(0,Math.min(g,P)),D=Math.max(0,Math.min(v,S)),L=Math.max(0,Math.min(g,x)),R=Math.max(0,Math.min(v,w)),A=l/(x-P),F=c/(w-S),H={minX:I,minY:D,maxXExclusive:L,maxYExclusive:R,level:p},U={minX:I*f,minY:D*y,maxXExclusive:L*f,maxYExclusive:R*y},k={minX:Math.floor((I-P)*A),minY:Math.floor((D-S)*F),maxXExclusive:Math.ceil((L-P)*A),maxYExclusive:Math.ceil((R-S)*F)};return{imagePartParams:H,positionInImage:U,croppedScreen:k}}function o(e){var t;try{if(t=h(window,e))return t}catch(i){}try{if(t=h(globals,e))return t}catch(i){}try{if(t=h(self,e))return t}catch(i){}}function h(e,t){if(e[t])return e[t];for(var i=e,r=t.split("."),s=0;s<r.length;++s)i=i[r[s]];return i}function l(e,t){return d.concat(e.getScriptsToImport())}function c(e,t){if(t=t||{},t.imageImplementationClassName&&t.scriptsToImport)return t;var i=o(e),r=JSON.parse(JSON.stringify(t));return r.imageImplementationClassName=t.imageImplementationClassName||e,r.scriptsToImport=t.scriptsToImport||l(i,t),r}var u=e("frustumrequestsprioritizer.js");t.exports={calculateFrustum2DFromBounds:r,createScheduler:s,fixBounds:a,alignParamsToTilesAndLevel:n,getImageImplementation:o,getScriptsForWorkerImport:l,createInternalOptions:c};var _=new AsyncProxy.ScriptsToImportPool;_.addScriptFromErrorWithStackTrace(new Error);var d=_.getScriptsForWorkerImport()},{"frustumrequestsprioritizer.js":10}],13:[function(e,t,i){"use strict";function r(){this._first={_prev:null,_parent:this},this._last={_next:null,_parent:this},this._count=0,this._last._prev=this._first,this._first._next=this._last}t.exports=r,r.prototype.add=function(e,t){null!==t&&void 0!==t||(t=this._last),this._validateIteratorOfThis(t),++this._count;var i={_value:e,_next:t,_prev:t._prev,_parent:this};return i._prev._next=i,t._prev=i,i},r.prototype.remove=function(e){this._validateIteratorOfThis(e),--this._count,e._prev._next=e._next,e._next._prev=e._prev,e._parent=null},r.prototype.getValue=function(e){return this._validateIteratorOfThis(e),e._value},r.prototype.getFirstIterator=function(){var e=this.getNextIterator(this._first);return e},r.prototype.getLastIterator=function(){var e=this.getPrevIterator(this._last);return e},r.prototype.getNextIterator=function(e){return this._validateIteratorOfThis(e),e._next===this._last?null:e._next},r.prototype.getPrevIterator=function(e){return this._validateIteratorOfThis(e),e._prev===this._first?null:e._prev},r.prototype.getCount=function(){return this._count},r.prototype._validateIteratorOfThis=function(e){if(e._parent!==this)throw"iterator must be of the current LinkedList"}},{}],14:[function(e,t,i){"use strict";function r(){AsyncProxy.AsyncProxySlave.setSlaveSideCreator(function(){var e=new Array(arguments.length+1);e[0]=null;for(var t=0;t<arguments.length;++t)e[t+1]=arguments[t];var i=new(Function.prototype.bind.apply(imageDecoderFramework.ImageDecoder,e));return i})}e("imagedecoder.js");t.exports.getScriptUrl=function(){return a};var s=new Blob(["(",r.toString(),")()"],{type:"application/javascript"}),a=URL.createObjectURL(s)},{"imagedecoder.js":5}],15:[function(e,t,i){"use strict";function r(e){this._imageImplementation=s.getImageImplementation(e),this._sizesParams=null,this._sizesCalculator=null}t.exports=r;var s=e("imagehelperfunctions.js");r.prototype.getImageLevel=function(){this._validateSizesCalculator();var e=this._sizesCalculator.getImageLevel();return e},r.prototype.getNumResolutionLevelsForLimittedViewer=function(){this._validateSizesCalculator();var e=this._sizesCalculator.getNumResolutionLevelsForLimittedViewer();return e},r.prototype.getLevelWidth=function(e){this._validateSizesCalculator();var t=this._sizesCalculator.getLevelWidth(e);return t},r.prototype.getLevelHeight=function(e){this._validateSizesCalculator();var t=this._sizesCalculator.getLevelHeight(e);return t},r.prototype.getLevel=function(e){this._validateSizesCalculator();var t=this._sizesCalculator.getLevel(e);return t},r.prototype.getLowestQuality=function(){this._validateSizesCalculator();var e=this._sizesCalculator.getLowestQuality();return e},r.prototype.getHighestQuality=function(){this._validateSizesCalculator();var e=this._sizesCalculator.getHighestQuality();return e},r.prototype._getSizesCalculator=function(){return this._validateSizesCalculator(this),this._sizesCalculator},r.prototype._getSizesParams=function(){if(!this._sizesParams&&(this._sizesParams=this._getSizesParamsInternal(),!this._sizesParams))throw"getSizesParams() return falsy value; Maybe image not ready yet?";return this._sizesParams},r.prototype._getSizesParamsInternal=function(){throw"ImageParamsRetrieverProxy implemented did not implement _getSizesParamsInternal()"},r.prototype._validateSizesCalculator=function(){if(null===this._sizesCalculator){var e=this._getSizesParams();this._sizesCalculator=this._imageImplementation.createImageParamsRetriever(e)}}},{"imagehelperfunctions.js":12}],16:[function(e,t,i){"use strict";function r(){function e(e,i,r){if("callback"===e&&"statusCallback"===i){if(t||!r[0].isReady)return null;var s={sizesParams:this._getSizesParams()};this.getTileWidth&&(s.applicativeTileWidth=this.getTileWidth()),this.getTileHeight&&(s.applicativeTileHeight=this.getTileHeight()),AsyncProxy.AsyncProxySlave.sendUserDataToMaster(s),t=!0}}var t=!1;AsyncProxy.AsyncProxySlave.setBeforeOperationListener(e)}t.exports.getScriptUrl=function(){return a};var s=new Blob(["(",r.toString(),")()"],{type:"application/javascript"}),a=URL.createObjectURL(s)},{}],17:[function(e,t,i){"use strict";function r(e){a.call(this,e.imageImplementationClassName),this._imageWidth=null,this._imageHeight=null,this._internalSizesParams=null,this._options=e;var t=[e],i=e.scriptsToImport.concat([s.getScriptUrl()]);this._workerHelper=new AsyncProxy.AsyncProxyMaster(i,"imageDecoderFramework.Internals.FetchManager",t);var r=this._userDataHandler.bind(this);this._workerHelper.setUserDataHandler(r)}t.exports=r;var s=(e("imagehelperfunctions.js"),e("sendimageparameterstomaster.js")),a=e("imageparamsretrieverproxy.js");r.prototype=Object.create(a.prototype),r.prototype.open=function(e){return this._workerHelper.callFunction("open",[e],{isReturnPromise:!0})},r.prototype.close=function(){var e=this;return this._workerHelper.callFunction("close",[],{isReturnPromise:!0}).then(function(){e._workerHelper.terminate()})},r.prototype.createChannel=function(e){var t=this._workerHelper.wrapCallback(e,"FetchManager_createChannelCallback"),i=[t];this._workerHelper.callFunction("createChannel",i)},r.prototype.moveChannel=function(e,t){var i=[e,t];this._workerHelper.callFunction("moveChannel",i)},r.prototype.createRequest=function(e,t,i,r,s,a){function n(e){u._workerHelper.freeCallback(h),r.call(t,e)}var o=this._options.transferablePathsOfRequestCallback,h=this._workerHelper.wrapCallback(i.bind(t),"requestTilesProgressiveCallback",{isMultipleTimeCallback:!0,pathsToTransferables:o}),l=this._workerHelper.wrapCallback(n,"requestTilesProgressiveTerminatedCallback",{isMultipleTimeCallback:!1}),c=[e,{dummyThis:"dummyThis"},h,l,s,a],u=this;this._workerHelper.callFunction("createRequest",c)},r.prototype.manualAbortRequest=function(e){var t=[e];this._workerHelper.callFunction("manualAbortRequest",t)},r.prototype.setIsProgressiveRequest=function(e,t){var i=[e,t];this._workerHelper.callFunction("setIsProgressiveRequest",i)},r.prototype.setServerRequestPrioritizerData=function(e){this._workerHelper.callFunction("setServerRequestPrioritizerData",[e],{isSendImmediately:!0})},r.prototype.reconnect=function(){this._workerHelper.callFunction("reconnect")},r.prototype._getSizesParamsInternal=function(){return this._internalSizesParams},r.prototype._userDataHandler=function(e){this._internalSizesParams=e.sizesParams}},{"imagehelperfunctions.js":12,"imageparamsretrieverproxy.js":15,"sendimageparameterstomaster.js":16}],18:[function(e,t,i){"use strict";function r(e,t){o.call(this,e),this._imageWidth=null,this._imageHeight=null,this._tileWidth=0,this._tileHeight=0,this._sizesCalculator=null;var i=s.createInternalOptions(e,t),r=[e,i],h=s.getScriptsForWorkerImport(this._imageImplementation,t);h=h.concat([a.getScriptUrl(),n.getScriptUrl()]),this._workerHelper=new AsyncProxy.AsyncProxyMaster(h,"imageDecoderFramework.ImageDecoder",r);var l=this._imageOpened.bind(this);this._workerHelper.setUserDataHandler(l)}t.exports=r;var s=e("imagehelperfunctions.js"),a=e("sendimageparameterstomaster.js"),n=e("createimagedecoderonslaveside.js"),o=e("imageparamsretrieverproxy.js");r.prototype=Object.create(o.prototype),r.prototype.getTileWidth=function(){return this._validateSizesCalculator(),this._tileWidth},r.prototype.getTileHeight=function(){return this._validateSizesCalculator(),this._tileHeight},r.prototype.open=function(e){var t=this;return this._workerHelper.callFunction("open",[e],{isReturnPromise:!0}).then(function(e){return t._imageOpened(e),e})},r.prototype.close=function(){return this._workerHelper.callFunction("close",[],{isReturnPromise:!0})},r.prototype.createChannel=function(e){var t=this._workerHelper.wrapCallback(e,"ImageDecoder_createChannelCallback"),i=[t];this._workerHelper.callFunction("createChannel",i)},r.prototype.requestPixels=function(e){var t=["data","buffer"],i=[t],r=[e];this._workerHelper.callFunction("requestPixels",r,{isReturnPromise:!0,pathsToTransferablesInPromiseResult:i})},r.prototype.requestPixelsProgressive=function(e,t,i,r,s){function a(e){c._workerHelper.freeCallback(o),i(e)}var n,o=this._workerHelper.wrapCallback(t,"requestPixelsProgressiveCallback",{isMultipleTimeCallback:!0,pathsToTransferables:n}),h=this._workerHelper.wrapCallback(a,"requestPixelsProgressiveTerminatedCallback",{isMultipleTimeCallback:!1}),l=[e,o,h,r,s];this._workerHelper.callFunction("requestPixelsProgressive",l);var c=this},r.prototype.setServerRequestPrioritizerData=function(e){this._workerHelper.callFunction("setServerRequestPrioritizerData",[e],{isSendImmediately:!0})},r.prototype.setDecodePrioritizerData=function(e){this._workerHelper.callFunction("setDecodePrioritizerData",[e],{isSendImmediately:!0})},r.prototype.reconnect=function(){this._workerHelper.callFunction("reconnect")},r.prototype.alignParamsToTilesAndLevel=function(e){return s.alignParamsToTilesAndLevel(e,this)},r.prototype._imageOpened=function(e){this._internalSizesParams=e.sizesParams,this._tileWidth=e.applicativeTileWidth,this._tileHeight=e.applicativeTileHeight,this._validateSizesCalculator()},r.prototype._getSizesParamsInternal=function(){return this._internalSizesParams}},{"createimagedecoderonslaveside.js":14,"imagehelperfunctions.js":12,"imageparamsretrieverproxy.js":15,"sendimageparameterstomaster.js":16}],19:[function(e,t,i){"use strict";function r(e){this._options=e||{},this._imageImplementation=a.getImageImplementation(e.imageImplementationClassName);var t=(this._options.scriptsToImport||[]).concat([o]),i=[this._options];this._workerHelper=new AsyncProxy.AsyncProxyMaster(t,"ArbitraryClassName",i)}function s(){AsyncProxy.AsyncProxySlave.setSlaveSideCreator(function(e){var t=imageDecoderFramework.Internals.imageHelperFunctions.getImageImplementation(e.imageImplementationClassName);return t.createPixelsDecoder()})}t.exports=r;var a=e("imagehelperfunctions.js"),n=new Blob(["(",s.toString(),")()"],{type:"application/javascript"}),o=URL.createObjectURL(n);r.prototype.decode=function(e){var t=[["data","buffer"]],i=[e],r={pathsToTransferablesInPromiseResult:t,isReturnPromise:!0};return this._workerHelper.callFunction("decode",i,r)},r.prototype.terminate=function(){this._workerHelper.terminate()}},{"imagehelperfunctions.js":12}],20:[function(e,t,i){"use strict";function r(e,t,i){this._imageImplementationClassName=e,this._canvasUpdatedCallback=t,this._adaptProportions=i.adaptProportions,this._cartographicBounds=i.cartographicBounds,this._isMainImageOnUi=i.isMainImageOnUi,this._showLog=i.showLog,this._allowMultipleChannelsInSession=i.allowMultipleChannelsInSession,this._minFunctionCallIntervalMilliseconds=i.minFunctionCallIntervalMilliseconds,this._overviewResolutionX=i.overviewResolutionX||100,this._overviewResolutionY=i.overviewResolutionY||100,this._workersLimit=i.workersLimit,this._lastRequestIndex=0,this._pendingUpdateViewArea=null,this._regions=[],this._targetCanvas=null,this._callPendingCallbacksBound=this._callPendingCallbacks.bind(this),this._createdChannelBound=this._createdChannel.bind(this),this._pendingCallbacksIntervalHandle=0,this._pendingCallbackCalls=[],this._canShowDynamicRegion=!1,void 0===this._cartographicBounds&&(this._cartographicBounds={west:-175,east:175,south:-85,north:85}),void 0===this._adaptProportions&&(this._adaptProportions=!0);var r=this._isMainImageOnUi?s:a;this._image=new r(e,{serverRequestPrioritizer:"frustumOnly",decodePrioritizer:"frustumOnly",showLog:this._showLog,workersLimit:this._workersLimit})}t.exports=r;var s=e("imagedecoder.js"),a=e("workerproxyimagedecoder.js"),n=e("imagehelperfunctions.js"),o=1,h=2,l=0,c=1;r.prototype.setExceptionCallback=function(e){this._exceptionCallback=e},r.prototype.open=function(e){return this._image.open(e).then(this._opened.bind(this))["catch"](this._exceptionCallback)},r.prototype.close=function(){var e=this._image.close();return e["catch"](this._exceptionCallback),this._isReady=!1,this._canShowDynamicRegion=!1,this._targetCanvas=null,e},r.prototype.setTargetCanvas=function(e){this._targetCanvas=e},r.prototype.updateViewArea=function(e){if(null===this._targetCanvas)throw"Cannot update dynamic region before setTargetCanvas()";if(!this._canShowDynamicRegion)return void(this._pendingUpdateViewArea=e);var t=e.rectangle,i=e.screenSize,r={minX:t.west*this._scaleX+this._translateX,minY:t.north*this._scaleY+this._translateY,maxXExclusive:t.east*this._scaleX+this._translateX,maxYExclusive:t.south*this._scaleY+this._translateY,screenWidth:i.x,screenHeight:i.y},s=n.alignParamsToTilesAndLevel(r,this._image),a=null===s;if(!a){s.imagePartParams.quality=this._quality;var o=void 0!==this._dynamicFetchParams&&this._isImagePartsEqual(s.imagePartParams,this._dynamicFetchParams.imagePartParams);if(!o){e.imageRectangle=this._cartographicBoundsFixed,e.exactlevel=s.imagePartParams.level,this._image.setDecodePrioritizerData(e),this._image.setServerRequestPrioritizerData(e),this._dynamicFetchParams=s;var h=!1,l=!this._allowMultipleChannelsInSession;this._fetch(c,s,h,l)}}},r.prototype.getBounds=function(){if(!this._isReady)throw"ViewerImageDecoder error: Image is not ready yet";return this._cartographicBoundsFixed},r.prototype._isImagePartsEqual=function(e,t){var i=void 0!==this._dynamicFetchParams&&e.minX===t.minX&&e.minY===t.minY&&e.maxXExclusive===t.maxXExclusive&&e.maxYExclusive===t.maxYExclusive&&e.level===t.level;return i},r.prototype._fetch=function(e,t,i,r){function s(i){P._tilesDecodedCallback(e,t,f,i)}function a(r){r&&o.requestPriorityData.overrideHighestPriority&&P._image.requestPixelsProgressive(t.imagePartParams,s,a,h),P._fetchTerminatedCallback(e,t.imagePartParams.requestPriorityData,r,i)}var n=++this._lastRequestIndex,o=t.imagePartParams;o.requestPriorityData=o.requestPriorityData||{},o.requestPriorityData.requestIndex=n;var h,c=t.positionInImage.minX,u=t.positionInImage.minY,_=t.positionInImage.maxXExclusive,d=t.positionInImage.maxYExclusive,m=(c-this._translateX)/this._scaleX,p=(_-this._translateX)/this._scaleX,g=(u-this._translateY)/this._scaleY,v=(d-this._translateY)/this._scaleY,f={west:m,east:p,north:g,south:v},y=!1,T=this._regions[e];if(void 0!==T){var C=o.level,E=T.imagePartParams.level;if(y=C===E,y&&T.donePartParams&&(h=[T.donePartParams]),e!==l){var b=this._checkIfRepositionNeeded(T,o,f);b&&this._notifyNewPendingCalls()}}var P=this,S=r?this._channelHandle:void 0;this._image.requestPixelsProgressive(t.imagePartParams,s,a,h,S)},r.prototype._fetchTerminatedCallback=function(e,t,i,r){var s=this._regions[e];void 0!==s&&(t.overrideHighestPriority||t.requestIndex===this._lastRequestIndex)&&(s.isDone=!i&&this._isReady,s.isDone&&(s.donePartParams=s.imagePartParams),r&&this._image.createChannel(this._createdChannelBound))},r.prototype._createdChannel=function(e){this._channelHandle=e,this._startShowingDynamicRegion()},r.prototype._startShowingDynamicRegion=function(){this._canShowDynamicRegion=!0,null!==this._pendingUpdateViewArea&&(this.updateViewArea(this._pendingUpdateViewArea),this._pendingUpdateViewArea=null)},r.prototype._tilesDecodedCallback=function(e,t,i,r){if(this._isReady){var s=this._regions[e];if(void 0===s)switch(s={},this._regions[e]=s,e){case c:s.canvas=this._targetCanvas;break;case l:s.canvas=document.createElement("canvas");break;default:throw"Unexpected regionId "+e}var a=t.imagePartParams;!a.requestPriorityData.overrideHighestPriority&&a.requestPriorityData.requestIndex<s.currentDisplayRequestIndex||(this._checkIfRepositionNeeded(s,a,i),this._pendingCallbackCalls.push({type:o,region:s,decoded:r}),this._notifyNewPendingCalls())}},r.prototype._checkIfRepositionNeeded=function(e,t,i){var r=e.imagePartParams,s=e.donePartParams,a=t.level,n=void 0===r||r.minX!==t.minX||r.minY!==t.minY||r.maxXExclusive!==t.maxXExclusive||r.maxYExclusive!==t.maxYExclusive||r.level!==a;if(!n)return!1;var o,l,c,u,_,d=!1;void 0!==r&&(u=this._image.getLevelWidth(a)/this._image.getLevelWidth(r.level),_=this._image.getLevelHeight(a)/this._image.getLevelHeight(r.level),l={minX:Math.max(r.minX*u,t.minX),minY:Math.max(r.minY*_,t.minY),maxX:Math.min(r.maxXExclusive*u,t.maxXExclusive),maxY:Math.min(r.maxYExclusive*_,t.maxYExclusive)},d=l.maxX>l.minX&&l.maxY>l.minY),d&&(o={fromX:l.minX/u-r.minX,fromY:l.minY/_-r.minY,fromWidth:(l.maxX-l.minX)/u,fromHeight:(l.maxY-l.minY)/_,toX:l.minX-t.minX,toY:l.minY-t.minY,toWidth:l.maxX-l.minX,toHeight:l.maxY-l.minY},s&&r.level===a&&(c={minX:Math.max(s.minX,t.minX),minY:Math.max(s.minY,t.minY),maxXExclusive:Math.min(s.maxXExclusive,t.maxXExclusive),maxYExclusive:Math.min(s.maxYExclusive,t.maxYExclusive)})),e.imagePartParams=t,e.isDone=!1,e.currentDisplayRequestIndex=t.requestPriorityData.requestIndex;var m={type:h,region:e,position:i,donePartParams:c,copyData:o,pixelsWidth:t.maxXExclusive-t.minX,pixelsHeight:t.maxYExclusive-t.minY};return this._pendingCallbackCalls.push(m),!0},r.prototype._notifyNewPendingCalls=function(){this._isNearCallbackCalled||this._callPendingCallbacks()},r.prototype._callPendingCallbacks=function(){if(0===this._pendingCallbackCalls.length||!this._isReady)return void(this._isNearCallbackCalled=!1);this._isNearCallbackCalled&&clearTimeout(this._pendingCallbacksIntervalHandle),void 0!==this._minFunctionCallIntervalMilliseconds&&(this._pendingCallbacksIntervalHandle=setTimeout(this._callPendingCallbacksBound,this._minFunctionCallIntervalMilliseconds),this._isNearCallbackCalled=!0);for(var e=null,t=0;t<this._pendingCallbackCalls.length;++t){var i=this._pendingCallbackCalls[t];if(i.type===h)this._repositionCanvas(i),e=i.position;else{if(i.type!==o)throw"Internal ViewerImageDecoder Error: Unexpected call type "+i.type;this._pixelsUpdated(i)}}this._pendingCallbackCalls.length=0,this._canvasUpdatedCallback(e)},r.prototype._pixelsUpdated=function(e){var t=e.region,i=e.decoded;if(0!==i.imageData.width&&0!==i.imageData.height){var r=i.xInOriginalRequest,s=i.yInOriginalRequest,a=t.canvas.getContext("2d");a.putImageData(i.imageData,r,s)}},r.prototype._repositionCanvas=function(e){var t,i=e.region,r=e.position,s=e.donePartParams,a=e.copyData,n=e.pixelsWidth,o=e.pixelsHeight,h=i.canvas.getContext("2d");void 0!==a&&(a.fromWidth===a.toWidth&&a.fromHeight===a.toHeight?t=h.getImageData(a.fromX,a.fromY,a.fromWidth,a.fromHeight):(this._tmpCanvas||(this._tmpCanvas=document.createElement("canvas"),this._tmpCanvasContext=this._tmpCanvas.getContext("2d")),this._tmpCanvas.width=a.toWidth,this._tmpCanvas.height=a.toHeight,this._tmpCanvasContext.drawImage(i.canvas,a.fromX,a.fromY,a.fromWidth,a.fromHeight,0,0,a.toWidth,a.toHeight),t=this._tmpCanvasContext.getImageData(0,0,a.toWidth,a.toHeight))),i.canvas.width=n,i.canvas.height=o,i!==this._regions[l]&&this._copyOverviewToCanvas(h,r,n,o),void 0!==a&&h.putImageData(t,a.toX,a.toY),i.position=r,i.donePartParams=s},r.prototype._copyOverviewToCanvas=function(e,t,i,r){var s=this._regions[l].position,a=this._regions[l].imagePartParams,n=a.maxXExclusive-a.minX,o=a.maxYExclusive-a.minY,h=s.east-s.west,c=s.north-s.south,u=n/h,_=o/c,d=t.east-t.west,m=t.north-t.south,p=d*u,g=m*_,v=t.west-s.west,f=s.north-t.north,y=v*u,T=f*_;e.drawImage(this._regions[l].canvas,y,T,p,g,0,0,i,r)},r.prototype._opened=function(){this._isReady=!0;var e={west:this._cartographicBounds.west,east:this._cartographicBounds.east,south:this._cartographicBounds.south,north:this._cartographicBounds.north};n.fixBounds(e,this._image,this._adaptProportions),this._cartographicBoundsFixed=e;var t=this._image.getImageLevel(),i=this._image.getLevelWidth(t),r=this._image.getLevelHeight(t);this._quality=this._image.getHighestQuality();var s=e.east-e.west,a=e.north-e.south;this._scaleX=i/s,this._scaleY=-r/a,this._translateX=-e.west*this._scaleX,this._translateY=-e.north*this._scaleY;var o={minX:0,minY:0,maxXExclusive:i,maxYExclusive:r,screenWidth:this._overviewResolutionX,screenHeight:this._overviewResolutionY},h=n.alignParamsToTilesAndLevel(o,this._image);h.imagePartParams.requestPriorityData=h.imagePartParams.requestPriorityData||{},h.imagePartParams.requestPriorityData.overrideHighestPriority=!0,h.imagePartParams.quality=this._image.getLowestQuality();var c=!this._allowMultipleChannelsInSession;this._fetch(l,h,c),this._allowMultipleChannelsInSession&&this._startShowingDynamicRegion()}},{"imagedecoder.js":5,"imagehelperfunctions.js":12,"workerproxyimagedecoder.js":18}],21:[function(e,t,i){"use strict";t.exports.ViewerImageDecoder=e("viewerimagedecoder.js"),t.exports.ImageDecoder=e("imagedecoder.js"),t.exports.SimpleFetcher=e("simplefetcher.js"),t.exports.SimplePixelsDecoderBase=e("simplepixelsdecoderbase.js"),t.exports.CesiumImageDecoderLayerManager=e("_cesiumimagedecoderlayermanager.js"),t.exports.ImageDecoderImageryProvider=e("imagedecoderimageryprovider.js"),t.exports.ImageDecoderRegionLayer=e("imagedecoderregionlayer.js"),t.exports.Internals={FetchManager:e("fetchmanager.js"),imageHelperFunctions:e("imagehelperfunctions.js")}},{"_cesiumimagedecoderlayermanager.js":2,"fetchmanager.js":9,"imagedecoder.js":5,"imagedecoderimageryprovider.js":4,"imagedecoderregionlayer.js":22,"imagehelperfunctions.js":12,"simplefetcher.js":25,"simplepixelsdecoderbase.js":28,"viewerimagedecoder.js":20}],22:[function(e,t,i){"use strict";function r(){return{initialize:function(e){this._options=e||{},void 0!==this._options.latLngBounds&&(this._options=JSON.parse(JSON.stringify(e)),this._options.cartographicBounds={west:e.latLngBounds.getWest(),east:e.latLngBounds.getEast(),south:e.latLngBounds.getSouth(),north:e.latLngBounds.getNorth()
}),this._targetCanvas=null,this._canvasPosition=null,this._canvasUpdatedCallbackBound=this._canvasUpdatedCallback.bind(this),this._image=null,this._exceptionCallback=null},setExceptionCallback:function(e){this._exceptionCallback=e,null!==this._image&&this._image.setExceptionCallback(e)},_createImage:function(){null===this._image&&(this._image=new s(this._options.imageImplementationClassName,this._canvasUpdatedCallbackBound,this._options),null!==this._exceptionCallback&&this._image.setExceptionCallback(this._exceptionCallback),this._image.open(this._options.url)["catch"](this._exceptionCallback))},onAdd:function(e){if(void 0!==this._map)throw"Cannot add this layer to two maps";this._map=e,this._createImage(),this._targetCanvas=L.DomUtil.create("canvas","image-decoder-layer-canvas leaflet-zoom-animated"),this._image.setTargetCanvas(this._targetCanvas),this._canvasPosition=null,e.getPanes().mapPane.appendChild(this._targetCanvas),e.on("viewreset",this._moved,this),e.on("move",this._moved,this),L.Browser.any3d&&e.on("zoomanim",this._animateZoom,this),this._moved()},onRemove:function(e){if(e!==this._map)throw"Removed from wrong map";e.off("viewreset",this._moved,this),e.off("move",this._moved,this),e.off("zoomanim",this._animateZoom,this),e.getPanes().mapPane.removeChild(this._targetCanvas),this._targetCanvas=null,this._canvasPosition=null,this._map=void 0,this._image.close(),this._image=null},_moved:function(){this._moveCanvases();var e=a(this._map);this._image.updateViewArea(e)},_canvasUpdatedCallback:function(e){null!==e&&(this._canvasPosition=e,this._moveCanvases())},_moveCanvases:function(){if(null!==this._canvasPosition){var e=this._canvasPosition.west,t=this._canvasPosition.east,i=this._canvasPosition.south,r=this._canvasPosition.north,s=this._map.latLngToLayerPoint([r,e]),a=this._map.latLngToLayerPoint([i,t]),n=a.subtract(s);L.DomUtil.setPosition(this._targetCanvas,s),this._targetCanvas.style.width=n.x+"px",this._targetCanvas.style.height=n.y+"px"}},_animateZoom:function(e){if(null!==this._canvasPosition){var t=this._canvasPosition.west,i=this._canvasPosition.east,r=this._canvasPosition.south,s=this._canvasPosition.north,a=this._map._latLngToNewLayerPoint([s,t],e.zoom,e.center),n=this._map._latLngToNewLayerPoint([r,i],e.zoom,e.center),o=this._map.getZoomScale(e.zoom),h=n.subtract(a),l=h.multiplyBy(.5*(1-1/o)),c=a.add(l);this._targetCanvas.style[L.DomUtil.TRANSFORM]=L.DomUtil.getTranslateString(c)+" scale("+o+") "}}}}var s=e("viewerimagedecoder.js"),a=e("leafletfrustumcalculator.js");self.L?t.exports=L.Class.extend(r()):t.exports=function(){throw new Error("Cannot instantiate ImageDecoderRegionLayer: No Leaflet namespace in scope")}},{"leafletfrustumcalculator.js":23,"viewerimagedecoder.js":20}],23:[function(e,t,i){"use strict";var r=e("imagehelperfunctions.js");t.exports=function(e){var t=e.getSize(),i=e.getBounds(),s={west:i.getWest(),east:i.getEast(),south:i.getSouth(),north:i.getNorth()},a=r.calculateFrustum2DFromBounds(s,t);return a}},{"imagehelperfunctions.js":12}],24:[function(e,t,i){"use strict";function r(e){this._subscribersByKey=new a(e)}t.exports=r;var s=e("linkedlist.js"),a=e("hashmap.js");r.prototype.publish=function(e,t,i){var r=this._subscribersByKey.getFromKey(e);if(r){for(var s=r.subscribersList.getFirstIterator(),a=[];null!==s;){var n=r.subscribersList.getValue(s);n.isEnded||(a.push(n.listener),i&&(--r.subscribersNotEndedCount,n.isEnded=!0)),s=r.subscribersList.getNextIterator(s)}for(var o=0;o<a.length;++o)a[o].call(this,e,t,i)}},r.prototype.subscribe=function(e,t){var i=this._subscribersByKey.tryAdd(e,function(){return{subscribersList:new s,subscribersNotEndedCount:0}});++i.value.subscribersNotEndedCount;var r=i.value.subscribersList.add({listener:t,isEnded:!1}),a={_listIterator:r,_hashIterator:i.iterator};return a},r.prototype.unsubscribe=function(e){var t=this._subscribersByKey.getFromIterator(e._hashIterator),i=t.subscribersList.getValue(e._listIterator);t.subscribersList.remove(e._listIterator),0===t.subscribersList.getCount()?this._subscribersByKey.remove(e._hashIterator):i.isEnded||(--t.subscribersNotEndedCount,i.isEnded=!0)},r.prototype.isKeyNeedFetch=function(e){var t=this._subscribersByKey.getFromKey(e);return!!t&&t.subscribersNotEndedCount>0}},{"hashmap.js":11,"linkedlist.js":13}],25:[function(e,t,i){"use strict";function r(e,t){if(this._url=null,this._fetcherMethods=e,this._options=t||{},this._isReady=!0,!this._fetcherMethods.getDataKeys)throw"SimpleFetcher error: getDataKeys is not implemented";if(!this._fetcherMethods.fetch&&!this._fetcherMethods.fetchProgressive)throw"SimpleFetcher error: Neither fetch nor fetchProgressive methods are implemented";if(!this._fetcherMethods.getHashCode)throw"SimpleFetcher error: getHashCode is not implemented";if(!this._fetcherMethods.isEqual)throw"SimpleFetcher error: isEqual is not implemented";this._hasher={_fetcherMethods:this._fetcherMethods,getHashCode:function(e){return this._fetcherMethods.getHashCode(e)},isEqual:function(e,t){return e.maxQuality!==t.maxQuality?!1:this._fetcherMethods.isEqual(e.dataKey,t.dataKey)}},this._fetcherMethods.createDataPublisher?this._dataPublisher=this.fetcherMethods.createDataPublisher(this._hasher):this._dataPublisher=new n(this._hasher)}t.exports=r;var s=e("simpleimagedatacontext.js"),a=e("simplenonprogressivefetchhandle.js"),n=e("datapublisher.js");r.prototype.reconnect=function(){if(this._ensureReady(),!this._fetcherMethods.reconnect)throw"SimpleFetcher error: reconnect is not implemented";this._fetcherMethods.reconnect()},r.prototype.createImageDataContext=function(e){this._ensureReady();var t=this._fetcherMethods.getDataKeys(e);return new s(t,e,this._dataPublisher,this._hasher)},r.prototype.fetch=function(e){function t(e,t,i){var r={dataKey:e,maxQuality:n};o._dataPublisher.publish(r,t,i)}function i(e){var t={dataKey:e,maxQuality:n};return o._dataPublisher.isKeyNeedFetch(t)}this._ensureReady();var r=e.getImagePartParams(),s=e.getDataKeys(),n=e.getMaxQuality(),o=this;if(!this._fetcherMethods.fetchProgressive){var h=new a(this._fetcherMethods,t,i,this._options);return h.fetch(s),h}return this._fetcherMethods.fetchProgressive(r,s,t,i,n)},r.prototype.startMovableFetch=function(e,t){t.moveToImageDataContext=null,t.fetchHandle=this.fetch(e)},r.prototype.moveFetch=function(e,t){var i=!!t.moveToImageDataContext;if(t.moveToImageDataContext=e,!i){var r=this;t.fetchHandle.stopAsync().then(function(){var e=t.moveToImageDataContext;t.moveToImageDataContext=null,t.fetchHandle=r.fetch(e)})}},r.prototype.close=function(e){return this._ensureReady(),this._isReady=!1,new Promise(function(e,t){e()})},r.prototype._ensureReady=function(){if(!this._isReady)throw"SimpleFetcher error: fetch client is not opened"}},{"datapublisher.js":24,"simpleimagedatacontext.js":26,"simplenonprogressivefetchhandle.js":27}],26:[function(e,t,i){"use strict";function r(e,t,i,r){this._dataByKey=new s(r),this._dataToReturn={imagePartParams:JSON.parse(JSON.stringify(t)),fetchedItems:[]},this._maxQuality=t.quality,this._fetchEndedCount=0,this._fetchedLowQualityCount=0,this._dataListeners=[],this._dataKeys=e,this._imagePartParams=t,this._dataPublisher=i,this._isProgressive=!1,this._isDisposed=!1,this._subscribeHandles=[];for(var a=this._dataFetched.bind(this),n=0;n<e.length;++n){var o=this._dataPublisher.subscribe({dataKey:e[n],maxQuality:this._maxQuality},a);this._subscribeHandles.push(o)}}t.exports=r;var s=e("hashmap.js");r.prototype.getMaxQuality=function(){return this._maxQuality},r.prototype.getDataKeys=function(){return this._dataKeys},r.prototype.getImagePartParams=function(){return this._imagePartParams},r.prototype.hasData=function(){return this._fetchedLowQualityCount==this._dataKeys.length},r.prototype.getFetchedData=function(){if(!this.hasData())throw"SimpleImageDataContext error: cannot call getFetchedData before hasData = true";return this._dataToReturn},r.prototype.on=function(e,t){if(this._isDisposed)throw"Cannot register to event on disposed ImageDataContext";if("data"!==e)throw"SimpleImageDataContext error: Unexpected event "+e;this._dataListeners.push(t)},r.prototype.isDone=function(){return this._fetchEndedCount===this._dataKeys.length},r.prototype.dispose=function(){this._isDisposed=!0;for(var e=0;e<this._subscribeHandles.length;++e)this._dataPublisher.unsubscribe(this._subscribeHandles[e]);this._subscribeHandles=[],this._dataListeners=[]},r.prototype.setIsProgressive=function(e){var t=this._isProgressive;if(this._isProgressive=e,!t&&e&&this.hasData())for(var i=0;i<this._dataListeners.length;++i)this._dataListeners[i](this)},r.prototype._dataFetched=function(e,t,i){if(this._isDisposed)throw"Unexpected dataFetched listener call on disposed ImageDataContext";var r=this,s=this._dataByKey.tryAdd(e,function(){return r._dataToReturn.fetchedItems.push({key:e.dataKey,data:t}),++r._fetchedLowQualityCount,{fetchEnded:!1,fetchedItemsOffset:r._dataToReturn.fetchedItems.length-1}});if(!s.value.fetchEnded&&(this._dataToReturn.fetchedItems[s.value.fetchedItemsOffset].data=t,i&&(s.value.fetchEnded=!0,++this._fetchEndedCount),this.isDone()||this.hasData()&&this._isProgressive))for(var a=0;a<this._dataListeners.length;++a)this._dataListeners[a](this)}},{"hashmap.js":11}],27:[function(e,t,i){"use strict";function r(e,t,i,r){this._fetchMethods=e,this._dataCallback=t,this._queryIsKeyNeedFetch=i,this._fetchLimit=(r||{}).fetchLimitPerFetcher||2,this._keysToFetch=null,this._nextKeyToFetch=0,this._activeFetches={},this._activeFetchesCount=0,this._resolveStop=null}t.exports=r,r.prototype.fetch=function(e){if(null!==this._keysToFetch)throw"SimpleNonProgressiveFetchHandle error: Request fetcher can fetch only one region";for(this._keysToFetch=e,this._nextKeyToFetch=0;this._activeFetchesCount<this._fetchLimit&&this._fetchSingleKey(););},r.prototype.stopAsync=function(){var e=this;return new Promise(function(t,i){0===e._activeFetchesCount?t():this._resolveStop=t})},r.prototype.resume=function(){if(this._resolveStop)return void(this._resolveStop=null);if(this._activeFetchesCount>0)throw"SimpleNonProgressiveFetchHandle error: cannot resume() while already fetching";for(;this._activeFetchesCount<this._fetchLimit&&this._fetchSingleKey(););},r.prototype._fetchSingleKey=function(){var e;do{if(this._nextKeyToFetch>=this._keysToFetch.length)return!1;e=this._keysToFetch[this._nextKeyToFetch++]}while(!this._queryIsKeyNeedFetch(e));var t=this;return this._activeFetches[e]=!0,++this._activeFetchesCount,this._fetchMethods.fetch(e).then(function(i){t._dataCallback(e,i,!0),t._fetchEnded(null,e,i)})["catch"](function(i){t._fetchEnded(i,e)}),!0},r.prototype._fetchEnded=function(e,t,i){delete this._activeFetches[t],--this._activeFetchesCount,this._resolveStop?0===this._activeFetchesCount&&(this._resolveStop(),this._resolveStop=null):this._fetchSingleKey()}},{}],28:[function(e,t,i){"use strict";function r(){r.prototype.decode=function(e){for(var t=e.imagePartParams,i=t.maxXExclusive-t.minX,r=t.maxYExclusive-t.minY,s=new ImageData(i,r),a=[],n=0;n<e.fetchedItems.length;++n)a.push(this.decodeRegion(s,t.minX,t.minY,e.fetchedItems[n].key,e.fetchedItems[n].data));return Promise.all(a).then(function(){return s})},r.prototype.decodeRegion=function(e,t,i,r){throw"SimplePixelsDecoderBase error: decodeRegion is not implemented"}}t.exports=r},{}]},{},[21])(21)});